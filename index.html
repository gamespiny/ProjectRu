<!DOCTYPE html>
<!--
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  ConsoleFlip ‚Äî –ù–ê–°–¢–†–û–ô–ö–ê GOOGLE DRIVE –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò             ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë                                                                  ‚ïë
‚ïë  –ë–ï–ó –ù–ê–°–¢–†–û–ô–ö–ò: —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ (localStorage), –±–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∞  ‚ïë
‚ïë                                                                  ‚ïë
‚ïë  –î–õ–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò ‚Äî –ø–æ–ª—É—á–∏ –∫–ª—é—á–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ:                    ‚ïë
‚ïë                                                                  ‚ïë
‚ïë  1. –ó–∞–π–¥–∏ –Ω–∞ https://console.cloud.google.com                   ‚ïë
‚ïë  2. –°–æ–∑–¥–∞–π –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç (–∏–ª–∏ –≤—ã–±–µ—Ä–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π)               ‚ïë
‚ïë  3. APIs & Services ‚Üí Enable APIs ‚Üí –≤–∫–ª—é—á–∏ "Google Drive API"   ‚ïë
‚ïë  4. APIs & Services ‚Üí Credentials ‚Üí Create credentials:         ‚ïë
‚ïë     a) "OAuth 2.0 Client ID" ‚Üí Web application                  ‚ïë
‚ïë        Authorised JS origins: –¥–æ–±–∞–≤—å –∞–¥—Ä–µ—Å –≥–¥–µ –±—É–¥–µ—Ç —Ñ–∞–π–ª       ‚ïë
‚ïë        (–Ω–∞–ø—Ä–∏–º–µ—Ä: http://localhost –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞)       ‚ïë
‚ïë        –°–∫–æ–ø–∏—Ä—É–π CLIENT_ID                                        ‚ïë
‚ïë     b) "API key" ‚Üí —Å–∫–æ–ø–∏—Ä—É–π API_KEY                             ‚ïë
‚ïë  5. OAuth consent screen ‚Üí –¥–æ–±–∞–≤—å —Å–≤–æ–π email –∫–∞–∫ Test user      ‚ïë
‚ïë  6. –ù–∞–π–¥–∏ –≤ –∫–æ–¥–µ –Ω–∏–∂–µ —Å—Ç—Ä–æ–∫–∏:                                    ‚ïë
‚ïë     CLIENT_ID: '%%GOOGLE_CLIENT_ID%%'                           ‚ïë
‚ïë     API_KEY:   '%%GOOGLE_API_KEY%%'                             ‚ïë
‚ïë     –ò –∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–∏ –∫–ª—é—á–∏                                       ‚ïë
‚ïë                                                                  ‚ïë
‚ïë  –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ: –æ—Ç–∫—Ä–æ–π —Ñ–∞–π–ª ‚Üí –Ω–∞–∂–º–∏ "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google" ‚Üí        ‚ïë
‚ïë  –¥–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –º–µ–∂–¥—É –≤—Å–µ–º–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏  ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ConsoleFlip</title>
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0d0f14;--surf:#151820;--surf2:#1c2030;--surf3:#232840;
  --border:#252d45;--border2:#2e3a5a;
  --accent:#4fffb0;--a2:#ff4f8b;--a3:#4fb8ff;--warn:#ffd84f;
  --text:#e8eaf6;--t2:#8892b0;--t3:#4a5278;
  --red:#ff4f6e;
  --mono:'Space Mono',monospace;--sans:'Manrope',sans-serif;
  --r:10px;--r2:16px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body,#root{min-height:100%;font-size:16px}
body{background:var(--bg);color:var(--text);font-family:var(--sans);overflow-x:hidden}
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:var(--surf2)}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
.app{max-width:960px;margin:0 auto;padding:0 14px 90px}
/* header */
.hdr{display:flex;align-items:center;justify-content:space-between;padding:18px 0 16px;border-bottom:1px solid var(--border);margin-bottom:18px}
.logo{display:flex;align-items:center;gap:9px}
.logo-box{width:32px;height:32px;background:linear-gradient(135deg,var(--accent),var(--a3));border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.logo-name{font-family:var(--mono);font-size:.95rem;font-weight:700;color:var(--text)}
.logo-name span{color:var(--accent)}
/* stats */
.sbar{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:18px}
.sc{background:var(--surf);border:1px solid var(--border);border-radius:var(--r2);padding:12px 14px;position:relative;overflow:hidden}
.sc::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.sc.g::before{background:linear-gradient(90deg,var(--accent),transparent)}
.sc.b::before{background:linear-gradient(90deg,var(--a3),transparent)}
.sc.w::before{background:linear-gradient(90deg,var(--warn),transparent)}
.sc.r::before{background:linear-gradient(90deg,var(--a2),transparent)}
.sc-lbl{font-size:.62rem;color:var(--t3);text-transform:uppercase;letter-spacing:.9px;font-weight:700;margin-bottom:6px}
.sc-val{font-family:var(--mono);font-size:1.15rem;font-weight:700;line-height:1}
.sc-val.g{color:var(--accent)}.sc-val.b{color:var(--a3)}.sc-val.w{color:var(--warn)}.sc-val.r{color:var(--a2)}
.sc-sub{font-size:.65rem;color:var(--t3);margin-top:4px}
/* tabs */
.tabs{display:flex;gap:3px;background:var(--surf);padding:3px;border-radius:var(--r);border:1px solid var(--border);margin-bottom:18px}
.tab{flex:1;padding:8px 6px;border:none;background:transparent;color:var(--t2);font-family:var(--sans);font-size:.78rem;font-weight:700;cursor:pointer;border-radius:7px;transition:all .15s;white-space:nowrap}
.tab.on{background:var(--surf3);color:var(--text)}
.tab:hover:not(.on){color:var(--text)}
/* lot cards */
.lot-card{background:var(--surf);border:1px solid var(--border);border-radius:var(--r2);overflow:hidden;margin-bottom:8px;transition:border-color .2s}
.lot-card:hover{border-color:var(--border2)}
.lot-card.st-partial{border-left:3px solid var(--warn)}
.lot-card.st-sold{border-left:3px solid #2d6b48}
.lot-head{display:flex;align-items:center;gap:10px;padding:13px 16px;cursor:pointer;user-select:none}
.lot-badge{font-family:var(--mono);font-size:.65rem;background:var(--surf3);color:var(--t3);padding:2px 7px;border-radius:5px;flex-shrink:0}
.lot-info{flex:1;min-width:0}
.lot-name{font-weight:800;font-size:.88rem;line-height:1.3;color:var(--text)}
.lot-sub{display:flex;align-items:center;gap:6px;margin-top:4px;flex-wrap:wrap}
.tag{display:inline-flex;align-items:center;font-size:.63rem;font-weight:700;padding:2px 7px;border-radius:20px}
.tc{background:rgba(255,216,79,.1);color:var(--warn)}
.tk{background:rgba(79,184,255,.1);color:var(--a3)}
.ts{background:rgba(79,255,176,.08);color:var(--t2)}
.ta{background:rgba(79,184,255,.12);color:var(--a3)}
.td{font-size:.63rem;color:var(--t3);font-family:var(--mono)}
.lot-right{display:flex;align-items:center;gap:8px;flex-shrink:0}
.lot-nums{text-align:right}
.lot-cost{font-family:var(--mono);font-size:.88rem;font-weight:700;color:var(--text)}
.lot-pnl{font-family:var(--mono);font-size:.7rem;margin-top:2px}
.lot-pnl.pos{color:var(--accent)}.lot-pnl.neg{color:var(--a2)}.lot-pnl.zero{color:var(--t3)}
.pill{font-size:.62rem;font-weight:800;text-transform:uppercase;letter-spacing:.5px;padding:3px 8px;border-radius:20px;white-space:nowrap}
.p-active{background:rgba(79,255,176,.1);color:var(--accent)}
.p-partial{background:rgba(255,216,79,.1);color:var(--warn)}
.p-sold{background:rgba(79,255,176,.06);color:#2d6b48}
.p-parts{background:rgba(255,79,110,.08);color:var(--red)}
.chev{color:var(--t3);font-size:.9rem;transition:transform .2s;flex-shrink:0}
.chev.open{transform:rotate(180deg)}
/* lot body */
.lot-body{border-top:1px solid var(--border)}
.prog-wrap{padding:10px 16px 0}
.prog-labels{display:flex;justify-content:space-between;margin-bottom:5px}
.prog-labels span{font-size:.68rem;font-family:var(--mono);color:var(--t3)}
.prog-pct{font-weight:700}.prog-pct.done{color:var(--accent)}.prog-pct.mid{color:var(--warn)}
.prog-track{height:3px;background:var(--surf3);border-radius:2px;overflow:hidden}
.prog-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--a3),var(--accent));transition:width .4s}
.prog-fill.done{background:var(--accent)}
.blk{padding:10px 16px}
.blk-hdr{font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);margin-bottom:8px;display:flex;align-items:center;justify-content:space-between}
.divider{height:1px;background:var(--border)}
/* cart rows */
.cart-row{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--border)}
.cart-row:last-child{border-bottom:none}
.cart-name{flex:1;font-size:.82rem;color:var(--t2)}
.cart-box-badge{font-size:.65rem;color:var(--t3);padding:1px 6px;border-radius:4px;background:var(--surf2);white-space:nowrap}
.cart-sold-badge{font-size:.65rem;color:var(--accent);background:rgba(79,255,176,.1);padding:1px 6px;border-radius:4px}
/* sale rows */
.sale-row{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)}
.sale-row:last-child{border-bottom:none}
.sale-info{flex:1;min-width:0}
.sale-item{font-size:.82rem;font-weight:600;color:var(--text)}
.sale-meta{display:flex;gap:5px;align-items:center;margin-top:2px;flex-wrap:wrap}
.sale-date{font-size:.65rem;color:var(--t3);font-family:var(--mono)}
.sale-plat{font-size:.63rem;color:var(--a3);background:rgba(79,184,255,.1);padding:1px 6px;border-radius:10px;font-weight:600}
.sale-meth{font-size:.63rem;color:var(--t3)}
.sale-amt{font-family:var(--mono);font-weight:700;font-size:.88rem;color:var(--accent);white-space:nowrap}
.lot-acts{display:flex;gap:7px;padding:10px 16px;border-top:1px solid var(--border);flex-wrap:wrap}
.lot-notes-txt{font-size:.78rem;color:var(--t2);line-height:1.55;padding:8px 16px 10px;font-style:italic}
/* buttons */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:var(--r);border:none;font-family:var(--sans);font-size:.8rem;font-weight:700;cursor:pointer;transition:all .15s;user-select:none;line-height:1}
.btn-a{background:var(--accent);color:#0d0f14}.btn-a:hover{background:#6fffbf}
.btn-g{background:transparent;color:var(--t2);border:1px solid var(--border)}.btn-g:hover{border-color:var(--a3);color:var(--a3)}
.btn-d{background:rgba(255,79,110,.12);color:var(--red);border:1px solid rgba(255,79,110,.2)}.btn-d:hover{background:rgba(255,79,110,.22)}
.btn-w{background:rgba(255,216,79,.1);color:var(--warn);border:1px solid rgba(255,216,79,.2)}.btn-w:hover{background:rgba(255,216,79,.2)}
.btn-sm{padding:5px 11px;font-size:.75rem}
.btn-xs{padding:3px 8px;font-size:.7rem;border-radius:7px}
.sec-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px}
.sec-title{font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--t2)}
.sec-cnt{font-family:var(--mono);font-size:.7rem;color:var(--t3);background:var(--surf2);padding:2px 8px;border-radius:20px}
.filter-row{display:flex;gap:7px;align-items:center;flex-wrap:wrap}
.sel-sm{background:var(--surf);border:1px solid var(--border);border-radius:8px;padding:5px 26px 5px 9px;color:var(--t2);font-size:.75rem;font-family:var(--sans);outline:none;cursor:pointer;-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%238892b0' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center}
.sel-sm option{background:var(--surf2)}
.empty{text-align:center;padding:50px 20px;color:var(--t3)}
.empty-icon{font-size:2.5rem;margin-bottom:10px;opacity:.4}
.empty-txt{font-size:.85rem}
/* overlay */
.ov{position:fixed;inset:0;background:rgba(0,0,0,.82);backdrop-filter:blur(8px);z-index:200;display:flex;align-items:flex-start;justify-content:center;padding:14px;overflow-y:auto}
.modal{background:var(--surf);border:1px solid var(--border2);border-radius:var(--r2);width:100%;max-width:520px;margin:auto;animation:mIn .18s ease}
@keyframes mIn{from{opacity:0;transform:translateY(10px) scale(.97)}to{opacity:1;transform:none}}
.modal-hdr{display:flex;align-items:center;justify-content:space-between;padding:18px 20px 0}
.modal-title{font-weight:800;font-size:1rem;color:var(--text)}
.modal-x{background:none;border:none;color:var(--t2);font-size:1.3rem;cursor:pointer;padding:2px 6px;border-radius:6px;line-height:1}
.modal-x:hover{color:var(--text);background:var(--surf2)}
.modal-body{padding:18px 20px}
.modal-footer{padding:12px 20px;display:flex;gap:8px;justify-content:flex-end;border-top:1px solid var(--border)}
/* forms */
.fr{margin-bottom:14px}
.fr label{display:block;font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--t2);margin-bottom:6px}
.fr input,.fr select,.fr textarea{width:100%;padding:9px 12px;background:var(--surf2);border:1px solid var(--border);border-radius:var(--r);color:var(--text);font-family:var(--sans);font-size:.85rem;outline:none;transition:border-color .15s;-webkit-appearance:none;appearance:none}
.fr input:focus,.fr select:focus,.fr textarea:focus{border-color:var(--accent)}
.fr select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%238892b0' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 11px center;padding-right:30px}
.fr select option{background:var(--surf2)}
.fr textarea{resize:vertical;min-height:60px}
.fr-hint{font-size:.7rem;color:var(--t3);margin-top:4px}
.fr-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.fr-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
@media(max-width:420px){.fr-2,.fr-3{grid-template-columns:1fr}}
.check-row{display:flex;align-items:center;gap:8px;cursor:pointer;padding:4px 0}
.check-row input[type=checkbox]{width:15px;height:15px;accent-color:var(--accent);cursor:pointer;flex-shrink:0}
.check-row span{font-size:.82rem;color:var(--t2)}
/* item editor (carts/accs) */
.item-ed{border:1px solid var(--border);border-radius:var(--r);overflow:hidden;margin-top:6px}
.item-ed-list{max-height:155px;overflow-y:auto}
.item-ed-row{display:flex;align-items:center;gap:8px;padding:7px 11px;border-bottom:1px solid var(--border)}
.item-ed-row:last-child{border-bottom:none}
.item-ed-name{flex:1;font-size:.8rem;color:var(--t2)}
.item-ed-badge{font-size:.65rem;color:var(--t3);background:var(--surf2);padding:1px 6px;border-radius:4px;white-space:nowrap}
.item-ed-del{background:none;border:none;color:var(--t3);cursor:pointer;padding:2px 5px;border-radius:5px;font-size:.9rem;line-height:1;flex-shrink:0}
.item-ed-del:hover{color:var(--red);background:rgba(255,79,110,.1)}
.item-add-area{padding:8px 10px;background:var(--surf2);display:flex;flex-direction:column;gap:7px}
.item-add-row{display:flex;gap:7px}
.item-add-row input{flex:1;padding:6px 10px;background:var(--surf3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--sans);font-size:.82rem;outline:none;min-width:0}
.item-add-row input:focus{border-color:var(--accent)}
.item-add-btn{background:var(--surf3);border:1px solid var(--border);color:var(--accent);border-radius:8px;padding:6px 12px;cursor:pointer;font-size:1rem;transition:all .15s;flex-shrink:0}
.item-add-btn:hover{background:rgba(79,255,176,.1)}
.inline-sell{background:var(--surf2);border:1px solid var(--border);border-radius:8px;padding:10px;margin-top:5px;display:flex;flex-direction:column;gap:8px}
.is-row{display:flex;gap:7px}
.is-row input,.is-row select{flex:1;padding:6px 10px;background:var(--surf3);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:var(--sans);font-size:.82rem;outline:none;min-width:0;-webkit-appearance:none;appearance:none}
.is-row input:focus,.is-row select:focus{border-color:var(--accent)}
/* stats */
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
@media(max-width:500px){.stat-grid{grid-template-columns:1fr}}
.stat-blk{background:var(--surf);border:1px solid var(--border);border-radius:var(--r2);padding:15px}
.stat-blk-title{font-size:.67rem;font-weight:700;text-transform:uppercase;letter-spacing:.9px;color:var(--t3);margin-bottom:12px}
.stat-line{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border)}
.stat-line:last-child{border-bottom:none}
.stat-ln-lbl{font-size:.8rem;color:var(--t2)}
.stat-ln-val{font-family:var(--mono);font-weight:700;font-size:.85rem}
.month-chart{background:var(--surf);border:1px solid var(--border);border-radius:var(--r2);padding:15px;margin-bottom:14px}
.month-title{font-size:.67rem;font-weight:700;text-transform:uppercase;letter-spacing:.9px;color:var(--t3);margin-bottom:14px}
.month-bars{display:flex;align-items:flex-end;gap:5px;height:80px}
.month-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;height:100%;justify-content:flex-end}
.month-bar{width:100%;border-radius:3px 3px 0 0;background:linear-gradient(180deg,var(--a3),rgba(79,184,255,.25));min-height:2px}
.month-lbl{font-size:.58rem;color:var(--t3);font-family:var(--mono)}
.month-val{font-size:.58rem;color:var(--t3);font-family:var(--mono)}
.open-lot-row{display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid var(--border)}
.open-lot-row:last-child{border-bottom:none}
.open-lot-name{flex:1;font-size:.8rem;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text)}
.open-lot-remains{font-family:var(--mono);font-size:.75rem;color:var(--t3);white-space:nowrap}
.open-bar{width:50px;height:3px;background:var(--surf3);border-radius:2px;overflow:hidden;flex-shrink:0}
.open-fill{height:100%;background:var(--warn);border-radius:2px}
/* history */
.hist-card{background:var(--surf);border:1px solid var(--border);border-radius:var(--r2);padding:12px 15px;display:flex;align-items:center;gap:10px;margin-bottom:7px;cursor:pointer;transition:border-color .15s}
.hist-card:hover{border-color:var(--a3)}
.hist-icon{width:30px;height:30px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:13px;background:rgba(79,255,176,.08);flex-shrink:0}
.hist-info{flex:1;min-width:0}
.hist-name{font-size:.85rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--text)}
.hist-sub{font-size:.7rem;color:var(--t3);margin-top:2px}
.hist-amt{font-family:var(--mono);font-weight:700;font-size:.9rem;color:var(--accent);white-space:nowrap}
/* accs tab */
.acc-tab-row{display:flex;align-items:center;gap:10px;padding:9px 15px;border-bottom:1px solid var(--border)}
.acc-tab-row:last-child{border-bottom:none}
.acc-tab-icon{font-size:1rem;flex-shrink:0}
.acc-tab-info{flex:1;min-width:0}
.acc-tab-name{font-size:.83rem;font-weight:600;color:var(--text)}
.acc-tab-sub{font-size:.7rem;color:var(--t3);margin-top:2px}
.acc-tab-type{font-size:.72rem;color:var(--t3);white-space:nowrap}
@media(max-width:600px){
  .sbar{grid-template-columns:repeat(2,1fr)}
  .lot-badge{display:none}
  .lot-head{padding:11px 13px}
}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ó–ê–©–ò–¢–ê –î–û–°–¢–£–ü–ê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PASSWORD = '14129300231AbK3';
const enteredPassword = prompt('–í–≤–µ–¥–∏ –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞:');
if (enteredPassword !== PASSWORD) {
  document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;color:#ff4f6e;font-family:monospace;font-size:1.2rem;">‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω</div>';
  throw new Error('Unauthorized');
}

const {useState,useEffect,useMemo,useCallback}=React;

const CONSOLES=['Nintendo Switch OLED','Nintendo Switch Lite','Nintendo Switch Rev2'];
const COLORS={
  'Nintendo Switch OLED':['–ë–µ–ª—ã–π','–ù–µ–æ–Ω','Zelda Edition','Mario Edition','Pokemon Edition','–î—Ä—É–≥–æ–π'],
  'Nintendo Switch Lite':['–ë–∏—Ä—é–∑–æ–≤—ã–π','–°–∏–Ω–∏–π','–ñ—ë–ª—Ç—ã–π','–°–µ—Ä—ã–π','–ö–æ—Ä–∞–ª–ª–æ–≤—ã–π','–î—Ä—É–≥–æ–π'],
  'Nintendo Switch Rev2':['–ù–µ–æ–Ω','–°–µ—Ä—ã–π','Fortnite Edition','Diablo Edition','Mario Edition'],
};
const SOURCES=['–î–æ—Å—Ç–∞–≤–∫–∞','–õ–æ–º–±–∞—Ä–¥','–°–∞–º–æ–≤—ã–≤–æ–∑'];
const SALE_METHODS=['–°–∞–º–æ–≤—ã–≤–æ–∑','–î–æ—Å—Ç–∞–≤–∫–∞'];
const PAYMENT=['–ü–µ—Ä–µ–≤–æ–¥','–ù–∞–ª–∏—á–Ω—ã–µ','–ê–≤–∏—Ç–æ –î–æ—Å—Ç–∞–≤–∫–∞','–Æ–ú–∞–Ω–∏','–î—Ä—É–≥–æ–µ'];
const ACC_TYPES={joy:'üïπ –î–∂–æ–π–∫–æ–Ω',charger:'üîå –ó–∞—Ä—è–¥–∫–∞',case:'üéí –ö–µ–π—Å',other:'üì¶ –î—Ä—É–≥–æ–µ'};
const STATUS_META={
  active:{label:'–í –Ω–∞–ª–∏—á–∏–∏',cls:'p-active'},
  partial:{label:'–ß–∞—Å—Ç–∏—á–Ω–æ',cls:'p-partial'},
  sold:{label:'–ü—Ä–æ–¥–∞–Ω ‚úì',cls:'p-sold'},
  parts:{label:'–ù–∞ –∑–∞–ø—á–∞—Å—Ç–∏',cls:'p-parts'},
};
const MONTHS_RU=['–Ø–Ω–≤','–§–µ–≤','–ú–∞—Ä','–ê–ø—Ä','–ú–∞–π','–ò—é–Ω','–ò—é–ª','–ê–≤–≥','–°–µ–Ω','–û–∫—Ç','–ù–æ—è','–î–µ–∫'];
const MONTHS_FULL=['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];

const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,6);
const fmt=n=>(n==null||isNaN(n))?'‚Äî':new Intl.NumberFormat('ru-RU').format(Math.round(n))+' ‚ÇΩ';
const fmtS=n=>{const a=Math.abs(n);if(a>=1e6)return(n/1e6).toFixed(1)+'M ‚ÇΩ';if(a>=1e3)return(n/1e3).toFixed(1)+'K ‚ÇΩ';return Math.round(n)+' ‚ÇΩ';};
const fmtD=d=>{if(!d)return'';const dt=new Date(d);return dt.toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit',year:'2-digit'});};
const todayStr=()=>new Date().toISOString().slice(0,10);
const mKey=d=>d?d.slice(0,7):'';
const lotSales=(sales,lotId)=>sales.filter(s=>s.lotId===lotId);
const lotSalesTotal=(sales,lotId)=>lotSales(sales,lotId).reduce((s,x)=>s+(x.amount||0),0);
const computeStatus=(lot,sales)=>{
  if(lot.status==='parts')return'parts';
  const sold=lotSalesTotal(sales,lot.id);
  if(sold<=0)return'active';
  if(sold<(lot.cost||0))return'partial';
  return'sold';
};

// ‚îÄ‚îÄ GOOGLE DRIVE STORAGE (—á–µ—Ä–µ–∑ Netlify Functions) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const GD = {
  CLIENT_ID: null, // –ë—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω —Å —Å–µ—Ä–≤–µ—Ä–∞
  SCOPES:    'https://www.googleapis.com/auth/drive.appdata',
  FILE_NAME: 'consolefliip_data.json',
  _fileId:   null,
  _token:    null,

  async _callFunction(action, extraData = {}) {
    const response = await fetch('/.netlify/functions/google-drive', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action,
        token: this._token,
        fileId: this._fileId,
        ...extraData
      })
    });
    if (!response.ok) throw new Error('Function call failed');
    return await response.json();
  },

  async init(onReady, onNeedAuth) {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º CLIENT_ID —Å —Å–µ—Ä–≤–µ—Ä–∞
    try {
      const result = await this._callFunction('get_client_id');
      this.CLIENT_ID = result.clientId;
    } catch (e) {
      console.error('Failed to get CLIENT_ID:', e);
      onNeedAuth();
      return;
    }

    // Try restore token from localStorage
    const saved = localStorage.getItem('gd_token');
    if (saved) {
      const t = JSON.parse(saved);
      if (t.expiry > Date.now()) {
        this._token = t.access_token;
        try { const d = await this.load(); onReady(d); return; } catch(e) {}
      }
    }
    onNeedAuth();
  },

  signIn(cb) {
    const client = google.accounts.oauth2.initTokenClient({
      client_id: this.CLIENT_ID,
      scope: this.SCOPES,
      callback: async (resp) => {
        if (resp.error) { cb(null, resp.error); return; }
        this._token = resp.access_token;
        localStorage.setItem('gd_token', JSON.stringify({
          access_token: resp.access_token,
          expiry: Date.now() + (resp.expires_in - 60) * 1000
        }));
        const d = await this.load();
        cb(d);
      }
    });
    client.requestAccessToken();
  },

  signOut() {
    this._token = null;
    this._fileId = null;
    localStorage.removeItem('gd_token');
  },

  async _findFile() {
    if (this._fileId) return this._fileId;
    const result = await this._callFunction('search');
    this._fileId = result.files?.[0]?.id || null;
    return this._fileId;
  },

  async load() {
    const fid = await this._findFile();
    if (!fid) return null;
    const result = await this._callFunction('get');
    return result;
  },

  async save(data) {
    if (!this._token) return;
    let fid = await this._findFile();
    if (fid) {
      await this._callFunction('update', { data });
    } else {
      const result = await this._callFunction('create');
      this._fileId = result.id;
      await this._callFunction('update', { data });
    }
  }
};

// Fallback to localStorage when no Google credentials configured
const USE_GD = true; // Netlify –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Google Drive
const SKEY='cf_v3';
const loadState=()=>{try{const r=localStorage.getItem(SKEY);if(r)return JSON.parse(r);}catch(e){}return null;};
const saveState=s=>{
  try{localStorage.setItem(SKEY,JSON.stringify(s));}catch(e){}
  if(USE_GD) GD.save(s).catch(()=>{});
};

const makeDemoData=()=>{
  const id1=uid(),id2=uid(),id3=uid();
  return{
    lots:[
      {id:id1,console:'Nintendo Switch OLED',color:'–ë–µ–ª—ã–π',cost:16500,date:'2025-01-10',sourceType:'–î–æ—Å—Ç–∞–≤–∫–∞',sourceAddr:'',condition:8,status:'active',notes:'–°–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–ª–∏—á–Ω–æ–µ',
       cartridges:[{id:uid(),name:'Zelda: Breath of the Wild',inBox:true},{id:uid(),name:'Mario Kart 8 Deluxe',inBox:false}],
       accessories:[{id:uid(),name:'Joy-Con Neon',type:'joy'}],createdAt:'2025-01-10T10:00:00'},
      {id:id2,console:'Nintendo Switch Lite',color:'–°–∏–Ω–∏–π',cost:9800,date:'2025-01-20',sourceType:'–õ–æ–º–±–∞—Ä–¥',sourceAddr:'',condition:7,status:'active',notes:'',
       cartridges:[{id:uid(),name:'Animal Crossing',inBox:true}],
       accessories:[{id:uid(),name:'–ö–µ–π—Å Orzly',type:'case'}],createdAt:'2025-01-20T10:00:00'},
      {id:id3,console:'Nintendo Switch Rev2',color:'–ù–µ–æ–Ω',cost:12000,date:'2025-02-03',sourceType:'–°–∞–º–æ–≤—ã–≤–æ–∑',sourceAddr:'—É–ª. –õ–µ–Ω–∏–Ω–∞ 15',condition:9,status:'active',notes:'',
       cartridges:[],accessories:[],createdAt:'2025-02-03T10:00:00'},
    ],
    sales:[
      {id:uid(),lotId:id1,item:'Switch OLED –∫–æ–Ω—Å–æ–ª—å',amount:15000,date:'2025-01-18',platform:'–ê–≤–∏—Ç–æ',pay:'–ü–µ—Ä–µ–≤–æ–¥',method:'–î–æ—Å—Ç–∞–≤–∫–∞',note:'',createdAt:'2025-01-18T10:00:00'},
      {id:uid(),lotId:id1,item:'Joy-Con Neon',amount:3200,date:'2025-01-22',platform:'–ê–≤–∏—Ç–æ',pay:'–ù–∞–ª–∏—á–Ω—ã–µ',method:'–°–∞–º–æ–≤—ã–≤–æ–∑',note:'',createdAt:'2025-01-22T10:00:00'},
      {id:uid(),lotId:id2,item:'Switch Lite + –∫–µ–π—Å',amount:9000,date:'2025-01-26',platform:'–Æ–ª–∞',pay:'–Æ–ú–∞–Ω–∏',method:'–î–æ—Å—Ç–∞–≤–∫–∞',note:'–°–∫–∏–¥–∫–∞ 800‚ÇΩ',createdAt:'2025-01-26T10:00:00'},
    ],
    cartridgeDb:[],
  };
};

function App(){
  const[data,setData]=useState(()=>{const s=loadState();if(s)return s;const d=makeDemoData();saveState(d);return d;});
  const[tab,setTab]=useState('lots');
  const[modal,setModal]=useState(null);
  const[expanded,setExpanded]=useState(new Set());
  const[fStatus,setFStatus]=useState('');
  const[fMonth,setFMonth]=useState('');
  const[hMonth,setHMonth]=useState('');
  const[gdStatus,setGdStatus]=useState(USE_GD?'init':'off'); // off|init|need_auth|syncing|ok|error
  const[gdMsg,setGdMsg]=useState('');
  const[lastSaved,setLastSaved]=useState(null);

  // Init Google Drive on mount
  useEffect(()=>{
    if(!USE_GD)return;
    GD.init(
      (remoteData)=>{
        if(remoteData){
          setData(remoteData);
          localStorage.setItem(SKEY,JSON.stringify(remoteData));
        }
        setGdStatus('ok');
        setLastSaved(new Date());
      },
      ()=>setGdStatus('need_auth')
    );
  },[]);

  const gdSignIn=()=>{
    setGdStatus('syncing');
    GD.signIn((remoteData,err)=>{
      if(err){setGdStatus('error');setGdMsg('–û—à–∏–±–∫–∞: '+err);return;}
      if(remoteData){
        setData(remoteData);
        localStorage.setItem(SKEY,JSON.stringify(remoteData));
      } else {
        GD.save(data).catch(()=>{});
      }
      setGdStatus('ok');
      setLastSaved(new Date());
    });
  };

  const gdSignOut=()=>{GD.signOut();setGdStatus('need_auth');};

  const upd=useCallback(fn=>{
    setData(d=>{
      const nd=fn(JSON.parse(JSON.stringify(d)));
      saveState(nd);
      if(USE_GD&&GD._token){
        setGdStatus('syncing');
        GD.save(nd).then(()=>{setGdStatus('ok');setLastSaved(new Date());}).catch(()=>setGdStatus('error'));
      }
      return nd;
    });
  },[]);
  const toggleLot=id=>setExpanded(s=>{const n=new Set(s);n.has(id)?n.delete(id):n.add(id);return n;});
  const openModal=(type,d={})=>setModal({type,d});
  const closeModal=()=>setModal(null);

  const stats=useMemo(()=>{
    const invested=data.lots.reduce((s,l)=>s+(l.cost||0),0);
    const revenue=data.sales.reduce((s,x)=>s+(x.amount||0),0);
    const profit=revenue-invested;
    const margin=invested>0?profit/invested*100:0;
    const openLots=data.lots.filter(l=>computeStatus(l,data.sales)!=='sold');
    const frozen=openLots.reduce((s,l)=>s+Math.max(0,(l.cost||0)-lotSalesTotal(data.sales,l.id)),0);
    return{invested,revenue,profit,margin,frozen,openCount:openLots.length};
  },[data]);

  const lotMonths=useMemo(()=>[...new Set(data.lots.map(l=>mKey(l.date)).filter(Boolean))].sort().reverse(),[data.lots]);
  const saleMonths=useMemo(()=>[...new Set(data.sales.map(s=>mKey(s.date)).filter(Boolean))].sort().reverse(),[data.sales]);
  const cartDb=useMemo(()=>{const n=new Set(data.cartridgeDb||[]);data.lots.forEach(l=>(l.cartridges||[]).forEach(c=>n.add(c.name)));return[...n].sort();},[data]);

  return<div className="app">
    {/* GOOGLE DRIVE AUTH BANNER */}
    {USE_GD&&gdStatus==='need_auth'&&<div style={{background:'rgba(255,216,79,.08)',border:'1px solid rgba(255,216,79,.2)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:'12px',display:'flex',alignItems:'center',gap:'10px',flexWrap:'wrap'}}>
      <span style={{fontSize:'.82rem',color:'var(--warn)',flex:1}}>‚òÅÔ∏è –í–æ–π–¥–∏ —á–µ—Ä–µ–∑ Google —á—Ç–æ–±—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏</span>
      <button className="btn btn-w btn-sm" onClick={gdSignIn}>–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
    </div>}
    {USE_GD&&gdStatus==='error'&&<div style={{background:'rgba(255,79,110,.08)',border:'1px solid rgba(255,79,110,.2)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:'12px',fontSize:'.8rem',color:'var(--red)'}}>
      ‚ö†Ô∏è {gdMsg} ‚Äî –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ
    </div>}

    <div className="hdr">
      <div className="logo"><div className="logo-box">üéÆ</div><div className="logo-name">Console<span>Flip</span></div></div>
      <div style={{display:'flex',alignItems:'center',gap:'8px'}}>
        {USE_GD&&gdStatus==='ok'&&<div style={{display:'flex',alignItems:'center',gap:'5px',fontSize:'.68rem',color:'var(--t3)',cursor:'pointer'}} onClick={gdSignOut} title="–í—ã–π—Ç–∏ –∏–∑ Google">
          <span style={{width:'6px',height:'6px',borderRadius:'50%',background:'var(--accent)',display:'inline-block'}}/>
          <span>Google Drive</span>
        </div>}
        {USE_GD&&gdStatus==='syncing'&&<div style={{fontSize:'.68rem',color:'var(--t3)'}}>
          <span style={{display:'inline-block',animation:'spin .8s linear infinite'}}>‚ü≥</span> —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...
        </div>}
        {USE_GD&&gdStatus==='need_auth'&&<button className="btn btn-g btn-sm" onClick={gdSignIn} style={{fontSize:'.72rem',padding:'5px 10px'}}>‚òÅÔ∏è –í–æ–π—Ç–∏</button>}
        <button className="btn btn-a" onClick={()=>openModal('lot',{})}>+ –õ–æ—Ç</button>
      </div>
    </div>
    <div className="sbar">
      {[['g',stats.profit>=0?'g':'r','–ü—Ä–∏–±—ã–ª—å',fmtS(stats.profit),(stats.margin>=0?'+':'')+stats.margin.toFixed(1)+'% –º–∞—Ä–∂–∞'],
        ['b','b','–í—ã—Ä—É—á–∫–∞',fmtS(stats.revenue),data.sales.length+' —Å–¥–µ–ª–æ–∫'],
        ['w','w','–ù–µ –∑–∞–∫—Ä—ã—Ç–æ',stats.openCount+'','‚àí'+fmtS(stats.frozen)],
        ['r','r','–í–ª–æ–∂–µ–Ω–æ',fmtS(stats.invested),data.lots.length+' –ª–æ—Ç–æ–≤'],
      ].map(([bc,vc,lbl,val,sub])=><div key={lbl} className={`sc ${bc}`}>
        <div className="sc-lbl">{lbl}</div>
        <div className={`sc-val ${vc}`}>{val}</div>
        <div className="sc-sub">{sub}</div>
      </div>)}
    </div>
    <div className="tabs">
      {[['lots','–õ–æ—Ç—ã'],['sales','–ò—Å—Ç–æ—Ä–∏—è'],['stats','–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'],['accs','–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã']].map(([k,l])=>(
        <button key={k} className={`tab ${tab===k?'on':''}`} onClick={()=>setTab(k)}>{l}</button>
      ))}
    </div>
    {tab==='lots'&&<LotsTab data={data} upd={upd} expanded={expanded} toggleLot={toggleLot}
      openModal={openModal} fStatus={fStatus} setFStatus={setFStatus}
      fMonth={fMonth} setFMonth={setFMonth} lotMonths={lotMonths} cartDb={cartDb}/>}
    {tab==='sales'&&<HistTab data={data} hMonth={hMonth} setHMonth={setHMonth}
      saleMonths={saleMonths} openModal={openModal}/>}
    {tab==='stats'&&<StatsTab data={data} stats={stats}/>}
    {tab==='accs'&&<AccsTab data={data}/>}
    {modal?.type==='lot'&&<LotModal data={data} upd={upd} init={modal.d} cartDb={cartDb} close={closeModal}/>}
    {modal?.type==='sale'&&<SaleModal data={data} upd={upd} init={modal.d} close={closeModal}/>}
    {modal?.type==='del'&&<DelModal upd={upd} init={modal.d} close={closeModal}/>}
    {modal?.type==='view'&&<ViewModal data={data} lot={modal.d.lot} upd={upd} openModal={openModal} close={closeModal}/>}
  </div>;
}

function LotsTab({data,upd,expanded,toggleLot,openModal,fStatus,setFStatus,fMonth,setFMonth,lotMonths,cartDb}){
  let lots=[...data.lots].sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
  if(fStatus)lots=lots.filter(l=>computeStatus(l,data.sales)===fStatus);
  if(fMonth)lots=lots.filter(l=>mKey(l.date)===fMonth);
  return<>
    <div className="sec-hdr">
      <span className="sec-title">–õ–æ—Ç—ã</span>
      <div className="filter-row">
        <select className="sel-sm" value={fMonth} onChange={e=>setFMonth(e.target.value)}>
          <option value="">–í—Å–µ –º–µ—Å—è—Ü—ã</option>
          {lotMonths.map(m=>{const[y,mo]=m.split('-');return<option key={m} value={m}>{MONTHS_FULL[parseInt(mo)-1]} {y}</option>;})}
        </select>
        <select className="sel-sm" value={fStatus} onChange={e=>setFStatus(e.target.value)}>
          <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
          <option value="active">–í –Ω–∞–ª–∏—á–∏–∏</option>
          <option value="partial">–ß–∞—Å—Ç–∏—á–Ω–æ</option>
          <option value="sold">–ó–∞–∫—Ä—ã—Ç—ã</option>
          <option value="parts">–ù–∞ –∑–∞–ø—á–∞—Å—Ç–∏</option>
        </select>
        <span className="sec-cnt">{lots.length}</span>
      </div>
    </div>
    {!lots.length?<div className="empty"><div className="empty-icon">üì¶</div><div className="empty-txt">–ù–µ—Ç –ª–æ—Ç–æ–≤</div></div>
      :lots.map(lot=><LotCard key={lot.id} lot={lot} data={data} upd={upd}
          expanded={expanded.has(lot.id)} toggle={()=>toggleLot(lot.id)}
          openModal={openModal} cartDb={cartDb}/>)}
  </>;
}

function LotCard({lot,data,upd,expanded,toggle,openModal}){
  const[cartSell,setCartSell]=useState(null);
  const status=computeStatus(lot,data.sales);
  const sold=lotSalesTotal(data.sales,lot.id);
  const profit=sold-(lot.cost||0);
  const pct=lot.cost>0?Math.min(100,sold/lot.cost*100):0;
  const sales=lotSales(data.sales,lot.id);
  const sm=STATUS_META[status];
  const pnlCls=profit>0?'pos':profit<0?'neg':'zero';

  const rmSale=id=>upd(d=>{d.sales=d.sales.filter(s=>s.id!==id);return d;});
  const rmAcc=id=>upd(d=>{const l=d.lots.find(x=>x.id===lot.id);if(l)l.accessories=l.accessories.filter(a=>a.id!==id);return d;});

  return<div className={`lot-card st-${status}`}>
    <div className="lot-head" onClick={toggle}>
      <div className="lot-badge">{lot.id.slice(-4).toUpperCase()}</div>
      <div className="lot-info">
        <div className="lot-name">{lot.console} ¬∑ {lot.color}</div>
        <div className="lot-sub">
          {lot.date&&<span className="td">{fmtD(lot.date)}</span>}
          {lot.condition&&<span className="tag tk">{lot.condition}/10</span>}
          {lot.sourceType&&<span className="tag ts">{lot.sourceType}</span>}
          {(lot.cartridges||[]).length>0&&<span className="tag ta">{lot.cartridges.length} –∫–∞—Ä—Ç.</span>}
          {(lot.accessories||[]).length>0&&<span className="tag ta">{lot.accessories.length} –∞–∫—Å.</span>}
        </div>
      </div>
      <div className="lot-right">
        <div className="lot-nums">
          <div className="lot-cost">{fmt(lot.cost)}</div>
          <div className={`lot-pnl ${pnlCls}`}>{sold>0?(profit>0?'+':'')+fmt(profit):'‚Äî'}</div>
        </div>
        <div className={`pill ${sm.cls}`}>{sm.label}</div>
        <div className={`chev ${expanded?'open':''}`}>‚ñæ</div>
      </div>
    </div>

    {expanded&&<div className="lot-body">
      {lot.cost>0&&sold>0&&<div className="prog-wrap">
        <div className="prog-labels">
          <span>{fmt(sold)} –∏–∑ {fmt(lot.cost)}</span>
          <span className={`prog-pct ${pct>=100?'done':'mid'}`}>{pct.toFixed(0)}%</span>
        </div>
        <div className="prog-track"><div className={`prog-fill ${pct>=100?'done':''}`} style={{width:pct+'%'}}/></div>
      </div>}

      {/* CARTRIDGES */}
      {(lot.cartridges||[]).length>0&&<><div className="divider"/>
        <div className="blk">
          <div className="blk-hdr"><span>üóÇ –ö–∞—Ä—Ç—Ä–∏–¥–∂–∏</span></div>
          {lot.cartridges.map(c=>{
            const cs=data.sales.find(s=>s.lotId===lot.id&&s.cartridgeId===c.id);
            return<React.Fragment key={c.id}>
              <div className="cart-row">
                <span className="cart-name">üìº {c.name}</span>
                {c.inBox&&<span className="cart-box-badge">üì¶ –ö–æ—Ä–æ–±–∫–∞</span>}
                {cs
                  ?<span className="cart-sold-badge">+{fmt(cs.amount)}</span>
                  :<button className="btn btn-xs btn-w" onClick={()=>setCartSell(cartSell===c.id?null:c.id)}>–ü—Ä–æ–¥–∞—Ç—å</button>
                }
              </div>
              {cartSell===c.id&&!cs&&<InlineSell lotId={lot.id} cartId={c.id} name={c.name} upd={upd} done={()=>setCartSell(null)}/>}
            </React.Fragment>;
          })}
        </div>
      </>}

      {/* ACCESSORIES */}
      {(lot.accessories||[]).length>0&&<><div className="divider"/>
        <div className="blk">
          <div className="blk-hdr"><span>üïπ –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</span>
            <button className="btn btn-xs btn-g" onClick={()=>openModal('lot',{edit:lot})}>–ò–∑–º–µ–Ω–∏—Ç—å</button>
          </div>
          {lot.accessories.map(a=><div key={a.id} className="sale-row">
            <div className="sale-info">
              <div className="sale-item">{ACC_TYPES[a.type]||'üì¶'} {a.name}</div>
            </div>
            <button className="btn btn-xs btn-d" onClick={()=>rmAcc(a.id)}>√ó</button>
          </div>)}
        </div>
      </>}

      {/* SALES */}
      <div className="divider"/>
      <div className="blk">
        <div className="blk-hdr">
          <span>üí∞ –ü—Ä–æ–¥–∞–∂–∏{sales.length>0?` (${sales.length})`:''}</span>
          <button className="btn btn-xs btn-a" onClick={()=>openModal('sale',{lotId:lot.id})}>+ –ü—Ä–æ–¥–∞–∂–∞</button>
        </div>
        {!sales.length&&<div style={{fontSize:'.78rem',color:'var(--t3)',fontStyle:'italic'}}>–ü—Ä–æ–¥–∞–∂ –Ω–µ—Ç</div>}
        {sales.map(s=><div key={s.id} className="sale-row">
          <div className="sale-info">
            <div className="sale-item">{s.item}</div>
            <div className="sale-meta">
              <span className="sale-date">{fmtD(s.date)}</span>
              {s.platform&&<span className="sale-plat">{s.platform}</span>}
              {s.method&&<span className="sale-meth">{s.method}</span>}
              {s.pay&&<span className="sale-meth">¬∑ {s.pay}</span>}
            </div>
          </div>
          <span className="sale-amt">{fmt(s.amount)}</span>
          <button className="btn btn-xs btn-d" onClick={()=>rmSale(s.id)}>√ó</button>
        </div>)}
      </div>

      {lot.notes&&<><div className="divider"/><div className="lot-notes-txt">{lot.notes}</div></>}

      <div className="lot-acts">
        <button className="btn btn-a btn-sm" onClick={()=>openModal('sale',{lotId:lot.id})}>+ –ü—Ä–æ–¥–∞–∂–∞</button>
        <button className="btn btn-g btn-sm" onClick={()=>openModal('lot',{edit:lot})}>‚úè –ò–∑–º–µ–Ω–∏—Ç—å</button>
        <button className="btn btn-g btn-sm" onClick={()=>openModal('view',{lot})}>üîç –ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
        <button className="btn btn-d btn-sm" onClick={()=>openModal('del',{lotId:lot.id,name:`${lot.console} ${lot.color}`})}>üóë</button>
      </div>
    </div>}
  </div>;
}

function InlineSell({lotId,cartId,name,upd,done}){
  const[amt,setAmt]=useState('');
  const[date,setDate]=useState(todayStr());
  const[platform,setPlatform]=useState('');
  const[method,setMethod]=useState('–î–æ—Å—Ç–∞–≤–∫–∞');
  const save=()=>{
    if(!amt)return;
    upd(d=>{d.sales.push({id:uid(),lotId,cartridgeId:cartId,item:name,amount:parseFloat(amt),date,platform,method,pay:'–ü–µ—Ä–µ–≤–æ–¥',note:'',createdAt:new Date().toISOString()});return d;});
    done();
  };
  return<div className="inline-sell">
    <div className="is-row">
      <input type="number" placeholder="–°—É–º–º–∞ ‚ÇΩ" value={amt} onChange={e=>setAmt(e.target.value)}/>
      <input type="date" value={date} onChange={e=>setDate(e.target.value)}/>
    </div>
    <div className="is-row">
      <input placeholder="–ü–ª–æ—â–∞–¥–∫–∞ (–ê–≤–∏—Ç–æ...)" value={platform} onChange={e=>setPlatform(e.target.value)}/>
      <select value={method} onChange={e=>setMethod(e.target.value)} style={{background:'var(--surf3)',border:'1px solid var(--border)',borderRadius:'7px',padding:'6px 10px',color:'var(--text)',fontFamily:'var(--sans)',fontSize:'.82rem',outline:'none',WebkitAppearance:'none',backgroundImage:"url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%238892b0' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E\")",backgroundRepeat:'no-repeat',backgroundPosition:'right 7px center',flex:1}}>
        {SALE_METHODS.map(m=><option key={m}>{m}</option>)}
      </select>
    </div>
    <div className="is-row">
      <button className="btn btn-a btn-sm" onClick={save}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button className="btn btn-g btn-sm" onClick={done}>–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>;
}

function HistTab({data,hMonth,setHMonth,saleMonths,openModal}){
  let sales=[...data.sales].sort((a,b)=>new Date(b.date)-new Date(a.date));
  if(hMonth)sales=sales.filter(s=>mKey(s.date)===hMonth);
  const total=sales.reduce((s,x)=>s+(x.amount||0),0);
  return<>
    <div className="sec-hdr">
      <span className="sec-title">–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–¥–∞–∂</span>
      <div className="filter-row">
        <select className="sel-sm" value={hMonth} onChange={e=>setHMonth(e.target.value)}>
          <option value="">–í—Å–µ –º–µ—Å—è—Ü—ã</option>
          {saleMonths.map(m=>{const[y,mo]=m.split('-');return<option key={m} value={m}>{MONTHS_FULL[parseInt(mo)-1]} {y}</option>;})}
        </select>
        <span className="sec-cnt">{fmt(total)}</span>
      </div>
    </div>
    {!sales.length?<div className="empty"><div className="empty-icon">üí∏</div><div className="empty-txt">–ü—Ä–æ–¥–∞–∂ –Ω–µ—Ç</div></div>
      :sales.map(s=>{
        const lot=data.lots.find(l=>l.id===s.lotId);
        return<div key={s.id} className="hist-card" onClick={()=>lot&&openModal('view',{lot})}>
          <div className="hist-icon">üí∞</div>
          <div className="hist-info">
            <div className="hist-name">{s.item}</div>
            <div className="hist-sub">{lot?`${lot.console} ${lot.color}`:'–£–¥–∞–ª—ë–Ω–Ω—ã–π –ª–æ—Ç'} ¬∑ {fmtD(s.date)}{s.platform&&` ¬∑ ${s.platform}`}{s.method&&` ¬∑ ${s.method}`}</div>
          </div>
          <span className="hist-amt">{fmt(s.amount)}</span>
        </div>;
      })}
  </>;
}

function StatsTab({data,stats}){
  const monthly=useMemo(()=>{
    const map={};
    data.sales.forEach(s=>{const k=mKey(s.date);if(!k)return;if(!map[k])map[k]={rev:0,deals:0};map[k].rev+=s.amount||0;map[k].deals++;});
    const inv={};data.lots.forEach(l=>{const k=mKey(l.date);if(!k)return;if(!inv[k])inv[k]=0;inv[k]+=(l.cost||0);});
    return Object.keys(map).sort().slice(-6).map(k=>({key:k,rev:map[k].rev,deals:map[k].deals,profit:map[k].rev-(inv[k]||0)}));
  },[data]);
  const maxRev=Math.max(...monthly.map(m=>m.rev),1);
  const sc={active:0,partial:0,sold:0,parts:0};
  data.lots.forEach(l=>sc[computeStatus(l,data.sales)]++);
  const avgDeal=data.sales.length>0?stats.revenue/data.sales.length:0;
  const openLots=data.lots.filter(l=>computeStatus(l,data.sales)!=='sold');
  const byModel=useMemo(()=>{
    const m={};data.lots.forEach(l=>{const k=l.console||'?';if(!m[k])m[k]={c:0,inv:0,rev:0};m[k].c++;m[k].inv+=l.cost||0;m[k].rev+=lotSalesTotal(data.sales,l.id);});
    return Object.entries(m).sort((a,b)=>b[1].c-a[1].c);
  },[data]);

  return<>
    {monthly.length>0&&<div className="month-chart">
      <div className="month-title">üìà –í—ã—Ä—É—á–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º</div>
      <div className="month-bars">
        {monthly.map(m=>{
          const h=Math.max(3,m.rev/maxRev*72);
          const[y,mo]=m.key.split('-');
          return<div key={m.key} className="month-col">
            <div style={{fontSize:'.58rem',color:'var(--t3)',fontFamily:'var(--mono)'}}>{(m.rev/1000).toFixed(0)}K</div>
            <div className="month-bar" style={{height:h+'px'}}/>
            <div className="month-lbl">{MONTHS_RU[parseInt(mo)-1]}</div>
          </div>;
        })}
      </div>
    </div>}
    <div className="stat-grid">
      <div className="stat-blk">
        <div className="stat-blk-title">üí∞ –§–∏–Ω–∞–Ω—Å—ã</div>
        {[['–í—ã—Ä—É—á–∫–∞',fmt(stats.revenue),'var(--a3)'],['–í–ª–æ–∂–µ–Ω–æ',fmt(stats.invested),'var(--a2)'],
          ['–ü—Ä–∏–±—ã–ª—å',(stats.profit>=0?'+':'')+fmt(stats.profit),stats.profit>=0?'var(--accent)':'var(--red)'],
          ['–ú–∞—Ä–∂–∞',stats.margin.toFixed(1)+'%',stats.margin>=0?'var(--accent)':'var(--red)'],
          ['–°—Ä–µ–¥–Ω–∏–π —á–µ–∫',fmt(avgDeal),'var(--text)'],['–°–¥–µ–ª–æ–∫',data.sales.length,'var(--a3)'],
        ].map(([l,v,c])=><div key={l} className="stat-line"><span className="stat-ln-lbl">{l}</span><span className="stat-ln-val" style={{color:c}}>{v}</span></div>)}
      </div>
      <div className="stat-blk">
        <div className="stat-blk-title">üì¶ –õ–æ—Ç—ã</div>
        {[['–í—Å–µ–≥–æ',data.lots.length,'var(--text)'],['–í –Ω–∞–ª–∏—á–∏–∏',sc.active,'var(--t2)'],
          ['–ß–∞—Å—Ç–∏—á–Ω–æ',sc.partial,'var(--warn)'],['–ü—Ä–æ–¥–∞–Ω–æ',sc.sold,'var(--accent)'],
          ['–ù–∞ –∑–∞–ø—á–∞—Å—Ç–∏',sc.parts,'var(--red)'],['–ó–∞–º–æ—Ä–æ–∂–µ–Ω–æ',fmt(stats.frozen),'var(--warn)'],
        ].map(([l,v,c])=><div key={l} className="stat-line"><span className="stat-ln-lbl">{l}</span><span className="stat-ln-val" style={{color:c}}>{v}</span></div>)}
      </div>
    </div>
    {byModel.length>0&&<div className="stat-blk" style={{marginBottom:'14px'}}>
      <div className="stat-blk-title">üéÆ –ü–æ –º–æ–¥–µ–ª—è–º</div>
      {byModel.map(([model,d])=><div key={model} className="stat-line">
        <span className="stat-ln-lbl">{model} ({d.c} —à—Ç.)</span>
        <span className="stat-ln-val" style={{color:d.rev-d.inv>=0?'var(--accent)':'var(--red)'}}>{(d.rev-d.inv>=0?'+':'')+fmt(d.rev-d.inv)}</span>
      </div>)}
    </div>}
    {openLots.length>0&&<div className="stat-blk">
      <div className="stat-blk-title">‚ö†Ô∏è –ù–µ–∑–∞–∫—Ä—ã—Ç—ã–µ –ª–æ—Ç—ã</div>
      {openLots.map(lot=>{const sold=lotSalesTotal(data.sales,lot.id);const pct=lot.cost>0?Math.min(100,sold/lot.cost*100):0;
        return<div key={lot.id} className="open-lot-row">
          <div className="open-lot-name">{lot.console} {lot.color}</div>
          <div className="open-lot-remains">‚àí{fmt(Math.max(0,(lot.cost||0)-sold))}</div>
          <div className="open-bar"><div className="open-fill" style={{width:pct+'%'}}/></div>
        </div>;})}
    </div>}
  </>;
}

function AccsTab({data}){
  const rows=useMemo(()=>{
    const r=[];
    data.lots.forEach(lot=>{
      (lot.accessories||[]).forEach(a=>{
        const cs=data.sales.find(s=>s.lotId===lot.id&&s.accId===a.id);
        r.push({...a,lotName:`${lot.console} ${lot.color}`,lotDate:lot.date,sale:cs||null});
      });
    });
    return r.sort((a,b)=>new Date(b.lotDate)-new Date(a.lotDate));
  },[data]);
  return<>
    <div className="sec-hdr"><span className="sec-title">–í—Å–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã</span><span className="sec-cnt">{rows.length}</span></div>
    {!rows.length?<div className="empty"><div className="empty-icon">üïπ</div><div className="empty-txt">–ê–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div></div>
      :<div style={{background:'var(--surf)',border:'1px solid var(--border)',borderRadius:'var(--r2)',overflow:'hidden'}}>
        {rows.map((a,i)=><div key={a.id} className="acc-tab-row">
          <div className="acc-tab-icon">{ACC_TYPES[a.type]?.slice(0,2)||'üì¶'}</div>
          <div className="acc-tab-info">
            <div className="acc-tab-name">{a.name}</div>
            <div className="acc-tab-sub">{a.lotName} ¬∑ {fmtD(a.lotDate)}</div>
          </div>
          <div className="acc-tab-type">{ACC_TYPES[a.type]?.split(' ')[1]||'–î—Ä—É–≥–æ–µ'}</div>
          {a.sale?<span style={{fontFamily:'var(--mono)',fontSize:'.78rem',color:'var(--accent)'}}>+{fmt(a.sale.amount)}</span>
            :<span style={{fontSize:'.65rem',color:'var(--t3)',background:'var(--surf2)',padding:'2px 7px',borderRadius:'4px'}}>–Ω–µ –ø—Ä–æ–¥–∞–Ω</span>}
        </div>)}
      </div>}
  </>;
}

function LotModal({data,upd,init,cartDb,close}){
  const e=init.edit||null;
  const[cn,setCn]=useState(e?.console||CONSOLES[0]);
  const[color,setColor]=useState(e?.color||'');
  const[colorCustom,setColorCustom]=useState('');
  const[cost,setCost]=useState(e?.cost||'');
  const[date,setDate]=useState(e?.date||todayStr());
  const[srcType,setSrcType]=useState(e?.sourceType||'–î–æ—Å—Ç–∞–≤–∫–∞');
  const[srcAddr,setSrcAddr]=useState(e?.sourceAddr||'');
  const[cond,setCond]=useState(e?.condition||8);
  const[status,setStatus]=useState(e?.status||'active');
  const[notes,setNotes]=useState(e?.notes||'');
  const[carts,setCarts]=useState(e?.cartridges?JSON.parse(JSON.stringify(e.cartridges)):[]);
  const[accs,setAccs]=useState(e?.accessories?JSON.parse(JSON.stringify(e.accessories)):[]);
  const[cartIn,setCartIn]=useState('');
  const[cartBox,setCartBox]=useState(false);
  const[accIn,setAccIn]=useState('');
  const[accType,setAccType]=useState('joy');

  const colors=COLORS[cn]||[];
  useEffect(()=>{if(!e){setColor(colors[0]||'');}else{setColor(e.color||colors[0]||'');}},[cn]);

  const addCart=()=>{const n=cartIn.trim();if(!n)return;setCarts(c=>[...c,{id:uid(),name:n,inBox:cartBox}]);setCartIn('');setCartBox(false);upd(d=>{if(!d.cartridgeDb)d.cartridgeDb=[];if(!d.cartridgeDb.includes(n))d.cartridgeDb.push(n);return d;});};
  const addAcc=()=>{const n=accIn.trim();if(!n)return;setAccs(a=>[...a,{id:uid(),name:n,type:accType}]);setAccIn('');};

  const save=()=>{
    if(!cn.trim())return;
    const fc=color==='–î—Ä—É–≥–æ–π'?colorCustom:color;
    if(e){
      upd(d=>{const l=d.lots.find(x=>x.id===e.id);if(l)Object.assign(l,{console:cn,color:fc,cost:parseFloat(cost)||0,date,sourceType:srcType,sourceAddr:srcAddr,condition:parseInt(cond)||8,status,notes,cartridges:carts,accessories:accs});return d;});
    }else{
      upd(d=>{d.lots.push({id:uid(),console:cn,color:fc,cost:parseFloat(cost)||0,date,sourceType:srcType,sourceAddr:srcAddr,condition:parseInt(cond)||8,status,notes,cartridges:carts,accessories:accs,createdAt:new Date().toISOString()});return d;});
    }
    close();
  };

  const selStyle={background:'var(--surf3)',border:'1px solid var(--border)',borderRadius:'7px',padding:'6px 24px 6px 8px',color:'var(--text)',fontFamily:'var(--sans)',fontSize:'.78rem',outline:'none',WebkitAppearance:'none',backgroundImage:"url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%238892b0' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E\")",backgroundRepeat:'no-repeat',backgroundPosition:'right 7px center',flex:1};

  return<div className="ov" onClick={ev=>{if(ev.target.className==='ov')close();}}>
    <div className="modal">
      <div className="modal-hdr"><div className="modal-title">{e?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ—Ç':'–ù–æ–≤—ã–π –ª–æ—Ç'}</div><button className="modal-x" onClick={close}>‚úï</button></div>
      <div className="modal-body">
        <div className="fr-2">
          <div className="fr"><label>–ü—Ä–∏—Å—Ç–∞–≤–∫–∞</label>
            <select value={cn} onChange={ev=>setCn(ev.target.value)}>{CONSOLES.map(c=><option key={c}>{c}</option>)}</select></div>
          <div className="fr"><label>–¶–≤–µ—Ç</label>
            <select value={color} onChange={ev=>setColor(ev.target.value)}>{colors.map(c=><option key={c}>{c}</option>)}</select></div>
        </div>
        {color==='–î—Ä—É–≥–æ–π'&&<div className="fr"><label>–°–≤–æ–π —Ü–≤–µ—Ç</label><input value={colorCustom} onChange={ev=>setColorCustom(ev.target.value)} placeholder="–í–≤–µ–¥–∏—Ç–µ —Ü–≤–µ—Ç"/></div>}
        <div className="fr-3">
          <div className="fr"><label>–ó–∞–∫—É–ø–∫–∞ ‚ÇΩ</label><input type="number" value={cost} onChange={ev=>setCost(ev.target.value)} placeholder="15000"/></div>
          <div className="fr"><label>–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏</label><input type="date" value={date} onChange={ev=>setDate(ev.target.value)}/></div>
          <div className="fr"><label>–°–æ—Å—Ç–æ—è–Ω–∏–µ /10</label><input type="number" min="1" max="10" value={cond} onChange={ev=>setCond(ev.target.value)}/></div>
        </div>
        <div className="fr-2">
          <div className="fr"><label>–û—Ç–∫—É–¥–∞ –∫—É–ø–ª–µ–Ω–æ</label>
            <select value={srcType} onChange={ev=>setSrcType(ev.target.value)}>{SOURCES.map(s=><option key={s}>{s}</option>)}</select></div>
          {srcType==='–°–∞–º–æ–≤—ã–≤–æ–∑'&&<div className="fr"><label>–ê–¥—Ä–µ—Å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label><input value={srcAddr} onChange={ev=>setSrcAddr(ev.target.value)} placeholder="—É–ª. –õ–µ–Ω–∏–Ω–∞ 15"/></div>}
        </div>
        <div className="fr"><label>–°—Ç–∞—Ç—É—Å</label>
          <select value={status} onChange={ev=>setStatus(ev.target.value)}>
            <option value="active">–í –Ω–∞–ª–∏—á–∏–∏</option><option value="partial">–ß–∞—Å—Ç–∏—á–Ω–æ –ø—Ä–æ–¥–∞–Ω</option>
            <option value="sold">–ü—Ä–æ–¥–∞–Ω</option><option value="parts">–ù–∞ –∑–∞–ø—á–∞—Å—Ç–∏</option>
          </select></div>

        {/* CARTRIDGES */}
        <div className="fr" style={{marginBottom:'12px'}}>
          <label>–ö–∞—Ä—Ç—Ä–∏–¥–∂–∏ –≤ –∫–æ–º–ø–ª–µ–∫—Ç–µ</label>
          <div className="item-ed">
            <div className="item-ed-list">
              {!carts.length&&<div style={{padding:'9px 11px',fontSize:'.78rem',color:'var(--t3)',fontStyle:'italic'}}>–ù–µ—Ç –∫–∞—Ä—Ç—Ä–∏–¥–∂–µ–π</div>}
              {carts.map(c=><div key={c.id} className="item-ed-row">
                <span className="item-ed-name">üìº {c.name}</span>
                {c.inBox&&<span className="item-ed-badge">üì¶</span>}
                <button className="item-ed-del" onClick={()=>setCarts(x=>x.filter(i=>i.id!==c.id))}>√ó</button>
              </div>)}
            </div>
            <div className="item-add-area">
              <div className="item-add-row">
                <input list="cdb" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—Ä–∏–¥–∂–∞" value={cartIn} onChange={ev=>setCartIn(ev.target.value)} onKeyDown={ev=>{if(ev.key==='Enter'){ev.preventDefault();addCart();}}}/>
                <datalist id="cdb">{cartDb.map(n=><option key={n} value={n}/>)}</datalist>
                <button className="item-add-btn" onClick={addCart}>+</button>
              </div>
              <label className="check-row"><input type="checkbox" checked={cartBox} onChange={ev=>setCartBox(ev.target.checked)}/><span>–° –∫–æ—Ä–æ–±–∫–æ–π</span></label>
            </div>
          </div>
        </div>

        {/* ACCESSORIES */}
        <div className="fr" style={{marginBottom:'12px'}}>
          <label>–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã (–¥–∂–æ–π–∫–æ–Ω—ã, –∑–∞—Ä—è–¥–∫–∏, –∫–µ–π—Å—ã...)</label>
          <div className="item-ed">
            <div className="item-ed-list">
              {!accs.length&&<div style={{padding:'9px 11px',fontSize:'.78rem',color:'var(--t3)',fontStyle:'italic'}}>–ù–µ—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤</div>}
              {accs.map(a=><div key={a.id} className="item-ed-row">
                <span className="item-ed-name">{ACC_TYPES[a.type]||'üì¶'} {a.name}</span>
                <button className="item-ed-del" onClick={()=>setAccs(x=>x.filter(i=>i.id!==a.id))}>√ó</button>
              </div>)}
            </div>
            <div className="item-add-area">
              <div className="item-add-row">
                <input placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value={accIn} onChange={ev=>setAccIn(ev.target.value)} onKeyDown={ev=>{if(ev.key==='Enter'){ev.preventDefault();addAcc();}}}/>
                <select value={accType} onChange={ev=>setAccType(ev.target.value)} style={selStyle}>
                  {Object.entries(ACC_TYPES).map(([k,v])=><option key={k} value={k}>{v}</option>)}
                </select>
                <button className="item-add-btn" onClick={addAcc}>+</button>
              </div>
            </div>
          </div>
        </div>

        <div className="fr" style={{marginBottom:0}}><label>–ó–∞–º–µ—Ç–∫–∏</label>
          <textarea value={notes} onChange={ev=>setNotes(ev.target.value)} placeholder="–°–æ—Å—Ç–æ—è–Ω–∏–µ, –Ω—é–∞–Ω—Å—ã..."/></div>
      </div>
      <div className="modal-footer">
        <button className="btn btn-g" onClick={close}>–û—Ç–º–µ–Ω–∞</button>
        <button className="btn btn-a" onClick={save}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>;
}

function SaleModal({data,upd,init,close}){
  const lot=data.lots.find(l=>l.id===init.lotId);
  const[item,setItem]=useState('');
  const[amount,setAmount]=useState('');
  const[date,setDate]=useState(todayStr());
  const[platform,setPlatform]=useState('');
  const[pay,setPay]=useState('–ü–µ—Ä–µ–≤–æ–¥');
  const[method,setMethod]=useState('–î–æ—Å—Ç–∞–≤–∫–∞');
  const[note,setNote]=useState('');
  const sugg=[lot?.console&&`${lot.console} –∫–æ–Ω—Å–æ–ª—å`,...(lot?.cartridges||[]).map(c=>c.name),...(lot?.accessories||[]).map(a=>a.name)].filter(Boolean);
  const save=()=>{
    if(!item.trim()||!amount)return;
    upd(d=>{d.sales.push({id:uid(),lotId:init.lotId,item:item.trim(),amount:parseFloat(amount),date,platform,pay,method,note,createdAt:new Date().toISOString()});return d;});
    close();
  };
  return<div className="ov" onClick={ev=>{if(ev.target.className==='ov')close();}}>
    <div className="modal">
      <div className="modal-hdr"><div className="modal-title">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥–∞–∂—É</div><button className="modal-x" onClick={close}>‚úï</button></div>
      <div className="modal-body">
        {lot&&<div style={{padding:'7px 12px',background:'var(--surf2)',borderRadius:'8px',marginBottom:'14px',fontSize:'.8rem',color:'var(--t2)'}}>
          –õ–æ—Ç: <strong style={{color:'var(--text)'}}>{lot.console} {lot.color}</strong></div>}
        <div className="fr"><label>–ß—Ç–æ –ø—Ä–æ–¥–∞–Ω–æ</label>
          <input list="sale-sugg" value={item} onChange={ev=>setItem(ev.target.value)} placeholder="–í—ã–±–µ—Ä–∏ –∏–ª–∏ –Ω–∞–ø–∏—à–∏"/>
          <datalist id="sale-sugg">{sugg.map(s=><option key={s} value={s}/>)}</datalist>
          {sugg.length>0&&<div className="fr-hint">–ò–∑ –ª–æ—Ç–∞: {sugg.join(', ')}</div>}</div>
        <div className="fr-2">
          <div className="fr"><label>–°—É–º–º–∞ ‚ÇΩ</label><input type="number" value={amount} onChange={ev=>setAmount(ev.target.value)} placeholder="14000"/></div>
          <div className="fr"><label>–î–∞—Ç–∞</label><input type="date" value={date} onChange={ev=>setDate(ev.target.value)}/></div>
        </div>
        <div className="fr-3">
          <div className="fr"><label>–ü–ª–æ—â–∞–¥–∫–∞</label><input value={platform} onChange={ev=>setPlatform(ev.target.value)} placeholder="–ê–≤–∏—Ç–æ..."/></div>
          <div className="fr"><label>–°–ø–æ—Å–æ–±</label>
            <select value={method} onChange={ev=>setMethod(ev.target.value)}>{SALE_METHODS.map(m=><option key={m}>{m}</option>)}</select></div>
          <div className="fr"><label>–û–ø–ª–∞—Ç–∞</label>
            <select value={pay} onChange={ev=>setPay(ev.target.value)}>{PAYMENT.map(p=><option key={p}>{p}</option>)}</select></div>
        </div>
        <div className="fr" style={{marginBottom:0}}><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
          <textarea value={note} onChange={ev=>setNote(ev.target.value)} placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"/></div>
      </div>
      <div className="modal-footer">
        <button className="btn btn-g" onClick={close}>–û—Ç–º–µ–Ω–∞</button>
        <button className="btn btn-a" onClick={save}>–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>;
}

function ViewModal({data,lot,upd,openModal,close}){
  const sales=lotSales(data.sales,lot.id);
  const totalSold=lotSalesTotal(data.sales,lot.id);
  const profit=totalSold-(lot.cost||0);
  const pct=lot.cost>0?Math.min(100,totalSold/lot.cost*100):0;
  const status=computeStatus(lot,data.sales);
  const sm=STATUS_META[status];
  return<div className="ov" onClick={ev=>{if(ev.target.className==='ov')close();}}>
    <div className="modal" style={{maxWidth:'540px'}}>
      <div className="modal-hdr"><div className="modal-title">{lot.console} ¬∑ {lot.color}</div><button className="modal-x" onClick={close}>‚úï</button></div>
      <div className="modal-body">
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'8px',marginBottom:'14px'}}>
          {[['–ó–∞–∫—É–ø–∫–∞',fmt(lot.cost),'var(--a2)'],['–ü—Ä–æ–¥–∞–Ω–æ',fmt(totalSold),'var(--a3)'],
            ['–ü—Ä–∏–±—ã–ª—å',(profit>=0?'+':'')+fmt(profit),profit>=0?'var(--accent)':'var(--red)'],
            ['–ú–∞—Ä–∂–∞',lot.cost>0?(profit/lot.cost*100).toFixed(1)+'%':'‚Äî',profit>=0?'var(--accent)':'var(--red)'],
          ].map(([l,v,c])=><div key={l} style={{background:'var(--surf2)',borderRadius:'8px',padding:'10px 12px'}}>
            <div style={{fontSize:'.62rem',color:'var(--t3)',textTransform:'uppercase',letterSpacing:'.7px',marginBottom:'4px'}}>{l}</div>
            <div style={{fontFamily:'var(--mono)',fontWeight:700,fontSize:'.95rem',color:c}}>{v}</div>
          </div>)}
        </div>
        <div style={{display:'flex',gap:'6px',flexWrap:'wrap',marginBottom:'14px'}}>
          <span className={`pill ${sm.cls}`}>{sm.label}</span>
          {lot.date&&<span className="td">{fmtD(lot.date)}</span>}
          {lot.condition&&<span className="tag tk">–°–æ—Å—Ç–æ—è–Ω–∏–µ {lot.condition}/10</span>}
          {lot.sourceType&&<span className="tag ts">{lot.sourceType}{lot.sourceAddr?': '+lot.sourceAddr:''}</span>}
        </div>
        {pct>0&&<div style={{marginBottom:'14px'}}>
          <div style={{display:'flex',justifyContent:'space-between',marginBottom:'5px'}}>
            <span style={{fontSize:'.68rem',fontFamily:'var(--mono)',color:'var(--t3)'}}>–û—Ç–±–∏—Ç–æ</span>
            <span style={{fontSize:'.68rem',fontFamily:'var(--mono)',color:pct>=100?'var(--accent)':'var(--warn)',fontWeight:700}}>{pct.toFixed(0)}%</span>
          </div>
          <div className="prog-track" style={{height:'4px'}}><div className={`prog-fill ${pct>=100?'done':''}`} style={{width:pct+'%'}}/></div>
        </div>}
        {(lot.cartridges||[]).length>0&&<>
          <div style={{fontSize:'.65rem',fontWeight:700,textTransform:'uppercase',letterSpacing:'.8px',color:'var(--t3)',marginBottom:'8px'}}>–ö–∞—Ä—Ç—Ä–∏–¥–∂–∏</div>
          <div style={{background:'var(--surf2)',borderRadius:'8px',padding:'4px 12px',marginBottom:'14px'}}>
            {lot.cartridges.map(c=>{
              const cs=data.sales.find(s=>s.lotId===lot.id&&s.cartridgeId===c.id);
              return<div key={c.id} style={{display:'flex',alignItems:'center',padding:'6px 0',borderBottom:'1px solid var(--border)'}}>
                <span style={{flex:1,fontSize:'.82rem',color:'var(--t2)'}}>üìº {c.name}{c.inBox?' üì¶':''}</span>
                {cs?<span style={{fontFamily:'var(--mono)',fontSize:'.78rem',color:'var(--accent)'}}>+{fmt(cs.amount)}</span>
                  :<span style={{fontSize:'.65rem',color:'var(--t3)',background:'var(--surf3)',padding:'2px 7px',borderRadius:'4px'}}>–Ω–µ –ø—Ä–æ–¥–∞–Ω</span>}
              </div>;
            })}
          </div>
        </>}
        {sales.length>0&&<>
          <div style={{fontSize:'.65rem',fontWeight:700,textTransform:'uppercase',letterSpacing:'.8px',color:'var(--t3)',marginBottom:'8px'}}>–ü—Ä–æ–¥–∞–∂–∏</div>
          <div style={{background:'var(--surf2)',borderRadius:'8px',padding:'4px 12px',marginBottom:'14px'}}>
            {sales.map(s=><div key={s.id} className="sale-row">
              <div className="sale-info">
                <div className="sale-item">{s.item}</div>
                <div className="sale-meta"><span className="sale-date">{fmtD(s.date)}</span>{s.platform&&<span className="sale-plat">{s.platform}</span>}{s.method&&<span className="sale-meth">{s.method}</span>}</div>
              </div>
              <span className="sale-amt">{fmt(s.amount)}</span>
            </div>)}
          </div>
        </>}
        {lot.notes&&<div style={{fontSize:'.8rem',color:'var(--t2)',lineHeight:'1.55',fontStyle:'italic'}}>{lot.notes}</div>}
      </div>
      <div className="modal-footer">
        <button className="btn btn-g" onClick={close}>–ó–∞–∫—Ä—ã—Ç—å</button>
        <button className="btn btn-w btn-sm" onClick={()=>{close();openModal('sale',{lotId:lot.id});}}>+ –ü—Ä–æ–¥–∞–∂–∞</button>
        <button className="btn btn-a btn-sm" onClick={()=>{close();openModal('lot',{edit:lot});}}>‚úè –ò–∑–º–µ–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>;
}

function DelModal({upd,init,close}){
  const confirm=()=>{upd(d=>{d.lots=d.lots.filter(l=>l.id!==init.lotId);d.sales=d.sales.filter(s=>s.lotId!==init.lotId);return d;});close();};
  return<div className="ov" onClick={ev=>{if(ev.target.className==='ov')close();}}>
    <div className="modal" style={{maxWidth:'360px'}}>
      <div className="modal-hdr"><div className="modal-title">–£–¥–∞–ª–∏—Ç—å –ª–æ—Ç?</div><button className="modal-x" onClick={close}>‚úï</button></div>
      <div className="modal-body"><p style={{color:'var(--t2)',fontSize:'.88rem',lineHeight:'1.55'}}><strong style={{color:'var(--text)'}}>{init.name}</strong> –∏ –≤—Å–µ –ø—Ä–æ–¥–∞–∂–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –Ω–∞–≤—Å–µ–≥–¥–∞.</p></div>
      <div className="modal-footer"><button className="btn btn-g" onClick={close}>–û—Ç–º–µ–Ω–∞</button><button className="btn btn-d" onClick={confirm}>–£–¥–∞–ª–∏—Ç—å</button></div>
    </div>
  </div>;
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
