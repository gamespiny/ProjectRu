<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ConsoleFlip</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%2310b981'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='white'>üéÆ</text></svg>">
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#09090b;--surf:#18181b;--surf2:#27272a;--surf3:#3f3f46;
  --border:#3f3f46;--border2:#52525b;
  --accent:#10b981;--a2:#f43f5e;--a3:#3b82f6;--warn:#f59e0b;
  --text:#fafafa;--t2:#a1a1aa;--t3:#71717a;
  --red:#ef4444;
  --mono:'JetBrains Mono',monospace;--sans:'Inter',sans-serif;
  --r:10px;--r2:16px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body,#root{min-height:100%;font-size:17px}
body{background:var(--bg);color:var(--text);font-family:var(--sans);overflow-x:hidden;line-height:1.6}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--surf2)}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
.app{max-width:100%;margin:0 auto;padding:0 20px 90px}
@media(min-width:768px){.app{padding:0 40px 90px}}
@media(min-width:1400px){.app{padding:0 60px 90px}}
@media(min-width:1920px){.app{max-width:1800px;padding:0 80px 90px}}
/* header */
.hdr{display:flex;align-items:center;justify-content:space-between;padding:18px 0 16px;border-bottom:1px solid var(--border);margin-bottom:18px}
.logo{display:flex;align-items:center;gap:9px}
.logo-box{width:32px;height:32px;background:linear-gradient(135deg,var(--accent),var(--a3));border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.logo-name{font-family:var(--mono);font-size:.95rem;font-weight:700;color:var(--text)}
.logo-name span{color:var(--accent)}
/* stats */
.sbar{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:18px}
.sc{background:var(--surf);border:1px solid var(--border);border-radius:var(--r2);padding:12px 14px;position:relative;overflow:hidden}
.sc::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.sc.g::before{background:linear-gradient(90deg,var(--accent),transparent)}
.sc.b::before{background:linear-gradient(90deg,var(--a3),transparent)}
.sc.w::before{background:linear-gradient(90deg,var(--warn),transparent)}
.sc.r::before{background:linear-gradient(90deg,var(--a2),transparent)}
.sc-lbl{font-size:.72rem;color:var(--t3);text-transform:uppercase;letter-spacing:1px;font-weight:700;margin-bottom:8px}
.sc-val{font-family:var(--mono);font-size:1.35rem;font-weight:700;line-height:1.1}
.sc-val.g{color:var(--accent)}.sc-val.b{color:var(--a3)}.sc-val.w{color:var(--warn)}.sc-val.r{color:var(--a2)}
.sc-sub{font-size:.78rem;color:var(--t2);margin-top:5px}
/* tabs */
.tabs{display:flex;gap:3px;background:var(--surf);padding:3px;border-radius:var(--r);border:1px solid var(--border);margin-bottom:18px}
.tab{flex:1;padding:8px 6px;border:none;background:transparent;color:var(--t2);font-family:var(--sans);font-size:.78rem;font-weight:700;cursor:pointer;border-radius:7px;transition:all .15s;white-space:nowrap}
.tab.on{background:var(--surf3);color:var(--text)}
.tab:hover:not(.on){color:var(--text)}
/* lot cards */
.lot-card{background:var(--surf);border:1px solid var(--border);border-radius:var(--r2);overflow:hidden;margin-bottom:8px;transition:border-color .2s}
.lot-card:hover{border-color:var(--border2)}
.lot-card.st-partial{border-left:3px solid var(--warn)}
.lot-card.st-sold{border-left:3px solid #2d6b48}
.lot-head{display:flex;align-items:center;gap:10px;padding:13px 16px;cursor:pointer;user-select:none}
.lot-badge{font-family:var(--mono);font-size:.65rem;background:var(--surf3);color:var(--t3);padding:2px 7px;border-radius:5px;flex-shrink:0}
.lot-info{flex:1;min-width:0}
.lot-name{font-weight:800;font-size:.98rem;line-height:1.35;color:var(--text)}
.lot-sub{display:flex;align-items:center;gap:6px;margin-top:4px;flex-wrap:wrap}
.tag{display:inline-flex;align-items:center;font-size:.63rem;font-weight:700;padding:2px 7px;border-radius:20px}
.tc{background:rgba(255,216,79,.1);color:var(--warn)}
.tk{background:rgba(79,184,255,.1);color:var(--a3)}
.ts{background:rgba(79,255,176,.08);color:var(--t2)}
.ta{background:rgba(79,184,255,.12);color:var(--a3)}
.td{font-size:.63rem;color:var(--t3);font-family:var(--mono)}
.lot-right{display:flex;align-items:center;gap:8px;flex-shrink:0}
.lot-nums{text-align:right}
.lot-cost{font-family:var(--mono);font-size:.88rem;font-weight:700;color:var(--text)}
.lot-pnl{font-family:var(--mono);font-size:.7rem;margin-top:2px}
.lot-pnl.pos{color:var(--accent)}.lot-pnl.neg{color:var(--a2)}.lot-pnl.zero{color:var(--t3)}
.pill{font-size:.62rem;font-weight:800;text-transform:uppercase;letter-spacing:.5px;padding:3px 8px;border-radius:20px;white-space:nowrap}
.p-active{background:rgba(79,255,176,.1);color:var(--accent)}
.p-partial{background:rgba(255,216,79,.1);color:var(--warn)}
.p-sold{background:rgba(79,255,176,.06);color:#2d6b48}
.p-parts{background:rgba(255,79,110,.08);color:var(--red)}
.chev{color:var(--t3);font-size:.9rem;transition:transform .2s;flex-shrink:0}
.chev.open{transform:rotate(180deg)}
/* lot body */
.lot-body{border-top:1px solid var(--border)}
.prog-wrap{padding:10px 16px 0}
.prog-labels{display:flex;justify-content:space-between;margin-bottom:5px}
.prog-labels span{font-size:.68rem;font-family:var(--mono);color:var(--t3)}
.prog-pct{font-weight:700}.prog-pct.done{color:var(--accent)}.prog-pct.mid{color:var(--warn)}
.prog-track{height:3px;background:var(--surf3);border-radius:2px;overflow:hidden}
.prog-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--a3),var(--accent));transition:width .4s}
.prog-fill.done{background:var(--accent)}
.blk{padding:10px 16px}
.blk-hdr{font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);margin-bottom:8px;display:flex;align-items:center;justify-content:space-between}
.divider{height:1px;background:var(--border)}
/* cart rows */
.cart-row{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--border)}
.cart-row:last-child{border-bottom:none}
.cart-name{flex:1;font-size:.82rem;color:var(--t2)}
.cart-box-badge{font-size:.65rem;color:var(--t3);padding:1px 6px;border-radius:4px;background:var(--surf2);white-space:nowrap}
.cart-sold-badge{font-size:.65rem;color:var(--accent);background:rgba(79,255,176,.1);padding:1px 6px;border-radius:4px}
/* sale rows */
.sale-row{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)}
.sale-row:last-child{border-bottom:none}
.sale-info{flex:1;min-width:0}
.sale-item{font-size:.82rem;font-weight:600;color:var(--text)}
.sale-meta{display:flex;gap:5px;align-items:center;margin-top:2px;flex-wrap:wrap}
.sale-date{font-size:.65rem;color:var(--t3);font-family:var(--mono)}
.sale-plat{font-size:.63rem;color:var(--a3);background:rgba(79,184,255,.1);padding:1px 6px;border-radius:10px;font-weight:600}
.sale-meth{font-size:.63rem;color:var(--t3)}
.sale-amt{font-family:var(--mono);font-weight:700;font-size:.88rem;color:var(--accent);white-space:nowrap}
.lot-acts{display:flex;gap:7px;padding:10px 16px;border-top:1px solid var(--border);flex-wrap:wrap}
.lot-notes-txt{font-size:.78rem;color:var(--t2);line-height:1.55;padding:8px 16px 10px;font-style:italic}
/* buttons */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:var(--r);border:none;font-family:var(--sans);font-size:.8rem;font-weight:700;cursor:pointer;transition:all .15s;user-select:none;line-height:1}
.btn-a{background:var(--accent);color:#0d0f14}.btn-a:hover{background:#6fffbf}
.btn-g{background:transparent;color:var(--t2);border:1px solid var(--border)}.btn-g:hover{border-color:var(--a3);color:var(--a3)}
.btn-d{background:rgba(255,79,110,.12);color:var(--red);border:1px solid rgba(255,79,110,.2)}.btn-d:hover{background:rgba(255,79,110,.22)}
.btn-w{background:rgba(255,216,79,.1);color:var(--warn);border:1px solid rgba(255,216,79,.2)}.btn-w:hover{background:rgba(255,216,79,.2)}
.btn-sm{padding:5px 11px;font-size:.75rem}
.btn-xs{padding:3px 8px;font-size:.7rem;border-radius:7px}
.sec-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px}
.sec-title{font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--t2)}
.sec-cnt{font-family:var(--mono);font-size:.7rem;color:var(--t3);background:var(--surf2);padding:2px 8px;border-radius:20px}
.filter-row{display:flex;gap:7px;align-items:center;flex-wrap:wrap}
.sel-sm{background:var(--surf);border:1px solid var(--border);border-radius:8px;padding:5px 26px 5px 9px;color:var(--t2);font-size:.75rem;font-family:var(--sans);outline:none;cursor:pointer;-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%238892b0' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center}
.sel-sm option{background:var(--surf2)}
.empty{text-align:center;padding:50px 20px;color:var(--t3)}
.empty-icon{font-size:2.5rem;margin-bottom:10px;opacity:.4}
.empty-txt{font-size:.85rem}
/* overlay */
.ov{position:fixed;inset:0;background:rgba(0,0,0,.82);backdrop-filter:blur(8px);z-index:200;display:flex;align-items:flex-start;justify-content:center;padding:14px;overflow-y:auto}
.modal{background:var(--surf);border:1px solid var(--border2);border-radius:var(--r2);width:100%;max-width:520px;margin:auto;animation:mIn .18s ease}
@keyframes mIn{from{opacity:0;transform:translateY(10px) scale(.97)}to{opacity:1;transform:none}}
.modal-hdr{display:flex;align-items:center;justify-content:space-between;padding:18px 20px 0}
.modal-title{font-weight:800;font-size:1rem;color:var(--text)}
.modal-x{background:none;border:none;color:var(--t2);font-size:1.3rem;cursor:pointer;padding:2px 6px;border-radius:6px;line-height:1}
.modal-x:hover{color:var(--text);background:var(--surf2)}
.modal-body{padding:18px 20px}
.modal-footer{padding:12px 20px;display:flex;gap:8px;justify-content:flex-end;border-top:1px solid var(--border)}
/* forms */
.fr{margin-bottom:14px}
.fr label{display:block;font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--t2);margin-bottom:6px}
.fr input,.fr select,.fr textarea{width:100%;padding:9px 12px;background:var(--surf2);border:1px solid var(--border);border-radius:var(--r);color:var(--text);font-family:var(--sans);font-size:.85rem;outline:none;transition:border-color .15s;-webkit-appearance:none;appearance:none}
.fr input:focus,.fr select:focus,.fr textarea:focus{border-color:var(--accent)}
.fr select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%238892b0' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 11px center;padding-right:30px}
.fr select option{background:var(--surf2)}
.fr textarea{resize:vertical;min-height:60px}
.fr-hint{font-size:.7rem;color:var(--t3);margin-top:4px}
.fr-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.fr-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
@media(max-width:420px){.fr-2,.fr-3{grid-template-columns:1fr}}
.check-row{display:flex;align-items:center;gap:8px;cursor:pointer;padding:4px 0}
.check-row input[type=checkbox]{width:15px;height:15px;accent-color:var(--accent);cursor:pointer;flex-shrink:0}
.check-row span{font-size:.82rem;color:var(--t2)}
/* item editor (carts/accs) */
.item-ed{border:1px solid var(--border);border-radius:var(--r);overflow:hidden;margin-top:6px}
.item-ed-list{max-height:155px;overflow-y:auto}
.item-ed-row{display:flex;align-items:center;gap:8px;padding:7px 11px;border-bottom:1px solid var(--border)}
.item-ed-row:last-child{border-bottom:none}
.item-ed-name{flex:1;font-size:.8rem;color:var(--t2)}
.item-ed-badge{font-size:.65rem;color:var(--t3);background:var(--surf2);padding:1px 6px;border-radius:4px;white-space:nowrap}
.item-ed-del{background:none;border:none;color:var(--t3);cursor:pointer;padding:2px 5px;border-radius:5px;font-size:.9rem;line-height:1;flex-shrink:0}
.item-ed-del:hover{color:var(--red);background:rgba(255,79,110,.1)}
.item-add-area{padding:8px 10px;background:var(--surf2);display:flex;flex-direction:column;gap:7px}
.item-add-row{display:flex;gap:7px}
.item-add-row input{flex:1;padding:6px 10px;background:var(--surf3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--sans);font-size:.82rem;outline:none;min-width:0}
.item-add-row input:focus{border-color:var(--accent)}
.item-add-btn{background:var(--surf3);border:1px solid var(--border);color:var(--accent);border-radius:8px;padding:6px 12px;cursor:pointer;font-size:1rem;transition:all .15s;flex-shrink:0}
.item-add-btn:hover{background:rgba(79,255,176,.1)}
.inline-sell{background:var(--surf2);border:1px solid var(--border);border-radius:8px;padding:10px;margin-top:5px;display:flex;flex-direction:column;gap:8px}
.is-row{display:flex;gap:7px}
.is-row input,.is-row select{flex:1;padding:6px 10px;background:var(--surf3);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:var(--sans);font-size:.82rem;outline:none;min-width:0;-webkit-appearance:none;appearance:none}
.is-row input:focus,.is-row select:focus{border-color:var(--accent)}
/* stats */
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
@media(max-width:500px){.stat-grid{grid-template-columns:1fr}}
.stat-blk{background:var(--surf);border:1px solid var(--border);border-radius:var(--r2);padding:15px}
.stat-blk-title{font-size:.67rem;font-weight:700;text-transform:uppercase;letter-spacing:.9px;color:var(--t3);margin-bottom:12px}
.stat-line{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border)}
.stat-line:last-child{border-bottom:none}
.stat-ln-lbl{font-size:.8rem;color:var(--t2)}
.stat-ln-val{font-family:var(--mono);font-weight:700;font-size:.85rem}
.month-chart{background:var(--surf);border:1px solid var(--border);border-radius:var(--r2);padding:15px;margin-bottom:14px}
.month-title{font-size:.67rem;font-weight:700;text-transform:uppercase;letter-spacing:.9px;color:var(--t3);margin-bottom:14px}
.month-bars{display:flex;align-items:flex-end;gap:5px;height:80px}
.month-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;height:100%;justify-content:flex-end}
.month-bar{width:100%;border-radius:3px 3px 0 0;background:linear-gradient(180deg,var(--a3),rgba(79,184,255,.25));min-height:2px}
.month-lbl{font-size:.58rem;color:var(--t3);font-family:var(--mono)}
.month-val{font-size:.58rem;color:var(--t3);font-family:var(--mono)}
.open-lot-row{display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid var(--border)}
.open-lot-row:last-child{border-bottom:none}
.open-lot-name{flex:1;font-size:.8rem;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text)}
.open-lot-remains{font-family:var(--mono);font-size:.75rem;color:var(--t3);white-space:nowrap}
.open-bar{width:50px;height:3px;background:var(--surf3);border-radius:2px;overflow:hidden;flex-shrink:0}
.open-fill{height:100%;background:var(--warn);border-radius:2px}
/* history */
.hist-card{background:var(--surf);border:1px solid var(--border);border-radius:var(--r2);padding:12px 15px;display:flex;align-items:center;gap:10px;margin-bottom:7px;cursor:pointer;transition:border-color .15s}
.hist-card:hover{border-color:var(--a3)}
.hist-icon{width:30px;height:30px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:13px;background:rgba(79,255,176,.08);flex-shrink:0}
.hist-info{flex:1;min-width:0}
.hist-name{font-size:.85rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--text)}
.hist-sub{font-size:.7rem;color:var(--t3);margin-top:2px}
.hist-amt{font-family:var(--mono);font-weight:700;font-size:.9rem;color:var(--accent);white-space:nowrap}
/* accs tab */
.acc-tab-row{display:flex;align-items:center;gap:10px;padding:9px 15px;border-bottom:1px solid var(--border)}
.acc-tab-row:last-child{border-bottom:none}
.acc-tab-icon{font-size:1rem;flex-shrink:0}
.acc-tab-info{flex:1;min-width:0}
.acc-tab-name{font-size:.83rem;font-weight:600;color:var(--text)}
.acc-tab-sub{font-size:.7rem;color:var(--t3);margin-top:2px}
.acc-tab-type{font-size:.72rem;color:var(--t3);white-space:nowrap}
@media(max-width:600px){
  .sbar{grid-template-columns:repeat(2,1fr)}
  .lot-badge{display:none}
  .lot-head{padding:11px 13px;flex-direction:column;gap:10px}
  .lot-right{width:100%;flex-direction:column;align-items:stretch}
  .lot-right>div:first-child{display:grid!important;grid-template-columns:repeat(3,1fr)!important;gap:8px!important;width:100%}
  .lot-right .pill{margin-left:0!important;align-self:flex-start}
  .hdr{flex-direction:column;gap:10px;align-items:flex-start}
  .hdr>div:last-child{width:100%;flex-wrap:wrap}
}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useMemo,useCallback}=React;


const CONSOLES=['Nintendo Switch OLED','Nintendo Switch Lite','Nintendo Switch Rev2','–î—Ä—É–≥–∞—è –∫–æ–Ω—Å–æ–ª—å'];
const COLORS={
  'Nintendo Switch OLED':['–ë–µ–ª—ã–π','–ù–µ–æ–Ω','Zelda Edition','Mario Edition','Pokemon Edition','–î—Ä—É–≥–æ–π'],
  'Nintendo Switch Lite':['–ë–∏—Ä—é–∑–æ–≤—ã–π','–°–∏–Ω–∏–π','–ñ—ë–ª—Ç—ã–π','–°–µ—Ä—ã–π','–ö–æ—Ä–∞–ª–ª–æ–≤—ã–π','–î—Ä—É–≥–æ–π'],
  'Nintendo Switch Rev2':['–ù–µ–æ–Ω','–°–µ—Ä—ã–π','Fortnite Edition','Diablo Edition','Mario Edition'],
  '–î—Ä—É–≥–∞—è –∫–æ–Ω—Å–æ–ª—å':['–î—Ä—É–≥–æ–π'],
};
const SOURCES=['–î–æ—Å—Ç–∞–≤–∫–∞','–õ–æ–º–±–∞—Ä–¥','–°–∞–º–æ–≤—ã–≤–æ–∑'];
const SALE_METHODS=['–°–∞–º–æ–≤—ã–≤–æ–∑','–î–æ—Å—Ç–∞–≤–∫–∞'];
const PAYMENT=['–ü–µ—Ä–µ–≤–æ–¥','–ù–∞–ª–∏—á–Ω—ã–µ','–ê–≤–∏—Ç–æ –î–æ—Å—Ç–∞–≤–∫–∞','–Æ–ú–∞–Ω–∏','–î—Ä—É–≥–æ–µ'];
const PAYMENT_REPAIR=['–ù–∞–ª–∏—á–Ω—ã–µ','–ö–∞—Ä—Ç–∞','–ü–µ—Ä–µ–≤–æ–¥','–î—Ä—É–≥–æ–µ'];
const ACC_TYPES={joy:'üïπ –î–∂–æ–π–∫–æ–Ω',charger:'üîå –ó–∞—Ä—è–¥–∫–∞',case:'üéí –ö–µ–π—Å',other:'üì¶ –î—Ä—É–≥–æ–µ'};
const STATUS_META={
  active:{label:'–í –Ω–∞–ª–∏—á–∏–∏',cls:'p-active'},
  partial:{label:'–ß–∞—Å—Ç–∏—á–Ω–æ',cls:'p-partial'},
  sold:{label:'–ü—Ä–æ–¥–∞–Ω ‚úì',cls:'p-sold'},
  parts:{label:'–ù–∞ –∑–∞–ø—á–∞—Å—Ç–∏',cls:'p-parts'},
};
const REPAIR_SERVICES=['–ü—Ä–æ—à–∏–≤–∫–∞','–†–µ–º–æ–Ω—Ç','–ù–∞—Å—Ç—Ä–æ–π–∫–∞','–ß–∏—Å—Ç–∫–∞','–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞','–î—Ä—É–≥–æ–µ'];
const REPAIR_STATUS={
  pending:{label:'–û–∂–∏–¥–∞–Ω–∏–µ',cls:'p-partial',icon:'‚è≥'},
  in_progress:{label:'–í —Ä–∞–±–æ—Ç–µ',cls:'p-active',icon:'üîß'},
  completed:{label:'–ì–æ—Ç–æ–≤–æ',cls:'p-sold',icon:'‚úÖ'},
  paid:{label:'–û–ø–ª–∞—á–µ–Ω–æ',cls:'p-sold',icon:'üí∞'},
};
const CLIENT_SOURCES=['–ê–≤–∏—Ç–æ','–í–ö–æ–Ω—Ç–∞–∫—Ç–µ','–°–∞—Ä–∞—Ñ–∞–Ω','–î—Ä—É–≥–æ–µ'];
const MONTHS_RU=['–Ø–Ω–≤','–§–µ–≤','–ú–∞—Ä','–ê–ø—Ä','–ú–∞–π','–ò—é–Ω','–ò—é–ª','–ê–≤–≥','–°–µ–Ω','–û–∫—Ç','–ù–æ—è','–î–µ–∫'];
const MONTHS_FULL=['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];

const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,6);
const fmt=n=>(n==null||isNaN(n))?'‚Äî':new Intl.NumberFormat('ru-RU').format(Math.round(n))+' ‚ÇΩ';
const fmtS=n=>(n==null||isNaN(n))?'‚Äî':new Intl.NumberFormat('ru-RU').format(Math.round(n))+' ‚ÇΩ';
const fmtD=d=>{if(!d)return'';const dt=new Date(d);return dt.toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit',year:'2-digit'});};
const todayStr=()=>new Date().toISOString().slice(0,10);
const mKey=d=>d?d.slice(0,7):'';
const daysOnHand=(purchaseDate)=>{if(!purchaseDate)return 0;const now=new Date();const then=new Date(purchaseDate);return Math.floor((now-then)/(1000*60*60*24));};
const lotSales=(sales,lotId)=>sales.filter(s=>s.lotId===lotId);
const lotSalesTotal=(sales,lotId)=>lotSales(sales,lotId).reduce((s,x)=>s+(x.amount||0),0);
const computeStatus=(lot,sales)=>{
  if(lot.status==='parts')return'parts';
  const sold=lotSalesTotal(sales,lot.id);
  if(sold<=0)return'active';
  if(sold<(lot.cost||0))return'partial';
  return'sold';
};

// ‚îÄ‚îÄ GOOGLE DRIVE STORAGE (—á–µ—Ä–µ–∑ Netlify Functions) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const GD = {
  CLIENT_ID: null, // –ë—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω —Å —Å–µ—Ä–≤–µ—Ä–∞
  SCOPES:    'https://www.googleapis.com/auth/drive.appdata',
  FILE_NAME: 'consolefliip_data.json',
  _fileId:   null,
  _token:    null,

  async _callFunction(action, extraData = {}) {
    const response = await fetch('/.netlify/functions/google-drive', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action,
        token: this._token,
        fileId: this._fileId,
        ...extraData
      })
    });
    if (!response.ok) throw new Error('Function call failed');
    return await response.json();
  },

  async init(onReady, onNeedAuth) {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º CLIENT_ID —Å —Å–µ—Ä–≤–µ—Ä–∞
    try {
      const result = await this._callFunction('get_client_id');
      this.CLIENT_ID = result.clientId;
    } catch (e) {
      console.error('Failed to get CLIENT_ID:', e);
      onNeedAuth();
      return;
    }

    // Try restore token from localStorage
    const saved = localStorage.getItem('gd_token');
    if (saved) {
      const t = JSON.parse(saved);
      if (t.expiry > Date.now()) {
        this._token = t.access_token;
        try { const d = await this.load(); onReady(d); return; } catch(e) {}
      }
    }
    onNeedAuth();
  },

  signIn(cb) {
    const client = google.accounts.oauth2.initTokenClient({
      client_id: this.CLIENT_ID,
      scope: this.SCOPES,
      callback: async (resp) => {
        if (resp.error) { cb(null, resp.error); return; }
        this._token = resp.access_token;
        localStorage.setItem('gd_token', JSON.stringify({
          access_token: resp.access_token,
          expiry: Date.now() + (resp.expires_in - 60) * 1000
        }));
        const d = await this.load();
        cb(d);
      }
    });
    client.requestAccessToken();
  },

  signOut() {
    this._token = null;
    this._fileId = null;
    localStorage.removeItem('gd_token');
  },

  async _findFile() {
    if (this._fileId) return this._fileId;
    const result = await this._callFunction('search');
    this._fileId = result.files?.[0]?.id || null;
    return this._fileId;
  },

  async load() {
    const fid = await this._findFile();
    if (!fid) return null;
    const result = await this._callFunction('get');
    return result;
  },

  async save(data) {
    if (!this._token) return;
    let fid = await this._findFile();
    if (fid) {
      await this._callFunction('update', { data });
    } else {
      const result = await this._callFunction('create');
      this._fileId = result.id;
      await this._callFunction('update', { data });
    }
  }
};

// Fallback to localStorage when no Google credentials configured
const USE_GD = true; // Netlify –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Google Drive
const SKEY='cf_v3';
const loadState=()=>{try{const r=localStorage.getItem(SKEY);if(r)return JSON.parse(r);}catch(e){}return null;};
const saveState=s=>{
  try{localStorage.setItem(SKEY,JSON.stringify(s));}catch(e){}
  if(USE_GD) GD.save(s).catch(()=>{});
};

const makeDemoData=()=>{
  const id1=uid(),id2=uid(),id3=uid();
  return{
    lots:[
      {id:id1,console:'Nintendo Switch OLED',color:'–ë–µ–ª—ã–π',cost:16500,date:'2025-01-10',sourceType:'–î–æ—Å—Ç–∞–≤–∫–∞',sourceAddr:'',condition:8,status:'active',notes:'–°–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–ª–∏—á–Ω–æ–µ',
       cartridges:[{id:uid(),name:'Zelda: Breath of the Wild',inBox:true},{id:uid(),name:'Mario Kart 8 Deluxe',inBox:false}],
       accessories:[{id:uid(),name:'Joy-Con Neon',type:'joy'}],createdAt:'2025-01-10T10:00:00'},
      {id:id2,console:'Nintendo Switch Lite',color:'–°–∏–Ω–∏–π',cost:9800,date:'2025-01-20',sourceType:'–õ–æ–º–±–∞—Ä–¥',sourceAddr:'',condition:7,status:'active',notes:'',
       cartridges:[{id:uid(),name:'Animal Crossing',inBox:true}],
       accessories:[{id:uid(),name:'–ö–µ–π—Å Orzly',type:'case'}],createdAt:'2025-01-20T10:00:00'},
      {id:id3,console:'Nintendo Switch Rev2',color:'–ù–µ–æ–Ω',cost:12000,date:'2025-02-03',sourceType:'–°–∞–º–æ–≤—ã–≤–æ–∑',sourceAddr:'—É–ª. –õ–µ–Ω–∏–Ω–∞ 15',condition:9,status:'active',notes:'',
       cartridges:[],accessories:[],createdAt:'2025-02-03T10:00:00'},
    ],
    sales:[
      {id:uid(),lotId:id1,item:'Switch OLED –∫–æ–Ω—Å–æ–ª—å',amount:15000,date:'2025-01-18',platform:'–ê–≤–∏—Ç–æ',pay:'–ü–µ—Ä–µ–≤–æ–¥',method:'–î–æ—Å—Ç–∞–≤–∫–∞',note:'',createdAt:'2025-01-18T10:00:00'},
      {id:uid(),lotId:id1,item:'Joy-Con Neon',amount:3200,date:'2025-01-22',platform:'–ê–≤–∏—Ç–æ',pay:'–ù–∞–ª–∏—á–Ω—ã–µ',method:'–°–∞–º–æ–≤—ã–≤–æ–∑',note:'',createdAt:'2025-01-22T10:00:00'},
      {id:uid(),lotId:id2,item:'Switch Lite + –∫–µ–π—Å',amount:9000,date:'2025-01-26',platform:'–Æ–ª–∞',pay:'–Æ–ú–∞–Ω–∏',method:'–î–æ—Å—Ç–∞–≤–∫–∞',note:'–°–∫–∏–¥–∫–∞ 800‚ÇΩ',createdAt:'2025-01-26T10:00:00'},
    ],
    cartridgeDb:[],
  };
};

function App(){
  const[data,setData]=useState(()=>({lots:[],sales:[],accessories:[],cartridgeDb:[],repairs:[]})); // –î–æ–±–∞–≤–ª–µ–Ω–æ repairs
  const[module,setModule]=useState('resale'); // resale | repair
  const[tab,setTab]=useState('lots');
  const[modal,setModal]=useState(null);
  const[expanded,setExpanded]=useState(new Set());
  const[fStatus,setFStatus]=useState('');
  const[fMonth,setFMonth]=useState(()=>mKey(todayStr()));
  const[hMonth,setHMonth]=useState('');
  // –§–∏–ª—å—Ç—Ä—ã —Ä–µ–º–æ–Ω—Ç–∞ (–ø–æ–¥–Ω—è—Ç—ã –≤ App –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏)
  const[rMonth,setRMonth]=useState(()=>mKey(todayStr()));
  const[rService,setRService]=useState('');
  const[rStatus,setRStatus]=useState('');
  const[rSort,setRSort]=useState('date');
  const[gdStatus,setGdStatus]=useState(USE_GD?'init':'off');
  const[gdMsg,setGdMsg]=useState('');
  const[lastSaved,setLastSaved]=useState(null);

  // Init Google Drive on mount
  useEffect(()=>{
    if(!USE_GD)return;
    GD.init(
      (remoteData)=>{
        if(remoteData){
          setData(remoteData);
          localStorage.setItem(SKEY,JSON.stringify(remoteData));
        } else {
          // –ï—Å–ª–∏ –≤ Google Drive –ø—É—Å—Ç–æ - –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage –∏–ª–∏ –¥–µ–º–æ
          const localData = loadState();
          if(localData) {
            setData(localData);
          } else {
            const demoData = makeDemoData();
            setData(demoData);
            saveState(demoData);
          }
        }
        setGdStatus('ok');
        setLastSaved(new Date());
      },
      ()=>setGdStatus('need_auth')
    );
  },[]);

  const gdSignIn=()=>{
    setGdStatus('syncing');
    GD.signIn((remoteData,err)=>{
      if(err){setGdStatus('error');setGdMsg('–û—à–∏–±–∫–∞: '+err);return;}
      if(remoteData){
        setData(remoteData);
        localStorage.setItem(SKEY,JSON.stringify(remoteData));
      } else {
        GD.save(data).catch(()=>{});
      }
      setGdStatus('ok');
      setLastSaved(new Date());
    });
  };

  const gdSignOut=()=>{GD.signOut();setGdStatus('need_auth');};

  const upd=useCallback(fn=>{
    setData(d=>{
      const nd=fn(JSON.parse(JSON.stringify(d)));
      saveState(nd);
      if(USE_GD&&GD._token){
        setGdStatus('syncing');
        GD.save(nd).then(()=>{setGdStatus('ok');setLastSaved(new Date());}).catch(()=>setGdStatus('error'));
      }
      return nd;
    });
  },[]);
  const toggleLot=id=>setExpanded(s=>{const n=new Set(s);n.has(id)?n.delete(id):n.add(id);return n;});
  const openModal=(type,d={})=>setModal({type,d});
  const closeModal=()=>setModal(null);

  const[headerPeriod,setHeaderPeriod]=useState('month'); // month | year | all
  const curMonth=useMemo(()=>mKey(todayStr()),[]);
  const curYear=useMemo(()=>todayStr().slice(0,4),[]);

  const stats=useMemo(()=>{
    // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –ø–µ—Ä–∏–æ–¥—É –¥–ª—è —à–∞–ø–∫–∏
    let filtLots=data.lots;
    let filtSales=data.sales;
    if(headerPeriod==='month'){
      filtSales=data.sales.filter(s=>mKey(s.date)===curMonth);
      const ids=new Set(filtSales.map(s=>s.lotId));
      filtLots=data.lots.filter(l=>ids.has(l.id));
    } else if(headerPeriod==='year'){
      filtSales=data.sales.filter(s=>s.date&&s.date.startsWith(curYear));
      const ids=new Set(filtSales.map(s=>s.lotId));
      filtLots=data.lots.filter(l=>ids.has(l.id));
    }
    const invested=filtLots.reduce((s,l)=>s+(l.cost||0),0);
    const revenue=filtSales.reduce((s,x)=>s+(x.amount||0),0);
    const promoCosts=filtSales.reduce((s,x)=>s+(x.promoCost||0),0);
    const profit=revenue-invested-promoCosts;
    const margin=invested>0?profit/invested*100:0;
    // –î–ª—è "–Ω–µ –∑–∞–∫—Ä—ã—Ç–æ" –≤—Å–µ–≥–¥–∞ –≤—Å–µ –ª–æ—Ç—ã
    const openLots=data.lots.filter(l=>computeStatus(l,data.sales)!=='sold');
    const frozen=openLots.reduce((s,l)=>s+Math.max(0,(l.cost||0)-lotSalesTotal(data.sales,l.id)),0);
    return{invested,revenue,profit,margin,frozen,openCount:openLots.length,promoCosts};
  },[data,headerPeriod,curMonth,curYear]);

  const lotMonths=useMemo(()=>[...new Set(data.lots.map(l=>mKey(l.date)).filter(Boolean))].sort().reverse(),[data.lots]);
  const saleMonths=useMemo(()=>[...new Set(data.sales.map(s=>mKey(s.date)).filter(Boolean))].sort().reverse(),[data.sales]);
  const cartDb=useMemo(()=>{const n=new Set(data.cartridgeDb||[]);data.lots.forEach(l=>(l.cartridges||[]).forEach(c=>n.add(c.name)));return[...n].sort();},[data]);

  // –ï—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
  if (USE_GD && gdStatus === 'need_auth') {
    return <div style={{
      display: 'flex',
      flexDirection: 'column',
      alignItems: 'center',
      justifyContent: 'center',
      minHeight: '100vh',
      background: 'var(--bg)',
      padding: '20px'
    }}>
      <div style={{
        background: 'var(--surf)',
        border: '1px solid var(--border)',
        borderRadius: 'var(--r2)',
        padding: '40px',
        maxWidth: '400px',
        textAlign: 'center'
      }}>
        <div style={{fontSize: '3rem', marginBottom: '20px'}}>üéÆ</div>
        <div style={{
          fontFamily: 'var(--mono)',
          fontSize: '1.5rem',
          fontWeight: 700,
          marginBottom: '10px',
          color: 'var(--text)'
        }}>Console<span style={{color: 'var(--accent)'}}>Flip</span></div>
        <div style={{
          fontSize: '.9rem',
          color: 'var(--t2)',
          marginBottom: '30px',
          lineHeight: '1.5'
        }}>–¢—Ä–µ–∫–µ—Ä –ø–æ–∫—É–ø–æ–∫ –∏ –ø—Ä–æ–¥–∞–∂ –∏–≥—Ä–æ–≤—ã—Ö –ø—Ä–∏—Å—Ç–∞–≤–æ–∫</div>
        {gdStatus === 'syncing' ? (
          <div style={{fontSize: '.85rem', color: 'var(--t3)'}}>
            <span style={{display: 'inline-block', animation: 'spin .8s linear infinite'}}>‚ü≥</span> –ó–∞–≥—Ä—É–∑–∫–∞...
          </div>
        ) : (
          <button 
            className="btn btn-a" 
            onClick={gdSignIn}
            style={{width: '100%', padding: '12px'}}
          >
            ‚òÅÔ∏è –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
          </button>
        )}
      </div>
    </div>;
  }

  return<div className="app">
    {/* GOOGLE DRIVE AUTH BANNER */}
    {USE_GD&&gdStatus==='need_auth'&&<div style={{background:'rgba(255,216,79,.08)',border:'1px solid rgba(255,216,79,.2)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:'12px',display:'flex',alignItems:'center',gap:'10px',flexWrap:'wrap'}}>
      <span style={{fontSize:'.82rem',color:'var(--warn)',flex:1}}>‚òÅÔ∏è –í–æ–π–¥–∏ —á–µ—Ä–µ–∑ Google —á—Ç–æ–±—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏</span>
      <button className="btn btn-w btn-sm" onClick={gdSignIn}>–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
    </div>}
    {USE_GD&&gdStatus==='error'&&<div style={{background:'rgba(255,79,110,.08)',border:'1px solid rgba(255,79,110,.2)',borderRadius:'var(--r)',padding:'10px 14px',marginBottom:'12px',fontSize:'.8rem',color:'var(--red)'}}>
      ‚ö†Ô∏è {gdMsg} ‚Äî –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ
    </div>}

    <div className="hdr">
      <div className="logo"><div className="logo-box">üéÆ</div><div className="logo-name">Console<span>Flip</span></div></div>
      <div style={{display:'flex',alignItems:'center',gap:'8px'}}>
        {/* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –º–æ–¥—É–ª–µ–π */}
        <div style={{display:'flex',gap:'4px',background:'var(--surf2)',padding:'3px',borderRadius:'8px',marginRight:'8px'}}>
          <button onClick={()=>{setModule('resale');setTab('lots');}} style={{padding:'6px 14px',background:module==='resale'?'var(--surf3)':'transparent',border:'none',borderRadius:'6px',color:module==='resale'?'var(--text)':'var(--t3)',fontSize:'.8rem',fontWeight:600,cursor:'pointer',fontFamily:'var(--sans)'}}>üíº –ü–µ—Ä–µ–ø—Ä–æ–¥–∞–∂–∞</button>
          <button onClick={()=>{setModule('repair');setTab('orders');}} style={{padding:'6px 14px',background:module==='repair'?'var(--surf3)':'transparent',border:'none',borderRadius:'6px',color:module==='repair'?'var(--text)':'var(--t3)',fontSize:'.8rem',fontWeight:600,cursor:'pointer',fontFamily:'var(--sans)'}}>üîß –†–µ–º–æ–Ω—Ç</button>
        </div>
        {USE_GD&&gdStatus==='ok'&&<div style={{display:'flex',alignItems:'center',gap:'5px',fontSize:'.68rem',color:'var(--t3)',cursor:'pointer'}} onClick={gdSignOut} title="–í—ã–π—Ç–∏ –∏–∑ Google">
          <span style={{width:'6px',height:'6px',borderRadius:'50%',background:'var(--accent)',display:'inline-block'}}/>
          <span>Google Drive</span>
        </div>}
        {USE_GD&&gdStatus==='syncing'&&<div style={{fontSize:'.68rem',color:'var(--t3)'}}>
          <span style={{display:'inline-block',animation:'spin .8s linear infinite'}}>‚ü≥</span> —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...
        </div>}
        {USE_GD&&gdStatus==='need_auth'&&<button className="btn btn-g btn-sm" onClick={gdSignIn} style={{fontSize:'.72rem',padding:'5px 10px'}}>‚òÅÔ∏è –í–æ–π—Ç–∏</button>}
        {module==='resale'&&<button className="btn btn-a" onClick={()=>openModal('lot',{})}>+ –õ–æ—Ç</button>}
        {module==='repair'&&<button className="btn btn-a" onClick={()=>openModal('repair',{})}>+ –ó–∞–∫–∞–∑</button>}
      </div>
    </div>
    <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'12px'}}>
      {module==='resale'&&<div style={{display:'flex',gap:'4px',background:'var(--surf2)',padding:'3px',borderRadius:'8px'}}>
        {[['month','–ú–µ—Å—è—Ü'],['year','–ì–æ–¥'],['all','–í—Å—ë –≤—Ä–µ–º—è']].map(([k,l])=>(
          <button key={k} onClick={()=>setHeaderPeriod(k)} style={{padding:'5px 14px',background:headerPeriod===k?'var(--surf3)':'transparent',border:'none',borderRadius:'6px',color:headerPeriod===k?'var(--text)':'var(--t3)',fontSize:'.78rem',fontWeight:600,cursor:'pointer',fontFamily:'var(--sans)'}}>{l}</button>
        ))}
      </div>}
      {module==='repair'&&<div/>}
      <div style={{fontSize:'.72rem',color:'var(--t3)'}}>
        {module==='resale'&&headerPeriod==='month'&&MONTHS_FULL[parseInt(curMonth.split('-')[1])-1]+' '+curMonth.split('-')[0]}
        {module==='resale'&&headerPeriod==='year'&&curYear+' –≥–æ–¥'}
        {module==='resale'&&headerPeriod==='all'&&'–ó–∞ –≤—Å—ë –≤—Ä–µ–º—è'}
      </div>
    </div>
    <div className="sbar">
      {module==='resale'&&[
        ['g',stats.profit>=0?'g':'r','–ü—Ä–∏–±—ã–ª—å',fmtS(stats.profit),(stats.margin>=0?'+':'')+stats.margin.toFixed(1)+'% –º–∞—Ä–∂–∞'],
        ['b','b','–í—ã—Ä—É—á–∫–∞',fmtS(stats.revenue),data.sales.length+' —Å–¥–µ–ª–æ–∫'],
        ['w','w','–ù–µ –∑–∞–∫—Ä—ã—Ç–æ',stats.openCount+'','‚àí'+fmtS(stats.frozen)],
        ['r','r','–í–ª–æ–∂–µ–Ω–æ',fmtS(stats.invested),data.lots.length+' –ª–æ—Ç–æ–≤'],
      ].map(([bc,vc,lbl,val,sub])=><div key={lbl} className={`sc ${bc}`}>
        <div className="sc-lbl">{lbl}</div>
        <div className={`sc-val ${vc}`}>{val}</div>
        <div className="sc-sub">{sub}</div>
      </div>)}
      {module==='repair'&&(()=>{
        const repairs=(data.repairs||[]).filter(r=>!rMonth||mKey(r.date)===rMonth).filter(r=>!rService||r.service===rService);
        const totalIncome=repairs.reduce((s,r)=>s+(r.income||0)+(r.additionalIncome||0),0);
        const totalExpenses=repairs.reduce((s,r)=>s+(r.expenses||0),0);
        const totalDeductions=repairs.reduce((s,r)=>s+(r.deductions||0),0);
        const totalAdCost=repairs.reduce((s,r)=>s+(r.adCost||0),0);
        const netProfit=totalIncome-totalExpenses-totalDeductions-totalAdCost;
        const inProgress=repairs.filter(r=>r.status==='in_progress').length;
        const pending=repairs.filter(r=>r.status==='pending').length;
        return[['g',netProfit>=0?'g':'r','–ü—Ä–∏–±—ã–ª—å',fmtS(netProfit),totalIncome>0?((netProfit/totalIncome*100).toFixed(1)+'% –º–∞—Ä–∂–∞'):'‚Äî'],
          ['b','b','–î–æ—Ö–æ–¥',fmtS(totalIncome),repairs.length+' –∑–∞–∫–∞–∑–æ–≤'],
          ['w','w','–í —Ä–∞–±–æ—Ç–µ',inProgress+'',pending?`${pending} –æ–∂–∏–¥–∞–µ—Ç`:'‚Äî'],
          ['r','r','–ó–∞—Ç—Ä–∞—Ç—ã',fmtS(totalExpenses+totalDeductions),'—Ä–∞—Å—Ö–æ–¥—ã + –æ—Ç—á–∏—Å–ª–µ–Ω–∏—è'],
        ].map(([bc,vc,lbl,val,sub])=><div key={lbl} className={`sc ${bc}`}>
          <div className="sc-lbl">{lbl}</div>
          <div className={`sc-val ${vc}`}>{val}</div>
          <div className="sc-sub">{sub}</div>
        </div>);
      })()}
    </div>
    
    {/* –£–ú–ù–´–ï –ü–û–î–°–ö–ê–ó–ö–ò */}
    {module==='resale'&&data.lots.length>0&&(() => {
      const insights=[];
      const openLots=data.lots.filter(l=>computeStatus(l,data.sales)!=='sold');
      
      // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–æ –∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª
      if(stats.frozen>5000){
        insights.push({icon:'üí∞',text:`–ó–∞–º–æ—Ä–æ–∂–µ–Ω–æ ${fmtS(stats.frozen)} –≤ ${stats.openCount} –Ω–µ–ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö ${stats.openCount===1?'–ª–æ—Ç–µ':stats.openCount<5?'–ª–æ—Ç–∞—Ö':'–ª–æ—Ç–∞—Ö'}`,type:'warn'});
      }
      
      // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–æ –∑–∞–ª–µ–∂–∞–≤—à–∏–µ—Å—è –ª–æ—Ç—ã
      const oldLots=openLots.filter(l=>daysOnHand(l.date)>14);
      if(oldLots.length>0){
        const oldest=oldLots.sort((a,b)=>daysOnHand(b.date)-daysOnHand(a.date))[0];
        const days=daysOnHand(oldest.date);
        insights.push({icon:'‚è±',text:`${oldest.console} ${oldest.color} –ª–µ–∂–∏—Ç ${days} ${days<5?'–¥–Ω—è':'–¥–Ω–µ–π'}. –ú–æ–∂–µ—Ç —Å–Ω–∏–∑–∏—Ç—å —Ü–µ–Ω—É –∏–ª–∏ –ø–æ–¥–Ω—è—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?`,type:'warn'});
      }
      
      // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–æ —Å—Ä–µ–¥–Ω–∏–π —Å—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏
      const soldLots=data.lots.filter(l=>computeStatus(l,data.sales)==='sold');
      if(soldLots.length>=3){
        const avgDays=soldLots.reduce((sum,l)=>{
          const firstSale=data.sales.find(s=>s.lotId===l.id&&s.item.toLowerCase().includes('–∫–æ–Ω—Å–æ–ª—å'));
          if(firstSale){
            const daysDiff=Math.floor((new Date(firstSale.date)-new Date(l.date))/(1000*60*60*24));
            return sum+daysDiff;
          }
          return sum;
        },0)/soldLots.length;
        if(avgDays>0){
          insights.push({icon:'üìä',text:`–°—Ä–µ–¥–Ω–∏–π —Å—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏: ${Math.round(avgDays)} ${avgDays<5?'–¥–Ω—è':'–¥–Ω–µ–π'}`,type:'info'});
        }
      }
      
      if(insights.length===0)return null;
      
      return<div style={{background:'var(--surf)',border:'1px solid var(--border)',borderRadius:'var(--r2)',padding:'12px 16px',marginBottom:'18px'}}>
        <div style={{fontSize:'.7rem',fontWeight:700,textTransform:'uppercase',letterSpacing:'.8px',color:'var(--t3)',marginBottom:'10px'}}>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏</div>
        {insights.map((ins,i)=><div key={i} style={{display:'flex',alignItems:'center',gap:'10px',padding:'8px 0',borderBottom:i<insights.length-1?'1px solid var(--border)':'none'}}>
          <span style={{fontSize:'1.2rem'}}>{ins.icon}</span>
          <span style={{fontSize:'.85rem',color:ins.type==='warn'?'var(--warn)':'var(--t2)',lineHeight:'1.5'}}>{ins.text}</span>
        </div>)}
      </div>;
    })()}
    
    <div className="tabs">
      {module==='resale'&&[['lots','–õ–æ—Ç—ã'],['sales','–ò—Å—Ç–æ—Ä–∏—è'],['stats','–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'],['accs','–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã']].map(([k,l])=>(
        <button key={k} className={`tab ${tab===k?'on':''}`} onClick={()=>setTab(k)}>{l}</button>
      ))}
      {module==='repair'&&[['orders','–ó–∞–∫–∞–∑—ã'],['repair-stats','–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞']].map(([k,l])=>(
        <button key={k} className={`tab ${tab===k?'on':''}`} onClick={()=>setTab(k)}>{l}</button>
      ))}
    </div>
    
    {/* –ú–û–î–£–õ–¨ –ü–ï–†–ï–ü–†–û–î–ê–ñ–ò */}
    {module==='resale'&&<>
      {tab==='lots'&&<LotsTab data={data} upd={upd} expanded={expanded} toggleLot={toggleLot}
        openModal={openModal} fStatus={fStatus} setFStatus={setFStatus}
        fMonth={fMonth} setFMonth={setFMonth} lotMonths={lotMonths} cartDb={cartDb}/>}
      {tab==='sales'&&<HistTab data={data} hMonth={hMonth} setHMonth={setHMonth}
        saleMonths={saleMonths} openModal={openModal}/>}
      {tab==='stats'&&<StatsTab data={data} stats={stats}/>}
      {tab==='accs'&&<AccsTab data={data}/>}
    </>}
    
    {/* –ú–û–î–£–õ–¨ –†–ï–ú–û–ù–¢–ê */}
    {module==='repair'&&<>
      {tab==='orders'&&<OrdersTab data={data} upd={upd} openModal={openModal}
        fMonth={rMonth} setFMonth={setRMonth} fService={rService} setFService={setRService}
        fStatus={rStatus} setFStatus={setRStatus} sortBy={rSort} setSortBy={setRSort}/>}
      {tab==='repair-stats'&&<RepairStatsTab data={data} fMonth={rMonth} setFMonth={setRMonth}
        fService={rService} setFService={setRService}/>}
    </>}
    
    {modal?.type==='lot'&&<LotModal data={data} upd={upd} init={modal.d} cartDb={cartDb} close={closeModal}/>}
    {modal?.type==='sale'&&<SaleModal data={data} upd={upd} init={modal.d} close={closeModal}/>}
    {modal?.type==='repair'&&<RepairModal data={data} upd={upd} init={modal.d} close={closeModal}/>}
    {modal?.type==='del'&&<DelModal upd={upd} init={modal.d} close={closeModal}/>}
    {modal?.type==='view'&&<ViewModal data={data} lot={modal.d.lot} upd={upd} openModal={openModal} close={closeModal}/>}
  </div>;
}

function LotsTab({data,upd,expanded,toggleLot,openModal,fStatus,setFStatus,fMonth,setFMonth,lotMonths,cartDb}){
  const[search,setSearch]=React.useState('');
  const[sortBy,setSortBy]=React.useState('date'); // date | added
  let lots=[...data.lots];
  lots.sort((a,b)=>sortBy==='date'?new Date(b.date)-new Date(a.date):new Date(b.createdAt)-new Date(a.createdAt));
  if(fStatus)lots=lots.filter(l=>computeStatus(l,data.sales)===fStatus);
  if(fMonth)lots=lots.filter(l=>mKey(l.date)===fMonth);
  if(search)lots=lots.filter(l=>(l.console+' '+l.color).toLowerCase().includes(search.toLowerCase()));
  
  const exportToExcel=()=>{
    const ws_data=[['ID','–ö–æ–Ω—Å–æ–ª—å','–¶–≤–µ—Ç','–ó–∞–∫—É–ø–∫–∞','–ü—Ä–æ–¥–∞–Ω–æ','–ü—Ä–∏–±—ã–ª—å','–°—Ç–∞—Ç—É—Å','–î–∞—Ç–∞']];
    data.lots.forEach(lot=>{
      const sold=lotSalesTotal(data.sales,lot.id);
      const profit=sold-(lot.cost||0);
      const status=computeStatus(lot,data.sales);
      ws_data.push([lot.id.slice(-4).toUpperCase(),lot.console,lot.color,lot.cost,sold,profit,STATUS_META[status].label,fmtD(lot.date)]);
    });
    const wb=XLSX.utils.book_new();
    const ws=XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb,ws,'–õ–æ—Ç—ã');
    XLSX.writeFile(wb,'ConsoleFlip_Export_'+new Date().toISOString().split('T')[0]+'.xlsx');
  };
  
  return<>
    <div className="sec-hdr">
      <span className="sec-title">–õ–æ—Ç—ã</span>
      <div className="filter-row">
        <input type="text" className="search-inp" placeholder="üîç –ü–æ–∏—Å–∫..." value={search} onChange={e=>setSearch(e.target.value)} style={{padding:'6px 12px',background:'var(--surf2)',border:'1px solid var(--border)',borderRadius:'8px',color:'var(--text)',fontSize:'.85rem',minWidth:'180px'}}/>
        <select className="sel-sm" value={fMonth} onChange={e=>setFMonth(e.target.value)}>
          <option value="">–í—Å–µ –º–µ—Å—è—Ü—ã</option>
          {lotMonths.map(m=>{const[y,mo]=m.split('-');return<option key={m} value={m}>{MONTHS_FULL[parseInt(mo)-1]} {y}</option>;})}
        </select>
        <select className="sel-sm" value={fStatus} onChange={e=>setFStatus(e.target.value)}>
          <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
          <option value="active">–í –Ω–∞–ª–∏—á–∏–∏</option>
          <option value="partial">–ß–∞—Å—Ç–∏—á–Ω–æ</option>
          <option value="sold">–ó–∞–∫—Ä—ã—Ç—ã</option>
          <option value="parts">–ù–∞ –∑–∞–ø—á–∞—Å—Ç–∏</option>
        </select>
        <button className="btn btn-g btn-sm" onClick={exportToExcel} style={{fontSize:'.78rem',padding:'6px 12px'}}>üìä Excel</button>
        <select className="sel-sm" value={sortBy} onChange={e=>setSortBy(e.target.value)}>
          <option value="date">–ü–æ –¥–∞—Ç–µ</option>
          <option value="added">–ü–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é</option>
        </select>
        <span className="sec-cnt">{lots.length}</span>
      </div>
    </div>
    {!lots.length?<div className="empty"><div className="empty-icon">üì¶</div><div className="empty-txt">–ù–µ—Ç –ª–æ—Ç–æ–≤</div></div>
      :lots.map(lot=><LotCard key={lot.id} lot={lot} data={data} upd={upd}
          expanded={expanded.has(lot.id)} toggle={()=>toggleLot(lot.id)}
          openModal={openModal} cartDb={cartDb}/>)}
  </>;
}

function LotCard({lot,data,upd,expanded,toggle,openModal}){
  const[cartSell,setCartSell]=useState(null);
  const status=computeStatus(lot,data.sales);
  const sold=lotSalesTotal(data.sales,lot.id);
  const sales=lotSales(data.sales,lot.id);
  const promoCosts=sales.reduce((s,x)=>s+(x.promoCost||0),0);
  const profit=sold-(lot.cost||0)-promoCosts;
  const pct=lot.cost>0?Math.min(100,sold/lot.cost*100):0;
  const sm=STATUS_META[status];
  const pnlCls=profit>0?'pos':profit<0?'neg':'zero';

  const rmSale=id=>upd(d=>{d.sales=d.sales.filter(s=>s.id!==id);return d;});
  const rmAcc=id=>upd(d=>{const l=d.lots.find(x=>x.id===lot.id);if(l)l.accessories=l.accessories.filter(a=>a.id!==id);return d;});
  
  const days=daysOnHand(lot.date);
  const daysColor=status==='sold'?'var(--accent)':days<=7?'var(--accent)':days<=14?'var(--warn)':'var(--red)';

  return<div className={`lot-card st-${status}`}>
    <div className="lot-head" onClick={toggle}>
      <div className="lot-info">
        <div className="lot-name">{lot.console} ¬∑ {lot.color}</div>
        <div className="lot-sub">
          {lot.date&&<span className="td">{fmtD(lot.date)}</span>}
          {status!=='sold'&&<span className="tag" style={{background:`${daysColor}15`,color:daysColor,fontWeight:700}}>‚è± {days} {days===1?'–¥–µ–Ω—å':days<5?'–¥–Ω—è':'–¥–Ω–µ–π'}</span>}
          {lot.condition&&<span className="tag tk">{lot.condition}/10</span>}
          {lot.sourceType&&<span className="tag ts">{lot.sourceType}</span>}
          {(lot.cartridges||[]).length>0&&<span className="tag ta">{lot.cartridges.length} –∫–∞—Ä—Ç.</span>}
          {(lot.accessories||[]).length>0&&<span className="tag ta">{lot.accessories.length} –∞–∫—Å.</span>}
          {lot.targetPrice>0&&sold<lot.targetPrice&&status!=='sold'&&<span className="tag" style={{background:'rgba(79,184,255,.12)',color:'var(--a3)'}}>üéØ {fmt(lot.targetPrice-sold)}</span>}
        </div>
      </div>
      <div className="lot-right">
        <div style={{display:'grid',gridTemplateColumns:sold>0?'auto auto auto auto':'auto',gap:'12px',alignItems:'center'}}>
          {sold>0&&<>
            <div style={{textAlign:'right'}}>
              <div style={{fontSize:'.65rem',color:'var(--t3)',marginBottom:'3px',textTransform:'uppercase',letterSpacing:'.5px',fontWeight:600}}>–ü—Ä–∏–±—ã–ª—å</div>
              <div style={{fontFamily:'var(--mono)',fontSize:'.88rem',fontWeight:700,color:profit>=0?'var(--accent)':'var(--red)'}}>{(profit>0?'+':'')+fmt(profit)}</div>
            </div>
            <div style={{textAlign:'right'}}>
              <div style={{fontSize:'.65rem',color:'var(--t3)',marginBottom:'3px',textTransform:'uppercase',letterSpacing:'.5px',fontWeight:600}}>–ú–∞—Ä–∂–∞</div>
              <div style={{fontFamily:'var(--mono)',fontSize:'.88rem',fontWeight:700,color:profit>=0?'var(--accent)':'var(--red)'}}>{lot.cost>0?((profit/lot.cost*100).toFixed(1)+'%'):'‚Äî'}</div>
            </div>
          </>}
          <div style={{textAlign:'right'}}>
            <div style={{fontSize:'.65rem',color:'var(--t3)',marginBottom:'3px',textTransform:'uppercase',letterSpacing:'.5px',fontWeight:600}}>–ó–∞—Ç—Ä–∞—Ç—ã</div>
            <div style={{fontFamily:'var(--mono)',fontSize:'.88rem',fontWeight:700,color:'var(--a2)'}}>{fmt(lot.cost)}</div>
          </div>
          {sold>0&&<div style={{textAlign:'right'}}>
            <div style={{fontSize:'.65rem',color:'var(--t3)',marginBottom:'3px',textTransform:'uppercase',letterSpacing:'.5px',fontWeight:600}}>–í—ã—Ä—É—á–∫–∞</div>
            <div style={{fontFamily:'var(--mono)',fontSize:'.88rem',fontWeight:700,color:'var(--a3)'}}>{fmt(sold)}</div>
          </div>}
        </div>
        <div className={`pill ${sm.cls}`} style={{marginLeft:'12px'}}>{sm.label}</div>
        <div className={`chev ${expanded?'open':''}`}>‚ñæ</div>
      </div>
    </div>

    {expanded&&<div className="lot-body">
      {lot.cost>0&&sold>0&&<div className="prog-wrap">
        <div className="prog-labels">
          <span>{fmt(sold)} –∏–∑ {fmt(lot.cost)}</span>
          <span className={`prog-pct ${pct>=100?'done':'mid'}`}>{pct.toFixed(0)}%</span>
        </div>
        <div className="prog-track"><div className={`prog-fill ${pct>=100?'done':''}`} style={{width:pct+'%'}}/></div>
      </div>}

      {/* CARTRIDGES */}
      {(lot.cartridges||[]).length>0&&<><div className="divider"/>
        <div className="blk">
          <div className="blk-hdr"><span>üóÇ –ö–∞—Ä—Ç—Ä–∏–¥–∂–∏</span></div>
          {lot.cartridges.map(c=>{
            const cs=data.sales.find(s=>s.lotId===lot.id&&s.cartridgeId===c.id);
            return<React.Fragment key={c.id}>
              <div className="cart-row">
                <span className="cart-name">üìº {c.name}</span>
                {c.inBox&&<span className="cart-box-badge">üì¶ –ö–æ—Ä–æ–±–∫–∞</span>}
                {cs
                  ?<span className="cart-sold-badge">+{fmt(cs.amount)}</span>
                  :<button className="btn btn-xs btn-w" onClick={()=>setCartSell(cartSell===c.id?null:c.id)}>–ü—Ä–æ–¥–∞—Ç—å</button>
                }
              </div>
              {cartSell===c.id&&!cs&&<InlineSell lotId={lot.id} cartId={c.id} name={c.name} upd={upd} done={()=>setCartSell(null)}/>}
            </React.Fragment>;
          })}
        </div>
      </>}

      {/* ACCESSORIES */}
      {(lot.accessories||[]).length>0&&<><div className="divider"/>
        <div className="blk">
          <div className="blk-hdr"><span>üïπ –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</span>
            <button className="btn btn-xs btn-g" onClick={()=>openModal('lot',{edit:lot})}>–ò–∑–º–µ–Ω–∏—Ç—å</button>
          </div>
          {lot.accessories.map(a=><div key={a.id} className="sale-row">
            <div className="sale-info">
              <div className="sale-item">{ACC_TYPES[a.type]||'üì¶'} {a.name}</div>
            </div>
            <button className="btn btn-xs btn-d" onClick={()=>rmAcc(a.id)}>√ó</button>
          </div>)}
        </div>
      </>}

      {/* SALES */}
      <div className="divider"/>
      <div className="blk">
        <div className="blk-hdr">
          <span>üí∞ –ü—Ä–æ–¥–∞–∂–∏{sales.length>0?` (${sales.length})`:''}</span>
          <button className="btn btn-xs btn-a" onClick={()=>openModal('sale',{lotId:lot.id})}>+ –ü—Ä–æ–¥–∞–∂–∞</button>
        </div>
        {!sales.length&&<div style={{fontSize:'.78rem',color:'var(--t3)',fontStyle:'italic'}}>–ü—Ä–æ–¥–∞–∂ –Ω–µ—Ç</div>}
        {sales.map(s=><div key={s.id} className="sale-row">
          <div className="sale-info">
            <div className="sale-item">{s.item}</div>
            <div className="sale-meta">
              <span className="sale-date">{fmtD(s.date)}</span>
              {s.platform&&<span className="sale-plat">{s.platform}</span>}
              {s.method&&<span className="sale-meth">{s.method}</span>}
              {s.pay&&<span className="sale-meth">¬∑ {s.pay}</span>}
            </div>
          </div>
          <span className="sale-amt">{fmt(s.amount)}</span>
          <button className="btn btn-xs btn-d" onClick={()=>rmSale(s.id)}>√ó</button>
        </div>)}
      </div>

      {lot.notes&&<><div className="divider"/><div className="lot-notes-txt">{lot.notes}</div></>}

      <div className="lot-acts">
        <button className="btn btn-a btn-sm" onClick={()=>openModal('sale',{lotId:lot.id})}>+ –ü—Ä–æ–¥–∞–∂–∞</button>
        <button className="btn btn-g btn-sm" onClick={()=>openModal('lot',{edit:lot})}>‚úè –ò–∑–º–µ–Ω–∏—Ç—å</button>
        <button className="btn btn-g btn-sm" onClick={()=>openModal('view',{lot})}>üîç –ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
        <button className="btn btn-d btn-sm" onClick={()=>openModal('del',{lotId:lot.id,name:`${lot.console} ${lot.color}`})}>üóë</button>
      </div>
    </div>}
  </div>;
}

function InlineSell({lotId,cartId,name,upd,done}){
  const[amt,setAmt]=useState('');
  const[date,setDate]=useState(todayStr());
  const[platform,setPlatform]=useState('');
  const[method,setMethod]=useState('–î–æ—Å—Ç–∞–≤–∫–∞');
  const save=()=>{
    if(!amt)return;
    upd(d=>{d.sales.push({id:uid(),lotId,cartridgeId:cartId,item:name,amount:parseFloat(amt),date,platform,method,pay:'–ü–µ—Ä–µ–≤–æ–¥',note:'',createdAt:new Date().toISOString()});return d;});
    done();
  };
  return<div className="inline-sell">
    <div className="is-row">
      <input type="number" placeholder="–°—É–º–º–∞ ‚ÇΩ" value={amt} onChange={e=>setAmt(e.target.value)}/>
      <input type="date" value={date} onChange={e=>setDate(e.target.value)}/>
    </div>
    <div className="is-row">
      <input placeholder="–ü–ª–æ—â–∞–¥–∫–∞ (–ê–≤–∏—Ç–æ...)" value={platform} onChange={e=>setPlatform(e.target.value)}/>
      <select value={method} onChange={e=>setMethod(e.target.value)} style={{background:'var(--surf3)',border:'1px solid var(--border)',borderRadius:'7px',padding:'6px 10px',color:'var(--text)',fontFamily:'var(--sans)',fontSize:'.82rem',outline:'none',WebkitAppearance:'none',backgroundImage:"url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%238892b0' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E\")",backgroundRepeat:'no-repeat',backgroundPosition:'right 7px center',flex:1}}>
        {SALE_METHODS.map(m=><option key={m}>{m}</option>)}
      </select>
    </div>
    <div className="is-row">
      <button className="btn btn-a btn-sm" onClick={save}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button className="btn btn-g btn-sm" onClick={done}>–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>;
}

function HistTab({data,hMonth,setHMonth,saleMonths,openModal}){
  let sales=[...data.sales].sort((a,b)=>new Date(b.date)-new Date(a.date));
  if(hMonth)sales=sales.filter(s=>mKey(s.date)===hMonth);
  const total=sales.reduce((s,x)=>s+(x.amount||0),0);
  return<>
    <div className="sec-hdr">
      <span className="sec-title">–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–¥–∞–∂</span>
      <div className="filter-row">
        <select className="sel-sm" value={hMonth} onChange={e=>setHMonth(e.target.value)}>
          <option value="">–í—Å–µ –º–µ—Å—è—Ü—ã</option>
          {saleMonths.map(m=>{const[y,mo]=m.split('-');return<option key={m} value={m}>{MONTHS_FULL[parseInt(mo)-1]} {y}</option>;})}
        </select>
        <span className="sec-cnt">{fmt(total)}</span>
      </div>
    </div>
    {!sales.length?<div className="empty"><div className="empty-icon">üí∏</div><div className="empty-txt">–ü—Ä–æ–¥–∞–∂ –Ω–µ—Ç</div></div>
      :sales.map(s=>{
        const lot=data.lots.find(l=>l.id===s.lotId);
        return<div key={s.id} className="hist-card" onClick={()=>lot&&openModal('view',{lot})}>
          <div className="hist-icon">üí∞</div>
          <div className="hist-info">
            <div className="hist-name">{s.item}</div>
            <div className="hist-sub">{lot?`${lot.console} ${lot.color}`:'–£–¥–∞–ª—ë–Ω–Ω—ã–π –ª–æ—Ç'} ¬∑ {fmtD(s.date)}{s.platform&&` ¬∑ ${s.platform}`}{s.method&&` ¬∑ ${s.method}`}</div>
          </div>
          <span className="hist-amt">{fmt(s.amount)}</span>
        </div>;
      })}
  </>;
}

function StatsTab({data,stats}){
  const[period,setPeriod]=React.useState('all'); // all, month, quarter
  const[selectedMonth,setSelectedMonth]=React.useState('');
  const[selectedQuarter,setSelectedQuarter]=React.useState('');
  const[chartType,setChartType]=React.useState('profit'); // profit, revenue
  
  const allMonths=useMemo(()=>[...new Set([...data.sales.map(s=>mKey(s.date)),...data.lots.map(l=>mKey(l.date))].filter(Boolean))].sort().reverse(),[data]);
  const quarters=useMemo(()=>{const qs=new Set();allMonths.forEach(m=>{const[y,mo]=m.split('-');const q=Math.ceil(parseInt(mo)/3);qs.add(`${y}-Q${q}`);});return[...qs].sort().reverse();},[allMonths]);
  
  const filterData=()=>{
    let lots=data.lots;let sales=data.sales;
    if(period==='month'&&selectedMonth){
      sales=sales.filter(s=>mKey(s.date)===selectedMonth);
      // –î–ª—è –≤–ª–æ–∂–µ–Ω–∏–π –±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ —Ç–µ –ª–æ—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –∏–º–µ—é—Ç –ø—Ä–æ–¥–∞–∂–∏ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ
      const lotIdsWithSales=new Set(sales.map(s=>s.lotId));
      lots=data.lots.filter(l=>lotIdsWithSales.has(l.id));
    }
    if(period==='quarter'&&selectedQuarter){
      const[y,q]=selectedQuarter.split('-Q');const qn=parseInt(q);const startM=(qn-1)*3+1;const endM=qn*3;
      sales=sales.filter(s=>{const k=mKey(s.date);if(!k)return false;const[sy,smo]=k.split('-');return sy===y&&parseInt(smo)>=startM&&parseInt(smo)<=endM;});
      // –î–ª—è –≤–ª–æ–∂–µ–Ω–∏–π –±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ —Ç–µ –ª–æ—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –∏–º–µ—é—Ç –ø—Ä–æ–¥–∞–∂–∏ –≤ —ç—Ç–æ–º –∫–≤–∞—Ä—Ç–∞–ª–µ
      const lotIdsWithSales=new Set(sales.map(s=>s.lotId));
      lots=data.lots.filter(l=>lotIdsWithSales.has(l.id));
    }
    return{lots,sales};
  };
  
  const{lots:fLots,sales:fSales}=filterData();
  const fInvested=fLots.reduce((s,l)=>s+(l.cost||0),0);
  const fRevenue=fSales.reduce((s,x)=>s+(x.amount||0),0);
  const fPromoCosts=fSales.reduce((s,x)=>s+(x.promoCost||0),0);
  const fProfit=fRevenue-fInvested-fPromoCosts;
  const fMargin=fInvested>0?fProfit/fInvested*100:0;
  
  const monthly=useMemo(()=>{
    const map={};
    // –°–æ–±–∏—Ä–∞–µ–º –≤—ã—Ä—É—á–∫—É –∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –ø–æ –º–µ—Å—è—Ü–∞–º –ø—Ä–æ–¥–∞–∂
    fSales.forEach(s=>{
      const k=mKey(s.date);
      if(!k)return;
      if(!map[k])map[k]={rev:0,deals:0,promo:0,invested:0};
      map[k].rev+=s.amount||0;
      map[k].deals++;
      map[k].promo+=s.promoCost||0;
      // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞—Ç—Ä–∞—Ç—ã –ª–æ—Ç–∞ –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ –ø—Ä–æ–¥–∞—ë—Ç—Å—è —Å–∞–º–∞ –ø—Ä–∏—Å—Ç–∞–≤–∫–∞ (–∫–æ–Ω—Å–æ–ª—å)
      const lot=data.lots.find(l=>l.id===s.lotId);
      if(lot&&lot.cost){
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –ø—Ä–æ–¥–∞–∂–∞ –∫–æ–Ω—Å–æ–ª–∏ (–∞ –Ω–µ –∫–∞—Ä—Ç—Ä–∏–¥–∂–∞ –∏–ª–∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä–∞)
        const isConsoleSale=s.item.toLowerCase().includes('–∫–æ–Ω—Å–æ–ª—å')||s.item===`${lot.console} ${lot.color}`;
        if(isConsoleSale){
          map[k].invested+=lot.cost;
        }
      }
    });
    const keys=Object.keys(map).sort();
    return(period==='all'?keys.slice(-6):keys).map(k=>({key:k,rev:map[k]?.rev||0,deals:map[k]?.deals||0,profit:(map[k]?.rev||0)-(map[k]?.invested||0)-(map[k]?.promo||0)}));
  },[fLots,fSales,period,data.lots]);
  
  const maxVal=Math.max(...monthly.map(m=>chartType==='profit'?m.profit:m.rev),1);
  const sc={active:0,partial:0,sold:0,parts:0};
  fLots.forEach(l=>sc[computeStatus(l,fSales)]++);
  const avgDeal=fSales.length>0?fRevenue/fSales.length:0;
  const byModel=useMemo(()=>{
    const m={};fLots.forEach(l=>{const k=l.console||'?';if(!m[k])m[k]={c:0,inv:0,rev:0};m[k].c++;m[k].inv+=l.cost||0;m[k].rev+=lotSalesTotal(fSales,l.id);});
    return Object.entries(m).sort((a,b)=>b[1].c-a[1].c);
  },[fLots,fSales]);
  
  return<>
    <div className="sec-hdr" style={{marginBottom:'14px'}}>
      <span className="sec-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
      <div className="filter-row" style={{gap:'6px'}}>
        <select className="sel-sm" value={period} onChange={e=>{setPeriod(e.target.value);setSelectedMonth('');setSelectedQuarter('');}}>
          <option value="all">–ó–∞ –≤—Å—ë –≤—Ä–µ–º—è</option>
          <option value="month">–ü–æ –º–µ—Å—è—Ü–∞–º</option>
          <option value="quarter">–ü–æ –∫–≤–∞—Ä—Ç–∞–ª–∞–º</option>
        </select>
        {period==='month'&&<select className="sel-sm" value={selectedMonth} onChange={e=>setSelectedMonth(e.target.value)}>
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</option>
          {allMonths.map(m=>{const[y,mo]=m.split('-');return<option key={m} value={m}>{MONTHS_FULL[parseInt(mo)-1]} {y}</option>;})}
        </select>}
        {period==='quarter'&&<select className="sel-sm" value={selectedQuarter} onChange={e=>setSelectedQuarter(e.target.value)}>
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–≤–∞—Ä—Ç–∞–ª</option>
          {quarters.map(q=><option key={q} value={q}>{q}</option>)}
        </select>}
      </div>
    </div>
    
    {monthly.length>0&&<div className="month-chart">
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'12px'}}>
        <div className="month-title">üìà {chartType==='profit'?'–ü—Ä–∏–±—ã–ª—å':'–í—ã—Ä—É—á–∫–∞'} –ø–æ –º–µ—Å—è—Ü–∞–º</div>
        <div style={{display:'flex',gap:'4px',background:'var(--surf2)',padding:'3px',borderRadius:'8px'}}>
          <button onClick={()=>setChartType('profit')} style={{padding:'4px 12px',background:chartType==='profit'?'var(--surf3)':'transparent',border:'none',borderRadius:'6px',color:chartType==='profit'?'var(--text)':'var(--t3)',fontSize:'.75rem',fontWeight:600,cursor:'pointer',fontFamily:'var(--sans)'}}>–ü—Ä–∏–±—ã–ª—å</button>
          <button onClick={()=>setChartType('revenue')} style={{padding:'4px 12px',background:chartType==='revenue'?'var(--surf3)':'transparent',border:'none',borderRadius:'6px',color:chartType==='revenue'?'var(--text)':'var(--t3)',fontSize:'.75rem',fontWeight:600,cursor:'pointer',fontFamily:'var(--sans)'}}>–í—ã—Ä—É—á–∫–∞</button>
        </div>
      </div>
      <div className="month-bars">
        {monthly.map(m=>{
          const val=chartType==='profit'?m.profit:m.rev;
          const h=Math.max(3,Math.abs(val)/maxVal*72);
          const[y,mo]=m.key.split('-');
          return<div key={m.key} className="month-col">
            <div style={{fontSize:'.68rem',color:val>=0?'var(--accent)':'var(--red)',fontFamily:'var(--mono)',fontWeight:600}}>{(val>=0?'+':'')+new Intl.NumberFormat('ru-RU').format(Math.round(val))}</div>
            <div className="month-bar" style={{height:h+'px',background:val>=0?'linear-gradient(180deg,var(--accent),var(--a3))':'linear-gradient(180deg,var(--red),var(--a2)'}}/>
            <div className="month-lbl">{MONTHS_RU[parseInt(mo)-1]}</div>
          </div>;
        })}
      </div>
    </div>}
    
    <div className="stat-grid">
      <div className="stat-blk">
        <div className="stat-blk-title">üí∞ –§–∏–Ω–∞–Ω—Å—ã</div>
        {(()=>{
          const extraCosts=fLots.reduce((s,l)=>s+(l.costChip||0)+(l.costSD||0)+(l.costAdapter||0)+(l.costGlass||0)+(l.costCase||0)+(l.costDefect||0)+(l.costDelivery||0)+(l.costOther||0),0);
          const avgDeal=fSales.length>0?fRevenue/fSales.length:0;
          return[
            ['–ü—Ä–∏–±—ã–ª—å',(fProfit>=0?'+':'')+fmt(fProfit),fProfit>=0?'var(--accent)':'var(--red)'],
            ['–ú–∞—Ä–∂–∞',fMargin.toFixed(1)+'%',fMargin>=0?'var(--accent)':'var(--red)'],
            ['–í—ã—Ä—É—á–∫–∞',fmt(fRevenue),'var(--a3)'],
            ['–í–ª–æ–∂–µ–Ω–æ',fmt(fInvested),'var(--a2)'],
            ['–ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ',fPromoCosts>0?'‚àí'+fmt(fPromoCosts):'‚Äî','var(--warn)'],
            ...(extraCosts>0?[['–î–æ–ø –∑–∞—Ç—Ä–∞—Ç—ã','‚àí'+fmt(extraCosts),'var(--warn)']]:[ ]),
            ['–°—Ä–µ–¥–Ω–∏–π —á–µ–∫',fSales.length>0?fmt(avgDeal):'‚Äî','var(--text)'],
            ['–°–¥–µ–ª–æ–∫',fSales.length,'var(--a3)'],
          ].map(([l,v,c])=><div key={l} className="stat-line"><span className="stat-ln-lbl">{l}</span><span className="stat-ln-val" style={{color:c}}>{v}</span></div>);
        })()}
      </div>
      <div className="stat-blk">
        <div className="stat-blk-title">üì¶ –õ–æ—Ç—ã</div>
        {[['–í—Å–µ–≥–æ',fLots.length,'var(--text)'],['–í –Ω–∞–ª–∏—á–∏–∏',sc.active,'var(--t2)'],
          ['–ß–∞—Å—Ç–∏—á–Ω–æ',sc.partial,'var(--warn)'],['–ü—Ä–æ–¥–∞–Ω–æ',sc.sold,'var(--accent)'],
          ['–ù–∞ –∑–∞–ø—á–∞—Å—Ç–∏',sc.parts,'var(--red)'],
        ].map(([l,v,c])=><div key={l} className="stat-line"><span className="stat-ln-lbl">{l}</span><span className="stat-ln-val" style={{color:c}}>{v}</span></div>)}
      </div>
    </div>
    {byModel.length>0&&<div className="stat-blk" style={{marginBottom:'14px'}}>
      <div className="stat-blk-title">üéÆ –ü–æ –º–æ–¥–µ–ª—è–º</div>
      {byModel.map(([model,d])=><div key={model} className="stat-line">
        <span className="stat-ln-lbl">{model} ({d.c} —à—Ç.)</span>
        <span className="stat-ln-val" style={{color:d.rev-d.inv>=0?'var(--accent)':'var(--red)'}}>{(d.rev-d.inv>=0?'+':'')+fmt(d.rev-d.inv)}</span>
      </div>)}
    </div>}
    
    {/* –°–†–ï–î–ù–ò–ô –°–†–û–ö –ü–†–û–î–ê–ñ–ò –ü–û –ú–û–î–ï–õ–Ø–ú */}
    {(()=>{
      const soldLots=data.lots.filter(l=>computeStatus(l,fSales)==='sold');
      if(soldLots.length<2)return null;
      
      const modelStats={};
      soldLots.forEach(l=>{
        const firstSale=data.sales.find(s=>s.lotId===l.id&&s.item.toLowerCase().includes('–∫–æ–Ω—Å–æ–ª—å'));
        if(!firstSale)return;
        const days=Math.floor((new Date(firstSale.date)-new Date(l.date))/(1000*60*60*24));
        if(days<0)return;
        
        const model=l.console;
        if(!modelStats[model])modelStats[model]={count:0,totalDays:0};
        modelStats[model].count++;
        modelStats[model].totalDays+=days;
      });
      
      const models=Object.entries(modelStats)
        .map(([name,data])=>({name,avgDays:Math.round(data.totalDays/data.count),count:data.count}))
        .sort((a,b)=>a.avgDays-b.avgDays);
      
      if(models.length===0)return null;
      
      return<div className="stat-blk" style={{marginBottom:'14px'}}>
        <div className="stat-blk-title">‚è± –°—Ä–µ–¥–Ω–∏–π —Å—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏</div>
        {models.map(m=><div key={m.name} className="stat-line">
          <span className="stat-ln-lbl">{m.name} ({m.count} —à—Ç.)</span>
          <span className="stat-ln-val" style={{color:m.avgDays<=7?'var(--accent)':m.avgDays<=14?'var(--warn)':'var(--red)'}}>{m.avgDays} {m.avgDays<5?'–¥–Ω—è':'–¥–Ω–µ–π'}</span>
        </div>)}
      </div>;
    })()}
  </>;
}

function AccsTab({data}){
  const rows=useMemo(()=>{
    const r=[];
    data.lots.forEach(lot=>{
      (lot.accessories||[]).forEach(a=>{
        const cs=data.sales.find(s=>s.lotId===lot.id&&s.accId===a.id);
        r.push({...a,lotName:`${lot.console} ${lot.color}`,lotDate:lot.date,sale:cs||null});
      });
    });
    return r.sort((a,b)=>new Date(b.lotDate)-new Date(a.lotDate));
  },[data]);
  return<>
    <div className="sec-hdr"><span className="sec-title">–í—Å–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã</span><span className="sec-cnt">{rows.length}</span></div>
    {!rows.length?<div className="empty"><div className="empty-icon">üïπ</div><div className="empty-txt">–ê–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div></div>
      :<div style={{background:'var(--surf)',border:'1px solid var(--border)',borderRadius:'var(--r2)',overflow:'hidden'}}>
        {rows.map((a,i)=><div key={a.id} className="acc-tab-row">
          <div className="acc-tab-icon">{ACC_TYPES[a.type]?.slice(0,2)||'üì¶'}</div>
          <div className="acc-tab-info">
            <div className="acc-tab-name">{a.name}</div>
            <div className="acc-tab-sub">{a.lotName} ¬∑ {fmtD(a.lotDate)}</div>
          </div>
          <div className="acc-tab-type">{ACC_TYPES[a.type]?.split(' ')[1]||'–î—Ä—É–≥–æ–µ'}</div>
          {a.sale?<span style={{fontFamily:'var(--mono)',fontSize:'.78rem',color:'var(--accent)'}}>+{fmt(a.sale.amount)}</span>
            :<span style={{fontSize:'.65rem',color:'var(--t3)',background:'var(--surf2)',padding:'2px 7px',borderRadius:'4px'}}>–Ω–µ –ø—Ä–æ–¥–∞–Ω</span>}
        </div>)}
      </div>}
  </>;
}

function LotModal({data,upd,init,cartDb,close}){
  const e=init.edit||null;
  const[cn,setCn]=useState(e?.console||CONSOLES[0]);
  const[cnCustom,setCnCustom]=useState('');
  const[color,setColor]=useState(e?.color||'');
  const[colorCustom,setColorCustom]=useState('');
  const[cost,setCost]=useState(e?.cost||'');
  const[date,setDate]=useState(e?.date||todayStr());
  const[srcType,setSrcType]=useState(e?.sourceType||'–î–æ—Å—Ç–∞–≤–∫–∞');
  const[srcAddr,setSrcAddr]=useState(e?.sourceAddr||'');
  const[srcLink,setSrcLink]=useState(e?.sourceLink||'');
  const[cond,setCond]=useState(e?.condition||8);
  const[status,setStatus]=useState(e?.status||'active');
  const[notes,setNotes]=useState(e?.notes||'');
  const[carts,setCarts]=useState(e?.cartridges?JSON.parse(JSON.stringify(e.cartridges)):[]);
  const[accs,setAccs]=useState(e?.accessories?JSON.parse(JSON.stringify(e.accessories)):[]);
  const[cartIn,setCartIn]=useState('');
  const[cartBox,setCartBox]=useState(false);
  const[accIn,setAccIn]=useState('');
  const[accType,setAccType]=useState('joy');
  
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã
  const[costChip,setCostChip]=useState(e?.costChip||'');
  const[costSD,setCostSD]=useState(e?.costSD||'');
  const[costAdapter,setCostAdapter]=useState(e?.costAdapter||'');
  const[costGlass,setCostGlass]=useState(e?.costGlass||'');
  const[costCase,setCostCase]=useState(e?.costCase||'');
  const[costDefect,setCostDefect]=useState(e?.costDefect||'');
  const[costDelivery,setCostDelivery]=useState(e?.costDelivery||'');
  const[costOther,setCostOther]=useState(e?.costOther||'');
  
  // –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –Ω–∞—Ü–µ–Ω–∫–∏ –∏ —Ü–µ–ª–µ–≤–∞—è —Ü–µ–Ω–∞
  const[targetPrice,setTargetPrice]=useState(e?.targetPrice||'');
  const[showCalc,setShowCalc]=useState(false);
  
  const totalCost=(parseFloat(cost)||0)+(parseFloat(costChip)||0)+(parseFloat(costSD)||0)+(parseFloat(costAdapter)||0)+(parseFloat(costGlass)||0)+(parseFloat(costCase)||0)+(parseFloat(costDefect)||0)+(parseFloat(costDelivery)||0)+(parseFloat(costOther)||0);
  const markup=targetPrice&&totalCost>0?((parseFloat(targetPrice)-totalCost)/totalCost*100):0;
  const profit=targetPrice?parseFloat(targetPrice)-totalCost:0;

  const colors=COLORS[cn]||[];
  useEffect(()=>{if(!e){setColor(colors[0]||'');}else{setColor(e.color||colors[0]||'');}},[cn]);

  const addCart=()=>{const n=cartIn.trim();if(!n)return;setCarts(c=>[...c,{id:uid(),name:n,inBox:cartBox}]);setCartIn('');setCartBox(false);upd(d=>{if(!d.cartridgeDb)d.cartridgeDb=[];if(!d.cartridgeDb.includes(n))d.cartridgeDb.push(n);return d;});};
  const addAcc=()=>{const n=accIn.trim();if(!n)return;setAccs(a=>[...a,{id:uid(),name:n,type:accType}]);setAccIn('');};

  const save=()=>{
    const finalCn=cn==='–î—Ä—É–≥–∞—è –∫–æ–Ω—Å–æ–ª—å'?cnCustom:cn;
    if(!finalCn.trim())return;
    const fc=color==='–î—Ä—É–≥–æ–π'?colorCustom:color;
    const lotData={console:finalCn,color:fc,cost:totalCost,baseCost:parseFloat(cost)||0,costChip:parseFloat(costChip)||0,costSD:parseFloat(costSD)||0,costAdapter:parseFloat(costAdapter)||0,costGlass:parseFloat(costGlass)||0,costCase:parseFloat(costCase)||0,costDefect:parseFloat(costDefect)||0,costDelivery:parseFloat(costDelivery)||0,costOther:parseFloat(costOther)||0,date,sourceType:srcType,sourceAddr:srcAddr,sourceLink:srcLink,condition:parseInt(cond)||8,status,notes,cartridges:carts,accessories:accs,targetPrice:parseFloat(targetPrice)||0,createdAt:e?.createdAt||new Date().toISOString()};
    if(e){
      upd(d=>{const l=d.lots.find(x=>x.id===e.id);if(l)Object.assign(l,lotData);return d;});
    }else{
      upd(d=>{d.lots.push({id:uid(),...lotData});return d;});
    }
    close();
  };

  const selStyle={background:'var(--surf3)',border:'1px solid var(--border)',borderRadius:'7px',padding:'6px 24px 6px 8px',color:'var(--text)',fontFamily:'var(--sans)',fontSize:'.78rem',outline:'none',WebkitAppearance:'none',backgroundImage:"url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%238892b0' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E\")",backgroundRepeat:'no-repeat',backgroundPosition:'right 7px center',flex:1};

  return<div className="ov">
    <div className="modal" style={{maxWidth:'680px'}}>
      <div className="modal-hdr"><div className="modal-title">{e?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ—Ç':'–ù–æ–≤—ã–π –ª–æ—Ç'}</div><button className="modal-x" onClick={close}>‚úï</button></div>
      <div className="modal-body">
        <div className="fr-2">
          <div className="fr"><label>–ü—Ä–∏—Å—Ç–∞–≤–∫–∞</label>
            <select value={cn} onChange={ev=>setCn(ev.target.value)}>{CONSOLES.map(c=><option key={c}>{c}</option>)}</select></div>
          <div className="fr"><label>–¶–≤–µ—Ç</label>
            <select value={color} onChange={ev=>setColor(ev.target.value)}>{colors.map(c=><option key={c}>{c}</option>)}</select></div>
        </div>
        {cn==='–î—Ä—É–≥–∞—è –∫–æ–Ω—Å–æ–ª—å'&&<div className="fr"><label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω—Å–æ–ª–∏</label><input value={cnCustom} onChange={ev=>setCnCustom(ev.target.value)} placeholder="Steam Deck, PS5, Xbox..."/></div>}
        {color==='–î—Ä—É–≥–æ–π'&&<div className="fr"><label>–°–≤–æ–π —Ü–≤–µ—Ç</label><input value={colorCustom} onChange={ev=>setColorCustom(ev.target.value)} placeholder="–í–≤–µ–¥–∏—Ç–µ —Ü–≤–µ—Ç"/></div>}
        
        <div className="fr-3">
          <div className="fr"><label>–ó–∞–∫—É–ø–∫–∞ ‚ÇΩ</label><input type="number" value={cost} onChange={ev=>setCost(ev.target.value)} placeholder="15000"/></div>
          <div className="fr"><label>–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏</label><input type="date" value={date} onChange={ev=>setDate(ev.target.value)}/></div>
          <div className="fr"><label>–°–æ—Å—Ç–æ—è–Ω–∏–µ /10</label><input type="number" min="1" max="10" value={cond} onChange={ev=>setCond(ev.target.value)}/></div>
        </div>
        
        {/* –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –†–ê–°–•–û–î–´ */}
        <div className="fr" style={{marginBottom:'14px'}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'8px'}}>
            <label style={{marginBottom:0}}>üí∏ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã</label>
            <div style={{fontSize:'.85rem',color:'var(--accent)',fontFamily:'var(--mono)',fontWeight:600}}>–ò—Ç–æ–≥–æ: {fmt(totalCost)}</div>
          </div>
          <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:'8px',background:'var(--surf2)',padding:'12px',borderRadius:'10px'}}>
            <div style={{display:'flex',flexDirection:'column',gap:'4px'}}>
              <span style={{fontSize:'.7rem',color:'var(--t3)',fontWeight:600}}>–ß–∏–ø</span>
              <input type="number" value={costChip} onChange={ev=>setCostChip(ev.target.value)} placeholder="0" style={{padding:'6px 10px',background:'var(--surf3)',border:'1px solid var(--border)',borderRadius:'6px',color:'var(--text)',fontSize:'.85rem'}}/>
            </div>
            <div style={{display:'flex',flexDirection:'column',gap:'4px'}}>
              <span style={{fontSize:'.7rem',color:'var(--t3)',fontWeight:600}}>MicroSD</span>
              <input type="number" value={costSD} onChange={ev=>setCostSD(ev.target.value)} placeholder="0" style={{padding:'6px 10px',background:'var(--surf3)',border:'1px solid var(--border)',borderRadius:'6px',color:'var(--text)',fontSize:'.85rem'}}/>
            </div>
            <div style={{display:'flex',flexDirection:'column',gap:'4px'}}>
              <span style={{fontSize:'.7rem',color:'var(--t3)',fontWeight:600}}>–ü–µ—Ä–µ—Ö–æ–¥–Ω–∏–∫–∏ –ó–£</span>
              <input type="number" value={costAdapter} onChange={ev=>setCostAdapter(ev.target.value)} placeholder="0" style={{padding:'6px 10px',background:'var(--surf3)',border:'1px solid var(--border)',borderRadius:'6px',color:'var(--text)',fontSize:'.85rem'}}/>
            </div>
            <div style={{display:'flex',flexDirection:'column',gap:'4px'}}>
              <span style={{fontSize:'.7rem',color:'var(--t3)',fontWeight:600}}>–°—Ç–µ–∫–ª–æ</span>
              <input type="number" value={costGlass} onChange={ev=>setCostGlass(ev.target.value)} placeholder="0" style={{padding:'6px 10px',background:'var(--surf3)',border:'1px solid var(--border)',borderRadius:'6px',color:'var(--text)',fontSize:'.85rem'}}/>
            </div>
            <div style={{display:'flex',flexDirection:'column',gap:'4px'}}>
              <span style={{fontSize:'.7rem',color:'var(--t3)',fontWeight:600}}>–ß–µ—Ö–æ–ª</span>
              <input type="number" value={costCase} onChange={ev=>setCostCase(ev.target.value)} placeholder="0" style={{padding:'6px 10px',background:'var(--surf3)',border:'1px solid var(--border)',borderRadius:'6px',color:'var(--text)',fontSize:'.85rem'}}/>
            </div>
            <div style={{display:'flex',flexDirection:'column',gap:'4px'}}>
              <span style={{fontSize:'.7rem',color:'var(--t3)',fontWeight:600}}>–ë—Ä–∞–∫</span>
              <input type="number" value={costDefect} onChange={ev=>setCostDefect(ev.target.value)} placeholder="0" style={{padding:'6px 10px',background:'var(--surf3)',border:'1px solid var(--border)',borderRadius:'6px',color:'var(--text)',fontSize:'.85rem'}}/>
            </div>
            <div style={{display:'flex',flexDirection:'column',gap:'4px'}}>
              <span style={{fontSize:'.7rem',color:'var(--t3)',fontWeight:600}}>–î–æ—Å—Ç–∞–≤–∫–∞</span>
              <input type="number" value={costDelivery} onChange={ev=>setCostDelivery(ev.target.value)} placeholder="0" style={{padding:'6px 10px',background:'var(--surf3)',border:'1px solid var(--border)',borderRadius:'6px',color:'var(--text)',fontSize:'.85rem'}}/>
            </div>
            <div style={{display:'flex',flexDirection:'column',gap:'4px'}}>
              <span style={{fontSize:'.7rem',color:'var(--t3)',fontWeight:600}}>–ü—Ä–æ—á–µ–µ</span>
              <input type="number" value={costOther} onChange={ev=>setCostOther(ev.target.value)} placeholder="0" style={{padding:'6px 10px',background:'var(--surf3)',border:'1px solid var(--border)',borderRadius:'6px',color:'var(--text)',fontSize:'.85rem'}}/>
            </div>
          </div>
        </div>
        
        {/* –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† –ù–ê–¶–ï–ù–ö–ò */}
        {totalCost>0&&<div className="fr" style={{marginBottom:'14px'}}>
          <button onClick={()=>setShowCalc(!showCalc)} style={{background:'var(--surf2)',border:'1px solid var(--border)',padding:'8px 14px',borderRadius:'8px',color:'var(--text)',fontWeight:600,fontSize:'.85rem',cursor:'pointer',display:'flex',alignItems:'center',gap:'8px',width:'100%',justifyContent:'space-between'}}>
            <span>üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –Ω–∞—Ü–µ–Ω–∫–∏</span>
            <span style={{fontSize:'.75rem',color:'var(--t3)'}}>{showCalc?'‚ñ≤':'‚ñº'}</span>
          </button>
          {showCalc&&<div style={{background:'var(--surf2)',padding:'12px',borderRadius:'8px',marginTop:'8px'}}>
            <div style={{display:'flex',gap:'12px',alignItems:'flex-end',marginBottom:'10px'}}>
              <div style={{flex:1}}>
                <span style={{fontSize:'.7rem',color:'var(--t3)',fontWeight:600,display:'block',marginBottom:'5px'}}>–ñ–µ–ª–∞–µ–º–∞—è —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ ‚ÇΩ</span>
                <input type="number" value={targetPrice} onChange={ev=>setTargetPrice(ev.target.value)} placeholder="20000" style={{padding:'8px 12px',background:'var(--surf3)',border:'1px solid var(--border)',borderRadius:'6px',color:'var(--text)',fontSize:'.9rem',width:'100%'}}/>
              </div>
            </div>
            {targetPrice&&<div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:'10px'}}>
              <div style={{background:'var(--surf3)',padding:'10px',borderRadius:'8px'}}>
                <div style={{fontSize:'.65rem',color:'var(--t3)',marginBottom:'4px'}}>–ü–†–ò–ë–´–õ–¨</div>
                <div style={{fontFamily:'var(--mono)',fontSize:'1.1rem',fontWeight:700,color:profit>=0?'var(--accent)':'var(--red)'}}>{profit>=0?'+':''}{fmt(profit)}</div>
              </div>
              <div style={{background:'var(--surf3)',padding:'10px',borderRadius:'8px'}}>
                <div style={{fontSize:'.65rem',color:'var(--t3)',marginBottom:'4px'}}>–ù–ê–¶–ï–ù–ö–ê</div>
                <div style={{fontFamily:'var(--mono)',fontSize:'1.1rem',fontWeight:700,color:markup>=0?'var(--accent)':'var(--red)'}}>{markup>=0?'+':''}{markup.toFixed(1)}%</div>
              </div>
              <div style={{background:'var(--surf3)',padding:'10px',borderRadius:'8px'}}>
                <div style={{fontSize:'.65rem',color:'var(--t3)',marginBottom:'4px'}}>–ó–ê–¢–†–ê–¢–´</div>
                <div style={{fontFamily:'var(--mono)',fontSize:'1.1rem',fontWeight:700,color:'var(--a2)'}}>{fmt(totalCost)}</div>
              </div>
            </div>}
          </div>}
        </div>}
        
        <div className="fr-2">
          <div className="fr"><label>–û—Ç–∫—É–¥–∞ –∫—É–ø–ª–µ–Ω–æ</label>
            <select value={srcType} onChange={ev=>setSrcType(ev.target.value)}>{SOURCES.map(s=><option key={s}>{s}</option>)}</select></div>
          {srcType==='–°–∞–º–æ–≤—ã–≤–æ–∑'&&<div className="fr"><label>–ê–¥—Ä–µ—Å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label><input value={srcAddr} onChange={ev=>setSrcAddr(ev.target.value)} placeholder="—É–ª. –õ–µ–Ω–∏–Ω–∞ 15"/></div>}
        </div>
        
        <div className="fr"><label>–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–≤—Ü–∞ (–ê–≤–∏—Ç–æ)</label>
          <input value={srcLink} onChange={ev=>setSrcLink(ev.target.value)} placeholder="https://avito.ru/..."/></div>
        
        <div className="fr"><label>–°—Ç–∞—Ç—É—Å</label>
          <select value={status} onChange={ev=>setStatus(ev.target.value)}>
            <option value="active">–í –Ω–∞–ª–∏—á–∏–∏</option><option value="partial">–ß–∞—Å—Ç–∏—á–Ω–æ –ø—Ä–æ–¥–∞–Ω</option>
            <option value="sold">–ü—Ä–æ–¥–∞–Ω</option><option value="parts">–ù–∞ –∑–∞–ø—á–∞—Å—Ç–∏</option>
          </select></div>

        {/* CARTRIDGES */}
        <div className="fr" style={{marginBottom:'12px'}}>
          <label>–ö–∞—Ä—Ç—Ä–∏–¥–∂–∏ –≤ –∫–æ–º–ø–ª–µ–∫—Ç–µ</label>
          <div className="item-ed">
            <div className="item-ed-list">
              {!carts.length&&<div style={{padding:'9px 11px',fontSize:'.78rem',color:'var(--t3)',fontStyle:'italic'}}>–ù–µ—Ç –∫–∞—Ä—Ç—Ä–∏–¥–∂–µ–π</div>}
              {carts.map(c=><div key={c.id} className="item-ed-row">
                <span className="item-ed-name">üìº {c.name}</span>
                {c.inBox&&<span className="item-ed-badge">üì¶</span>}
                <button className="item-ed-del" onClick={()=>setCarts(x=>x.filter(i=>i.id!==c.id))}>√ó</button>
              </div>)}
            </div>
            <div className="item-add-area">
              <div className="item-add-row">
                <input list="cdb" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—Ä–∏–¥–∂–∞" value={cartIn} onChange={ev=>setCartIn(ev.target.value)} onKeyDown={ev=>{if(ev.key==='Enter'){ev.preventDefault();addCart();}}}/>
                <datalist id="cdb">{cartDb.map(n=><option key={n} value={n}/>)}</datalist>
                <button className="item-add-btn" onClick={addCart}>+</button>
              </div>
              <label className="check-row"><input type="checkbox" checked={cartBox} onChange={ev=>setCartBox(ev.target.checked)}/><span>–° –∫–æ—Ä–æ–±–∫–æ–π</span></label>
            </div>
          </div>
        </div>

        {/* ACCESSORIES */}
        <div className="fr" style={{marginBottom:'12px'}}>
          <label>–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã (–¥–∂–æ–π–∫–æ–Ω—ã, –∑–∞—Ä—è–¥–∫–∏, –∫–µ–π—Å—ã...)</label>
          <div className="item-ed">
            <div className="item-ed-list">
              {!accs.length&&<div style={{padding:'9px 11px',fontSize:'.78rem',color:'var(--t3)',fontStyle:'italic'}}>–ù–µ—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤</div>}
              {accs.map(a=><div key={a.id} className="item-ed-row">
                <span className="item-ed-name">{ACC_TYPES[a.type]||'üì¶'} {a.name}</span>
                <button className="item-ed-del" onClick={()=>setAccs(x=>x.filter(i=>i.id!==a.id))}>√ó</button>
              </div>)}
            </div>
            <div className="item-add-area">
              <div className="item-add-row">
                <input placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value={accIn} onChange={ev=>setAccIn(ev.target.value)} onKeyDown={ev=>{if(ev.key==='Enter'){ev.preventDefault();addAcc();}}}/>
                <select value={accType} onChange={ev=>setAccType(ev.target.value)} style={selStyle}>
                  {Object.entries(ACC_TYPES).map(([k,v])=><option key={k} value={k}>{v}</option>)}
                </select>
                <button className="item-add-btn" onClick={addAcc}>+</button>
              </div>
            </div>
          </div>
        </div>

        <div className="fr" style={{marginBottom:0}}><label>–ó–∞–º–µ—Ç–∫–∏</label>
          <textarea value={notes} onChange={ev=>setNotes(ev.target.value)} placeholder="–°–æ—Å—Ç–æ—è–Ω–∏–µ, –Ω—é–∞–Ω—Å—ã..."/></div>
      </div>
      <div className="modal-footer">
        <button className="btn btn-g" onClick={close}>–û—Ç–º–µ–Ω–∞</button>
        <button className="btn btn-a" onClick={save}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>;
}

function SaleModal({data,upd,init,close}){
  const lot=data.lots.find(l=>l.id===init.lotId);
  const[amount,setAmount]=useState('');
  const[date,setDate]=useState(todayStr());
  const[platform,setPlatform]=useState('');
  const[pay,setPay]=useState('–ü–µ—Ä–µ–≤–æ–¥');
  const[method,setMethod]=useState('–î–æ—Å—Ç–∞–≤–∫–∞');
  const[note,setNote]=useState('');
  const[promoCost,setPromoCost]=useState(''); // –ó–∞—Ç—Ä–∞—Ç—ã –Ω–∞ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ
  const[saleLink,setSaleLink]=useState(''); // –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
  
  const save=()=>{
    if(!amount)return;
    const itemName=`${lot.console} –∫–æ–Ω—Å–æ–ª—å`;
    upd(d=>{d.sales.push({id:uid(),lotId:init.lotId,item:itemName,amount:parseFloat(amount),date,platform,pay,method,note,promoCost:parseFloat(promoCost)||0,saleLink,createdAt:new Date().toISOString()});return d;});
    close();
  };
  return<div className="ov">
    <div className="modal">
      <div className="modal-hdr"><div className="modal-title">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥–∞–∂—É</div><button className="modal-x" onClick={close}>‚úï</button></div>
      <div className="modal-body">
        {lot&&<div style={{padding:'9px 14px',background:'var(--surf2)',borderRadius:'8px',marginBottom:'14px',fontSize:'.88rem',color:'var(--t2)'}}>
          –ü—Ä–æ–¥–∞—ë—Ç—Å—è: <strong style={{color:'var(--text)',fontSize:'.95rem'}}>{lot.console} {lot.color}</strong></div>}
        <div className="fr-2">
          <div className="fr"><label>–°—É–º–º–∞ –ø—Ä–æ–¥–∞–∂–∏ ‚ÇΩ</label><input type="number" value={amount} onChange={ev=>setAmount(ev.target.value)} placeholder="18000"/></div>
          <div className="fr"><label>–î–∞—Ç–∞</label><input type="date" value={date} onChange={ev=>setDate(ev.target.value)}/></div>
        </div>
        <div className="fr-3">
          <div className="fr"><label>–ü–ª–æ—â–∞–¥–∫–∞</label><input value={platform} onChange={ev=>setPlatform(ev.target.value)} placeholder="–ê–≤–∏—Ç–æ..."/></div>
          <div className="fr"><label>–°–ø–æ—Å–æ–±</label>
            <select value={method} onChange={ev=>setMethod(ev.target.value)}>{SALE_METHODS.map(m=><option key={m}>{m}</option>)}</select></div>
          <div className="fr"><label>–û–ø–ª–∞—Ç–∞</label>
            <select value={pay} onChange={ev=>setPay(ev.target.value)}>{PAYMENT.map(p=><option key={p}>{p}</option>)}</select></div>
        </div>
        <div className="fr-2">
          <div className="fr"><label>–ó–∞—Ç—Ä–∞—Ç—ã –Ω–∞ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ ‚ÇΩ</label><input type="number" value={promoCost} onChange={ev=>setPromoCost(ev.target.value)} placeholder="–ü—Ä–æ—Å–º–æ—Ç—Ä—ã –ê–≤–∏—Ç–æ..."/></div>
          <div className="fr"><label>–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</label><input value={saleLink} onChange={ev=>setSaleLink(ev.target.value)} placeholder="https://avito.ru/..."/></div>
        </div>
        <div className="fr" style={{marginBottom:0}}><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
          <textarea value={note} onChange={ev=>setNote(ev.target.value)} placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"/></div>
      </div>
      <div className="modal-footer">
        <button className="btn btn-g" onClick={close}>–û—Ç–º–µ–Ω–∞</button>
        <button className="btn btn-a" onClick={save}>–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>;
}

function ViewModal({data,lot,upd,openModal,close}){
  const sales=lotSales(data.sales,lot.id);
  const totalSold=lotSalesTotal(data.sales,lot.id);
  const totalPromoCost=sales.reduce((s,x)=>s+(x.promoCost||0),0);
  const profit=totalSold-(lot.cost||0)-totalPromoCost;
  const pct=lot.cost>0?Math.min(100,totalSold/lot.cost*100):0;
  const status=computeStatus(lot,data.sales);
  const sm=STATUS_META[status];
  
  return<div className="ov">
    <div className="modal" style={{maxWidth:'640px'}}>
      <div className="modal-hdr"><div className="modal-title">{lot.console} ¬∑ {lot.color}</div><button className="modal-x" onClick={close}>‚úï</button></div>
      <div className="modal-body">
        {/* –§–ò–ù–ê–ù–°–´ */}
        <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:'8px',marginBottom:'16px'}}>
          {[['–ó–∞–∫—É–ø–∫–∞',fmt(lot.cost),'var(--a2)'],['–ü—Ä–æ–¥–∞–Ω–æ',fmt(totalSold),'var(--a3)'],
            ['–ü—Ä–∏–±—ã–ª—å',(profit>=0?'+':'')+fmt(profit),profit>=0?'var(--accent)':'var(--red)'],
            ['–ú–∞—Ä–∂–∞',lot.cost>0?(profit/lot.cost*100).toFixed(1)+'%':'‚Äî',profit>=0?'var(--accent)':'var(--red)'],
          ].map(([l,v,c])=><div key={l} style={{background:'var(--surf2)',borderRadius:'8px',padding:'10px 12px'}}>
            <div style={{fontSize:'.65rem',color:'var(--t3)',textTransform:'uppercase',letterSpacing:'.7px',marginBottom:'4px',fontWeight:700}}>{l}</div>
            <div style={{fontFamily:'var(--mono)',fontWeight:700,fontSize:'.95rem',color:c}}>{v}</div>
          </div>)}
        </div>
        
        {/* –°–¢–ê–¢–£–°–´ –ò –¢–ï–ì–ò */}
        <div style={{display:'flex',gap:'6px',flexWrap:'wrap',marginBottom:'16px'}}>
          <span className={`pill ${sm.cls}`}>{sm.label}</span>
          {lot.date&&<span className="td">{fmtD(lot.date)}</span>}
          {lot.condition&&<span className="tag tk">–°–æ—Å—Ç–æ—è–Ω–∏–µ {lot.condition}/10</span>}
          {lot.sourceType&&<span className="tag ts">{lot.sourceType}{lot.sourceAddr?': '+lot.sourceAddr:''}</span>}
        </div>
        
        {/* –ü–†–û–ì–†–ï–°–° –û–ö–£–ü–ê–ï–ú–û–°–¢–ò */}
        {pct>0&&<div style={{marginBottom:'16px'}}>
          <div style={{display:'flex',justifyContent:'space-between',marginBottom:'5px'}}>
            <span style={{fontSize:'.72rem',fontFamily:'var(--mono)',color:'var(--t3)',fontWeight:600}}>–û—Ç–±–∏—Ç–æ</span>
            <span style={{fontSize:'.72rem',fontFamily:'var(--mono)',color:pct>=100?'var(--accent)':'var(--warn)',fontWeight:700}}>{pct.toFixed(0)}%</span>
          </div>
          <div className="prog-track" style={{height:'5px'}}><div className={`prog-fill ${pct>=100?'done':''}`} style={{width:pct+'%'}}/></div>
        </div>}
        
        {/* –î–ï–¢–ê–õ–ò –ü–û–ö–£–ü–ö–ò */}
        <div style={{fontSize:'.7rem',fontWeight:700,textTransform:'uppercase',letterSpacing:'.8px',color:'var(--t3)',marginBottom:'8px'}}>üí∏ –î–µ—Ç–∞–ª–∏ –ø–æ–∫—É–ø–∫–∏</div>
        <div style={{background:'var(--surf2)',borderRadius:'10px',padding:'12px',marginBottom:'16px'}}>
          <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:'10px'}}>
            {[['–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞',lot.baseCost||lot.cost],['–ß–∏–ø',lot.costChip],['MicroSD',lot.costSD],['–ü–µ—Ä–µ—Ö–æ–¥–Ω–∏–∫–∏',lot.costAdapter],
              ['–°—Ç–µ–∫–ª–æ',lot.costGlass],['–ß–µ—Ö–æ–ª',lot.costCase],['–ë—Ä–∞–∫',lot.costDefect],['–î–æ—Å—Ç–∞–≤–∫–∞',lot.costDelivery],['–ü—Ä–æ—á–∏–µ',lot.costOther]
            ].filter(([_,v])=>v>0).map(([l,v])=><div key={l} style={{display:'flex',justifyContent:'space-between',padding:'6px 0',borderBottom:'1px solid var(--border)'}}>
              <span style={{fontSize:'.82rem',color:'var(--t2)'}}>{l}</span>
              <span style={{fontFamily:'var(--mono)',fontSize:'.82rem',color:'var(--text)',fontWeight:600}}>{fmt(v)}</span>
            </div>)}
          </div>
          {lot.sourceLink&&<div style={{marginTop:'10px',padding:'8px 10px',background:'var(--surf3)',borderRadius:'6px'}}>
            <div style={{fontSize:'.68rem',color:'var(--t3)',marginBottom:'4px',fontWeight:600}}>–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–≤—Ü–∞:</div>
            <a href={lot.sourceLink} target="_blank" style={{fontSize:'.8rem',color:'var(--a3)',wordBreak:'break-all'}}>{lot.sourceLink}</a>
          </div>}
        </div>
        
        {/* –ö–ê–†–¢–†–ò–î–ñ–ò */}
        {(lot.cartridges||[]).length>0&&<>
          <div style={{fontSize:'.7rem',fontWeight:700,textTransform:'uppercase',letterSpacing:'.8px',color:'var(--t3)',marginBottom:'8px'}}>üìº –ö–∞—Ä—Ç—Ä–∏–¥–∂–∏</div>
          <div style={{background:'var(--surf2)',borderRadius:'8px',padding:'4px 12px',marginBottom:'16px'}}>
            {lot.cartridges.map(c=>{
              const cs=data.sales.find(s=>s.lotId===lot.id&&s.cartridgeId===c.id);
              return<div key={c.id} style={{display:'flex',alignItems:'center',padding:'8px 0',borderBottom:'1px solid var(--border)'}}>
                <span style={{flex:1,fontSize:'.85rem',color:'var(--text)',fontWeight:500}}>{c.name}{c.inBox?' üì¶':''}</span>
                {cs?<span style={{fontFamily:'var(--mono)',fontSize:'.82rem',color:'var(--accent)',fontWeight:600}}>+{fmt(cs.amount)}</span>
                  :<span style={{fontSize:'.7rem',color:'var(--t3)',background:'var(--surf3)',padding:'3px 9px',borderRadius:'5px',fontWeight:600}}>–Ω–µ –ø—Ä–æ–¥–∞–Ω</span>}
              </div>;
            })}
          </div>
        </>}
        
        {/* –ü–†–û–î–ê–ñ–ò */}
        {sales.length>0&&<>
          <div style={{fontSize:'.7rem',fontWeight:700,textTransform:'uppercase',letterSpacing:'.8px',color:'var(--t3)',marginBottom:'8px'}}>üí∞ –ü—Ä–æ–¥–∞–∂–∏ ({sales.length})</div>
          <div style={{background:'var(--surf2)',borderRadius:'10px',padding:'8px 12px',marginBottom:'16px'}}>
            {sales.map(s=><div key={s.id} style={{padding:'10px 0',borderBottom:'1px solid var(--border)'}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'6px'}}>
                <div style={{fontSize:'.88rem',color:'var(--text)',fontWeight:600}}>{s.item}</div>
                <div style={{fontFamily:'var(--mono)',fontSize:'.95rem',color:'var(--accent)',fontWeight:700}}>+{fmt(s.amount)}</div>
              </div>
              <div style={{display:'flex',flexWrap:'wrap',gap:'6px',fontSize:'.75rem',color:'var(--t2)'}}>
                <span>üìÖ {fmtD(s.date)}</span>
                {s.platform&&<span>‚Ä¢ {s.platform}</span>}
                {s.method&&<span>‚Ä¢ {s.method}</span>}
                {s.pay&&<span>‚Ä¢ {s.pay}</span>}
                {s.promoCost>0&&<span style={{color:'var(--warn)'}}>‚Ä¢ –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ: ‚àí{fmt(s.promoCost)}</span>}
              </div>
              {s.saleLink&&<div style={{marginTop:'6px',padding:'6px 8px',background:'var(--surf3)',borderRadius:'5px'}}>
                <a href={s.saleLink} target="_blank" style={{fontSize:'.75rem',color:'var(--a3)',wordBreak:'break-all'}}>üîó {s.saleLink}</a>
              </div>}
              {s.note&&<div style={{marginTop:'6px',fontSize:'.78rem',color:'var(--t3)',fontStyle:'italic'}}>üí¨ {s.note}</div>}
            </div>)}
          </div>
        </>}
        
        {/* –ó–ê–ú–ï–¢–ö–ò */}
        {lot.notes&&<div style={{background:'var(--surf2)',padding:'12px',borderRadius:'8px',fontSize:'.85rem',color:'var(--t2)',lineHeight:'1.6',fontStyle:'italic'}}>
          <div style={{fontSize:'.68rem',color:'var(--t3)',textTransform:'uppercase',letterSpacing:'.7px',marginBottom:'6px',fontWeight:700}}>üìù –ó–∞–º–µ—Ç–∫–∏</div>
          {lot.notes}
        </div>}
      </div>
      <div className="modal-footer">
        <button className="btn btn-g" onClick={close}>–ó–∞–∫—Ä—ã—Ç—å</button>
        <button className="btn btn-w btn-sm" onClick={()=>{close();openModal('sale',{lotId:lot.id});}}>+ –ü—Ä–æ–¥–∞–∂–∞</button>
        <button className="btn btn-a btn-sm" onClick={()=>{close();openModal('lot',{edit:lot});}}>‚úè –ò–∑–º–µ–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>;
}

function DelModal({upd,init,close}){
  const confirm=()=>{upd(d=>{d.lots=d.lots.filter(l=>l.id!==init.lotId);d.sales=d.sales.filter(s=>s.lotId!==init.lotId);return d;});close();};
  return<div className="ov">
    <div className="modal" style={{maxWidth:'360px'}}>
      <div className="modal-hdr"><div className="modal-title">–£–¥–∞–ª–∏—Ç—å –ª–æ—Ç?</div><button className="modal-x" onClick={close}>‚úï</button></div>
      <div className="modal-body"><p style={{color:'var(--t2)',fontSize:'.88rem',lineHeight:'1.55'}}><strong style={{color:'var(--text)'}}>{init.name}</strong> –∏ –≤—Å–µ –ø—Ä–æ–¥–∞–∂–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –Ω–∞–≤—Å–µ–≥–¥–∞.</p></div>
      <div className="modal-footer"><button className="btn btn-g" onClick={close}>–û—Ç–º–µ–Ω–∞</button><button className="btn btn-d" onClick={confirm}>–£–¥–∞–ª–∏—Ç—å</button></div>
    </div>
  </div>;
}

// ========================================
// –ú–û–î–£–õ–¨ –†–ï–ú–û–ù–¢–ê
// ========================================

function OrdersTab({data,upd,openModal,fMonth,setFMonth,fService,setFService,fStatus,setFStatus,sortBy,setSortBy}){
  const months=useMemo(()=>[...new Set((data.repairs||[]).map(r=>mKey(r.date)).filter(Boolean))].sort().reverse(),[data.repairs]);
  
  let orders=[...(data.repairs||[])];
  if(fStatus)orders=orders.filter(o=>o.status===fStatus);
  if(fService)orders=orders.filter(o=>o.service===fService);
  if(fMonth)orders=orders.filter(o=>mKey(o.date)===fMonth);
  orders.sort((a,b)=>sortBy==='date'?new Date(b.date)-new Date(a.date):new Date(b.createdAt)-new Date(a.createdAt));
  
  const completeOrder=id=>upd(d=>{const r=d.repairs.find(x=>x.id===id);if(r)r.status='completed';return d;});
  const markPaid=id=>upd(d=>{const r=d.repairs.find(x=>x.id===id);if(r)r.status='paid';return d;});
  
  return<>
    <div className="sec-hdr">
      <span className="sec-title">–ó–∞–∫–∞–∑—ã</span>
      <div className="filter-row">
        <select className="sel-sm" value={fMonth} onChange={e=>setFMonth(e.target.value)}>
          <option value="">–í—Å–µ –º–µ—Å—è—Ü—ã</option>
          {months.map(m=>{const[y,mo]=m.split('-');return<option key={m} value={m}>{MONTHS_FULL[parseInt(mo)-1]} {y}</option>;})}
        </select>
        <select className="sel-sm" value={fService} onChange={e=>setFService(e.target.value)}>
          <option value="">–í—Å–µ —É—Å–ª—É–≥–∏</option>
          {REPAIR_SERVICES.map(s=><option key={s}>{s}</option>)}
        </select>
        <select className="sel-sm" value={fStatus} onChange={e=>setFStatus(e.target.value)}>
          <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
          {Object.entries(REPAIR_STATUS).map(([k,v])=><option key={k} value={k}>{v.label}</option>)}
        </select>
        <select className="sel-sm" value={sortBy} onChange={e=>setSortBy(e.target.value)}>
          <option value="date">–ü–æ –¥–∞—Ç–µ</option>
          <option value="added">–ü–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é</option>
        </select>
        <span className="sec-cnt">{orders.length}</span>
      </div>
    </div>
    {!orders.length?<div className="empty"><div className="empty-icon">üîß</div><div className="empty-txt">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div></div>
      :orders.map(order=><OrderCard key={order.id} order={order} upd={upd} openModal={openModal} completeOrder={completeOrder} markPaid={markPaid}/>)}
  </>;
}

function OrderCard({order,upd,openModal,completeOrder,markPaid}){
  const[expanded,setExpanded]=React.useState(false);
  const sm=REPAIR_STATUS[order.status];
  const totalIncome=(order.income||0)+(order.additionalIncome||0);
  const netProfit=totalIncome-(order.expenses||0)-(order.deductions||0)-(order.adCost||0);
  const pnlCls=netProfit>0?'pos':netProfit<0?'neg':'zero';
  const days=daysOnHand(order.dateReceived);
  
  return<div className="lot-card">
    <div className="lot-head" onClick={()=>setExpanded(e=>!e)} style={{cursor:'pointer'}}>
      <div className="lot-info">
        <div className="lot-name">{order.service} ‚Ä¢ {order.console}</div>
        <div className="lot-sub">
          <span className="td">{fmtD(order.dateReceived)}</span>
          {order.urgent&&<span className="tag" style={{background:'rgba(255,79,110,.12)',color:'var(--red)',fontWeight:700}}>‚ö° –°—Ä–æ—á–Ω–æ</span>}
          {order.clientName&&<span className="tag ts">üë§ {order.clientName}</span>}
          {order.clientSource&&<span className="tag" style={{background:'rgba(79,184,255,.1)',color:'var(--a3)'}}>üìç {order.clientSource}</span>}
          {order.status!=='paid'&&<span className="tag" style={{background:`${days<=1?'var(--accent)':days<=3?'var(--warn)':'var(--red)'}15`,color:days<=1?'var(--accent)':days<=3?'var(--warn)':'var(--red)',fontWeight:700}}>‚è± {days} {days===1?'–¥–µ–Ω—å':days<5?'–¥–Ω—è':'–¥–Ω–µ–π'}</span>}
        </div>
      </div>
      <div className="lot-right">
        <div style={{display:'grid',gridTemplateColumns:order.additionalIncome>0?'auto auto auto auto':'auto auto auto',gap:'10px',alignItems:'center'}}>
          <div style={{textAlign:'right'}}>
            <div style={{fontSize:'.65rem',color:'var(--t3)',marginBottom:'3px',textTransform:'uppercase',letterSpacing:'.5px',fontWeight:600}}>–î–æ—Ö–æ–¥</div>
            <div style={{fontFamily:'var(--mono)',fontSize:'.88rem',fontWeight:700,color:'var(--a3)'}}>{fmt(order.income)}</div>
          </div>
          {order.additionalIncome>0&&<div style={{textAlign:'right'}}>
            <div style={{fontSize:'.65rem',color:'var(--t3)',marginBottom:'3px',textTransform:'uppercase',letterSpacing:'.5px',fontWeight:600}}>–î–æ–ø.</div>
            <div style={{fontFamily:'var(--mono)',fontSize:'.88rem',fontWeight:700,color:'var(--a3)'}}>+{fmt(order.additionalIncome)}</div>
          </div>}
          {order.expenses>0&&<div style={{textAlign:'right'}}>
            <div style={{fontSize:'.65rem',color:'var(--t3)',marginBottom:'3px',textTransform:'uppercase',letterSpacing:'.5px',fontWeight:600}}>–ó–∞—Ç—Ä–∞—Ç—ã</div>
            <div style={{fontFamily:'var(--mono)',fontSize:'.88rem',fontWeight:700,color:'var(--a2)'}}>{fmt(order.expenses)}</div>
          </div>}
          <div style={{textAlign:'right'}}>
            <div style={{fontSize:'.65rem',color:'var(--t3)',marginBottom:'3px',textTransform:'uppercase',letterSpacing:'.5px',fontWeight:600}}>–ß–∏—Å—Ç–∞—è</div>
            <div style={{fontFamily:'var(--mono)',fontSize:'.88rem',fontWeight:700,color:'var(--accent)'}}>{(netProfit>0?'+':'')+fmt(netProfit)}</div>
          </div>
        </div>
        <div className={`pill ${sm.cls}`} style={{marginLeft:'12px'}}>{sm.icon} {sm.label}</div>
        <div className={`chev ${expanded?'open':''}`} style={{marginLeft:'6px'}}>‚ñæ</div>
      </div>
    </div>
    
    {/* –†–ê–°–ö–†–´–¢–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø */}
    {expanded&&<div style={{padding:'14px 16px',borderTop:'1px solid var(--border)',background:'var(--surf2)'}}>
      <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:'12px',marginBottom:'14px'}}>
        {order.serialNumber&&<div><span style={{fontSize:'.7rem',color:'var(--t3)',fontWeight:600}}>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä:</span><div style={{fontSize:'.88rem',color:'var(--text)',fontFamily:'var(--mono)',marginTop:'3px'}}>{order.serialNumber}</div></div>}
        {order.clientPhone&&<div><span style={{fontSize:'.7rem',color:'var(--t3)',fontWeight:600}}>–¢–µ–ª–µ—Ñ–æ–Ω:</span><div style={{marginTop:'3px'}}><a href={`tel:${order.clientPhone}`} style={{fontSize:'.88rem',color:'var(--a3)'}}>{order.clientPhone}</a></div></div>}
        {order.dateDeadline&&<div><span style={{fontSize:'.7rem',color:'var(--t3)',fontWeight:600}}>–°–¥–∞—Ç—å –¥–æ:</span><div style={{fontSize:'.88rem',color:'var(--text)',marginTop:'3px'}}>{fmtD(order.dateDeadline)}</div></div>}
        {order.paymentMethod&&<div><span style={{fontSize:'.7rem',color:'var(--t3)',fontWeight:600}}>–û–ø–ª–∞—Ç–∞:</span><div style={{fontSize:'.88rem',color:'var(--text)',marginTop:'3px'}}>{order.paymentMethod}{order.deductions>0?` (‚àí${fmt(order.deductions)} –æ—Ç—á.)`:''}</div></div>}
        {order.additionalIncome>0&&<div><span style={{fontSize:'.7rem',color:'var(--t3)',fontWeight:600}}>–î–æ–ø. –¥–æ—Ö–æ–¥:</span><div style={{fontSize:'.88rem',color:'var(--accent)',marginTop:'3px'}}>+{fmt(order.additionalIncome)}{order.additionalIncomeNote?' ‚Äî '+order.additionalIncomeNote:''}</div></div>}
        {order.adCost>0&&<div><span style={{fontSize:'.7rem',color:'var(--t3)',fontWeight:600}}>–†–µ–∫–ª–∞–º–∞:</span><div style={{fontSize:'.88rem',color:'var(--warn)',marginTop:'3px'}}>‚àí{fmt(order.adCost)}</div></div>}
      </div>
      {order.clientLink&&<div style={{marginBottom:'12px',padding:'8px 10px',background:'var(--surf3)',borderRadius:'6px'}}>
        <span style={{fontSize:'.7rem',color:'var(--t3)',fontWeight:600}}>–°—Å—ã–ª–∫–∞ –Ω–∞ –¥–∏–∞–ª–æ–≥: </span>
        <a href={order.clientLink} target="_blank" style={{fontSize:'.82rem',color:'var(--a3)',wordBreak:'break-all'}}>{order.clientLink}</a>
      </div>}
      {order.notes&&<div style={{marginBottom:'12px',fontSize:'.85rem',color:'var(--t2)',fontStyle:'italic'}}>üí¨ {order.notes}</div>}
      <div style={{display:'flex',gap:'8px',flexWrap:'wrap'}}>
        {order.status==='in_progress'&&<button className="btn btn-a btn-sm" onClick={e=>{e.stopPropagation();completeOrder(order.id);}}>‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>}
        {order.status==='completed'&&<button className="btn btn-a btn-sm" onClick={e=>{e.stopPropagation();markPaid(order.id);}}>üí∞ –û–ø–ª–∞—á–µ–Ω–æ</button>}
        <button className="btn btn-g btn-sm" onClick={e=>{e.stopPropagation();openModal('repair',{edit:order});}}>‚úè –ò–∑–º–µ–Ω–∏—Ç—å</button>
        {order.clientPhone&&<a href={`tel:${order.clientPhone}`} className="btn btn-g btn-sm" style={{textDecoration:'none'}} onClick={e=>e.stopPropagation()}>üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</a>}
      </div>
    </div>}
  </div>;
}

function RepairStatsTab({data,fMonth,setFMonth,fService,setFService}){
  const months=useMemo(()=>[...new Set((data.repairs||[]).map(r=>mKey(r.date)).filter(Boolean))].sort().reverse(),[data.repairs]);
  
  let repairs=[...(data.repairs||[])];
  if(fMonth)repairs=repairs.filter(r=>mKey(r.date)===fMonth);
  if(fService)repairs=repairs.filter(r=>r.service===fService);
  
  const totalIncome=repairs.reduce((s,r)=>s+(r.income||0)+(r.additionalIncome||0),0);
  const totalExpenses=repairs.reduce((s,r)=>s+(r.expenses||0),0);
  const totalDeductions=repairs.reduce((s,r)=>s+(r.deductions||0),0);
  const totalAdRevenue=repairs.reduce((s,r)=>s+(r.adCost||0),0);
  const netProfit=totalIncome-totalExpenses-totalDeductions-totalAdRevenue;
  const margin=totalIncome>0?(netProfit/totalIncome*100):0;
  const avgCheck=repairs.length>0?totalIncome/repairs.length:0;
  
  const byStatus={};
  Object.keys(REPAIR_STATUS).forEach(k=>byStatus[k]=0);
  repairs.forEach(r=>byStatus[r.status]=(byStatus[r.status]||0)+1);
  const byService={};
  REPAIR_SERVICES.forEach(s=>byService[s]=0);
  repairs.forEach(r=>byService[r.service]=(byService[r.service]||0)+1);
  const bySource={};
  repairs.forEach(r=>{if(r.clientSource)bySource[r.clientSource]=(bySource[r.clientSource]||0)+1;});
  
  return<>
    {/* –§–∏–ª—å—Ç—Ä—ã (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å –≤–∫–ª–∞–¥–∫–æ–π –ó–∞–∫–∞–∑—ã) */}
    <div style={{display:'flex',gap:'8px',marginBottom:'16px',flexWrap:'wrap'}}>
      <select className="sel-sm" value={fMonth} onChange={e=>setFMonth(e.target.value)}>
        <option value="">–í—Å–µ –º–µ—Å—è—Ü—ã</option>
        {months.map(m=>{const[y,mo]=m.split('-');return<option key={m} value={m}>{MONTHS_FULL[parseInt(mo)-1]} {y}</option>;})}
      </select>
      <select className="sel-sm" value={fService} onChange={e=>setFService(e.target.value)}>
        <option value="">–í—Å–µ —É—Å–ª—É–≥–∏</option>
        {REPAIR_SERVICES.map(s=><option key={s}>{s}</option>)}
      </select>
      <span style={{fontSize:'.78rem',color:'var(--t3)',alignSelf:'center',marginLeft:'4px'}}>
        {fMonth?MONTHS_FULL[parseInt(fMonth.split('-')[1])-1]+' '+fMonth.split('-')[0]:'–ó–∞ –≤—Å—ë –≤—Ä–µ–º—è'}{fService?' ¬∑ '+fService:''}
      </span>
    </div>

    {/* –¢–æ–ø 4 –∫–∞—Ä—Ç–æ—á–∫–∏ ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ */}
    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:'10px',marginBottom:'20px'}}>
      {[
        ['–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å',(netProfit>=0?'+':'')+fmt(netProfit),netProfit>=0?'var(--accent)':'var(--red)'],
        ['–ú–∞—Ä–∂–∞',margin.toFixed(1)+'%',margin>=0?'var(--accent)':'var(--red)'],
        ['–î–æ—Ö–æ–¥',fmt(totalIncome),'var(--a3)'],
        ['–ó–∞—Ç—Ä–∞—Ç—ã',fmt(totalExpenses+totalDeductions+totalAdRevenue),'var(--a2)'],
      ].map(([l,v,c])=><div key={l} style={{background:'var(--surf)',border:'1px solid var(--border)',borderRadius:'var(--r2)',padding:'14px 16px'}}>
        <div style={{fontSize:'.7rem',color:'var(--t3)',textTransform:'uppercase',letterSpacing:'.8px',fontWeight:700,marginBottom:'7px'}}>{l}</div>
        <div style={{fontFamily:'var(--mono)',fontSize:'1.3rem',fontWeight:700,color:c}}>{v}</div>
      </div>)}
    </div>
    
    <div className="stat-grid">
      <div className="stat-blk">
        <div className="stat-blk-title">üìä –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã</div>
        {[['–ó–∞–∫–∞–∑–æ–≤',repairs.length,'var(--text)'],
          ['–°—Ä–µ–¥–Ω–∏–π —á–µ–∫',fmt(avgCheck),'var(--a3)'],
          ['–ó–∞—Ç—Ä–∞—Ç—ã –Ω–∞ –∑–∞–ø—á–∞—Å—Ç–∏',fmt(totalExpenses),'var(--warn)'],
          ['–û—Ç—á–∏—Å–ª–µ–Ω–∏—è (–∫–∞—Ä—Ç–∞)',fmt(totalDeductions),'var(--warn)'],
          ...(totalAdRevenue>0?[['–†–µ–∫–ª–∞–º–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π',fmt(totalAdRevenue),'var(--warn)']]:[ ]),
        ].map(([l,v,c])=><div key={l} className="stat-line"><span className="stat-ln-lbl">{l}</span><span className="stat-ln-val" style={{color:c}}>{v}</span></div>)}
      </div>
      <div className="stat-blk">
        <div className="stat-blk-title">üîß –ü–æ —Å—Ç–∞—Ç—É—Å–∞–º</div>
        {Object.entries(REPAIR_STATUS).map(([k,v])=><div key={k} className="stat-line">
          <span className="stat-ln-lbl">{v.icon} {v.label}</span>
          <span className="stat-ln-val">{byStatus[k]||0}</span>
        </div>)}
        {Object.keys(bySource).length>0&&<>
          <div className="stat-blk-title" style={{marginTop:'12px'}}>üìç –ò—Å—Ç–æ—á–Ω–∏–∫–∏</div>
          {Object.entries(bySource).map(([src,cnt])=><div key={src} className="stat-line">
            <span className="stat-ln-lbl">{src}</span>
            <span className="stat-ln-val">{cnt}</span>
          </div>)}
        </>}
      </div>
    </div>
    
    {Object.values(byService).some(v=>v>0)&&<div className="stat-blk" style={{marginTop:'14px'}}>
      <div className="stat-blk-title">üíº –ü–æ —É—Å–ª—É–≥–∞–º</div>
      {Object.entries(byService).filter(([_,c])=>c>0).map(([s,c])=><div key={s} className="stat-line">
        <span className="stat-ln-lbl">{s}</span>
        <span className="stat-ln-val">{c}</span>
      </div>)}
    </div>}
  </>;
}

function RepairModal({data,upd,init,close}){
  const e=init.edit||null;
  const[service,setService]=React.useState(e?.service||REPAIR_SERVICES[0]);
  const[cn,setCn]=React.useState(e?.console||CONSOLES[0]);
  const[cnCustom,setCnCustom]=React.useState('');
  const[sn,setSn]=React.useState(e?.serialNumber||'');
  const[income,setIncome]=React.useState(e?.income||'');
  const[expenses,setExpenses]=React.useState(e?.expenses||'');
  const[addIncome,setAddIncome]=React.useState(e?.additionalIncome||'');
  const[addIncomeNote,setAddIncomeNote]=React.useState(e?.additionalIncomeNote||'');
  const[urgent,setUrgent]=React.useState(e?.urgent||false);
  const[status,setStatus]=React.useState(e?.status||'pending');
  const[clientName,setClientName]=React.useState(e?.clientName||'');
  const[clientPhone,setClientPhone]=React.useState(e?.clientPhone||'');
  const[clientSource,setClientSource]=React.useState(e?.clientSource||CLIENT_SOURCES[0]);
  const[clientLink,setClientLink]=React.useState(e?.clientLink||'');
  const[dateReceived,setDateReceived]=React.useState(e?.dateReceived||todayStr());
  const[dateDeadline,setDateDeadline]=React.useState(e?.dateDeadline||todayStr());
  const[payMethod,setPayMethod]=React.useState(e?.paymentMethod||'–ù–∞–ª–∏—á–Ω—ã–µ');
  const[deductions,setDeductions]=React.useState(e?.deductions?.toString()||'');
  const[adCost,setAdCost]=React.useState(e?.adCost?.toString()||'');
  const[notes,setNotes]=React.useState(e?.notes||'');
  
  // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç—á–∏—Å–ª–µ–Ω–∏–π 4% –¥–ª—è –∫–∞—Ä—Ç—ã
  React.useEffect(()=>{
    if(payMethod==='–ö–∞—Ä—Ç–∞'&&income){
      const totalIncome=(parseFloat(income)||0)+(parseFloat(addIncome)||0);
      setDeductions((totalIncome*0.04).toFixed(0));
    }else if(payMethod!=='–ö–∞—Ä—Ç–∞'){
      setDeductions('0');
    }
  },[payMethod,income,addIncome]);
  
  const save=()=>{
    const finalCn=cn==='–î—Ä—É–≥–∞—è –∫–æ–Ω—Å–æ–ª—å'?cnCustom:cn;
    if(!finalCn.trim()||!income)return;
    const repairData={
      service,console:finalCn,serialNumber:sn,
      income:parseFloat(income),expenses:parseFloat(expenses)||0,
      additionalIncome:parseFloat(addIncome)||0,additionalIncomeNote:addIncomeNote,
      adCost:parseFloat(adCost)||0,
      urgent,status,clientName,clientPhone,clientSource,clientLink,
      dateReceived,dateDeadline,
      paymentMethod:payMethod,deductions:parseFloat(deductions)||0,notes,
      date:dateReceived,createdAt:e?.createdAt||new Date().toISOString()
    };
    if(e){
      upd(d=>{const r=d.repairs.find(x=>x.id===e.id);if(r)Object.assign(r,repairData);return d;});
    }else{
      upd(d=>{if(!d.repairs)d.repairs=[];d.repairs.push({id:uid(),...repairData});return d;});
    }
    close();
  };
  
  return<div className="ov">
    <div className="modal" style={{maxWidth:'640px'}}>
      <div className="modal-hdr"><div className="modal-title">{e?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑':'–ù–æ–≤—ã–π –∑–∞–∫–∞–∑'}</div><button className="modal-x" onClick={close}>‚úï</button></div>
      <div className="modal-body">
        <div className="fr-2">
          <div className="fr"><label>–£—Å–ª—É–≥–∞</label>
            <select value={service} onChange={ev=>setService(ev.target.value)}>{REPAIR_SERVICES.map(s=><option key={s}>{s}</option>)}</select></div>
          <div className="fr"><label>–ö–æ–Ω—Å–æ–ª—å</label>
            <select value={cn} onChange={ev=>setCn(ev.target.value)}>{CONSOLES.map(c=><option key={c}>{c}</option>)}</select></div>
        </div>
        {cn==='–î—Ä—É–≥–∞—è –∫–æ–Ω—Å–æ–ª—å'&&<div className="fr"><label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω—Å–æ–ª–∏</label><input value={cnCustom} onChange={ev=>setCnCustom(ev.target.value)} placeholder="Steam Deck, PS5..."/></div>}
        <div className="fr"><label>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</label><input value={sn} onChange={ev=>setSn(ev.target.value)} placeholder="XAW70123456"/></div>
        <div className="fr-3">
          <div className="fr"><label>–î–æ—Ö–æ–¥ ‚ÇΩ</label><input type="number" value={income} onChange={ev=>setIncome(ev.target.value)} placeholder="4000"/></div>
          <div className="fr"><label>–ó–∞—Ç—Ä–∞—Ç—ã ‚ÇΩ</label><input type="number" value={expenses} onChange={ev=>setExpenses(ev.target.value)} placeholder="500"/></div>
          <div className="fr"><label>–î–æ–ø. –¥–æ—Ö–æ–¥ ‚ÇΩ</label><input type="number" value={addIncome} onChange={ev=>setAddIncome(ev.target.value)} placeholder="0"/></div>
        </div>
        {addIncome>0&&<div className="fr"><label>–ó–∞ —á—Ç–æ –¥–æ–ø. –¥–æ—Ö–æ–¥?</label><input value={addIncomeNote} onChange={ev=>setAddIncomeNote(ev.target.value)} placeholder="–î–æ—Å—Ç–∞–≤–∫–∞, —Å—Ä–æ—á–Ω–æ—Å—Ç—å..."/></div>}
        <div className="fr-2">
          <div className="fr"><label>–ö–ª–∏–µ–Ω—Ç</label><input value={clientName} onChange={ev=>setClientName(ev.target.value)} placeholder="–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤"/></div>
          <div className="fr"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input value={clientPhone} onChange={ev=>setClientPhone(ev.target.value)} placeholder="+7 999 123-45-67"/></div>
        </div>
        <div className="fr-2">
          <div className="fr"><label>–ò—Å—Ç–æ—á–Ω–∏–∫ –∫–ª–∏–µ–Ω—Ç–∞</label>
            <select value={clientSource} onChange={ev=>setClientSource(ev.target.value)}>{CLIENT_SOURCES.map(s=><option key={s}>{s}</option>)}</select></div>
          <div className="fr"><label>–°—Å—ã–ª–∫–∞ –Ω–∞ –¥–∏–∞–ª–æ–≥</label><input value={clientLink} onChange={ev=>setClientLink(ev.target.value)} placeholder="https://avito.ru/–¥–∏–∞–ª–æ–≥..."/></div>
        </div>
        <div className="fr-3">
          <div className="fr"><label>–ü—Ä–∏–Ω—è—Ç–æ</label><input type="date" value={dateReceived} onChange={ev=>setDateReceived(ev.target.value)}/></div>
          <div className="fr"><label>–°–¥–∞—Ç—å –¥–æ</label><input type="date" value={dateDeadline} onChange={ev=>setDateDeadline(ev.target.value)}/></div>
          <div className="fr"><label>–°—Ç–∞—Ç—É—Å</label>
            <select value={status} onChange={ev=>setStatus(ev.target.value)}>
              {Object.entries(REPAIR_STATUS).map(([k,v])=><option key={k} value={k}>{v.label}</option>)}
            </select></div>
        </div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr auto',gap:'12px',alignItems:'end',marginBottom:'12px'}}>
          <div className="fr" style={{marginBottom:0}}><label>–û–ø–ª–∞—Ç–∞</label>
            <select value={payMethod} onChange={ev=>setPayMethod(ev.target.value)}>{PAYMENT_REPAIR.map(p=><option key={p}>{p}</option>)}</select></div>
          <div className="fr" style={{marginBottom:0}}><label>–û—Ç—á–∏—Å–ª–µ–Ω–∏—è ‚ÇΩ</label><input type="number" value={deductions} onChange={ev=>setDeductions(ev.target.value)} placeholder="0"/></div>
          <div className="fr" style={{marginBottom:0}}><label>–†–µ–∫–ª–∞–º–∞ ‚ÇΩ</label><input type="number" value={adCost} onChange={ev=>setAdCost(ev.target.value)} placeholder="0"/></div>
          <label className="check-row" style={{paddingBottom:'8px'}}><input type="checkbox" checked={urgent} onChange={ev=>setUrgent(ev.target.checked)}/><span>‚ö° –°—Ä–æ—á–Ω–æ</span></label>
        </div>
        <div className="fr" style={{marginBottom:0}}><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
          <textarea value={notes} onChange={ev=>setNotes(ev.target.value)} placeholder="–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏, —Å–æ—Å—Ç–æ—è–Ω–∏–µ..."/></div>
      </div>
      <div className="modal-footer">
        <button className="btn btn-g" onClick={close}>–û—Ç–º–µ–Ω–∞</button>
        <button className="btn btn-a" onClick={save}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>;
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
